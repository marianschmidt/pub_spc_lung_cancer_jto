---
title: SPC - Data Analysis - Lung Cancer Germany - Publication 'Incidence of Smoking-related
  Second Primary Cancers after Lung Cancer in Germany'
author: "Marian Eberl (TUM)"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
always_allow_html: true
---

```{r info, include=FALSE, warning=TRUE}
# project:      SPN - Data Analysis  
# script:       01.an_analyses.spc.lung.Rmd  
# author:       Marian Eberl  
# recent date:  2021-10-06  
# versions:     2020-09-18 first version  
#               2021-06-28 rename for public repo
#               2021-10-06 add notes to SIR lung cancer; add additional analyses required by reviewers
# req packages: tidyverse, msSPChelpR, knitr
# content:		  R Markdown Notebook to conduct analysis on SPC after lung cancer for publication 1
# used in:  
# depending on:  
# comments:  
# execution time:  ~ 25 minutes
# quality check: (version 2017-07-28, YYYY-MM-DD, Name Programmer)  
```

#Set document paramenters

```{r setup, include=FALSE, warning=TRUE}

#----- Set basic parameters

##---- Files
analysis_file_long     <- "../1_input/73.zfkdspn.dataset.fc.lungcancer.RData"
analysis_file_wide     <- "../1_input/73.zfkdspn.dataset.fc.lungcancer.wide.RData"
rates_file             <- "../1_input/51.crude.rates.germany.RData"
rates_dco_file         <- "../1_input/54.crude.rates.dco.germany.RData"
population_file        <- "../1_input/52.population.germany.RData"
standard_file          <- "../1_input/53.standard.populations.RData"
map_ger_file1        <- "../1_input/maps/gadm36_DEU_1_sf.rds" #source: https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_1_sf.rds
map_ger_file2        <- "../1_input/maps/gadm36_DEU_2_sf.rds" #source: https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_2_sf.rds

output_dir_tables      <- "../3_output/all_figs_tabs"

helper_functions_file  <- "01.x2.fn_analysis.helper.functions.R"
impute_script_file     <- "01.x1.cr_impute.missing.rates.R"

save_workspace         <- TRUE
output_workspace       <- "../3_output/01.an_workspace.RData"

##---- Packages
load_packages          <- c("tidyverse", "msSPChelpR", "gt", "ggplot2",
                            "patchwork") 
add_required_packages  <- c("lubridate", "tidylog", "knitr",
                            "testthat", "sf", "webshot")
#in case you have used renv::init(), you usually need to renv::install(c("tidyverse", "patchwork", "sf", "webshot"))

### Check if required packages are installed
if(any(lapply(c(load_packages, add_required_packages), requireNamespace) == FALSE)){
  stop(paste0("Required packages are missing. Please install all packages: ", 
              paste0(load_packages, collapse = ", "),
              paste0(add_required_packages, collapse = ", ")))
}

### Load packages
lapply(load_packages, library, character.only = TRUE)

### Load helper functions
source(helper_functions_file, encoding = "UTF-8")


##---- Options
### Set global options
options(nwarnings = 10000)
invisible(utils::memory.limit(32000))
testthat::local_edition(3)

### Other parameters
en_gb <- FALSE        #if true, use British English where applicable
ref_barclay <- "6"   #number of reference for Barclay 2019
ref_boakye  <- "7"   #number of reference for Boakye 2019
ref_iarc    <- "18"   #number of reference for Secretan 2004
ref_thakur  <- "20"   #number of reference for Thakur 2018

### Set-up global knitr options
knitr::opts_chunk$set(
  #size of figures
  #fig.width = 800,
  #remove code from final doc
  echo = FALSE)

```

### color palettes

```{r}
colors_2_sex <- c("Male" = "turquoise",
                  "Female" = "orangered")

colors_6_sexdco <- c("Female odco_eno" = "orangered",
            "Male odco_eno" = "turquoise",
            "Female ono_eno" = "orangered2",
            "Male ono_eno"  = "turquoise2",
            "Female odco_edco" = "orangered4",
            "Male odco_edco"  = "turquoise4")

colors_2_site <- c("other cancer" = "dodgerblue",
                  "smoking-related IARC" = "orange")

colors_6_sitedco <- c("other cancer odco_eno" = "dodgerblue",
                      "smoking-related IARC odco_eno" = "orange",
                      "other cancer ono_eno" = "dodgerblue2",
                      "smoking-related IARC ono_eno"  = "orange2",
                      "other cancer odco_edco" = "dodgerblue4",
                      "smoking-related IARC odco_edco"  = "orange4")

colors_15_sitedef <- c("smo_iarc" = "orange",
                      "smo_boak" = "orange2",
                      "smo_barc" = "orange4",
                      "oth_iarc" = "dodgerblue",
                      "oth_boak" = "dodgerblue2",
                      "oth_barc" = "dodgerblue4",
                      "smor_iarc_t" = "grey80",
                      "smor_boak_t" = "grey50",
                      "smor_barc_t" = "grey30",
                      "smor_iarc_m" = "turquoise",
                      "smor_boak_m" = "turquoise2",
                      "smor_barc_m" = "turquoise4",
                      "smor_iarc_f" = "orangered",
                      "smor_boak_f" = "orangered2",
                      "smor_barc_f" = "orangered4")

  
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

# Prepare Datasets

The used data set has is based on the ZfKD-Data-set Version 2018-08-24 incl. missing cases (4,736,067 patients with a total of 5,407,569 registered tumors) and has been pre-filtered according to the following criteria:
 
 - patients with a first cancer diagnosis of lung cancer defined as:
   - `ICD10GM` starts with `C33` or `C34` AND
   - `t_tumid == 1` (Tumor ID created with `msSPChelpR::renumber_time_id_tt()` function and defined as chronologically sorting of all registered cases per patient ID by date of diagnosis, ignoring D diagnoses [in situ, benign and unknown behavior diagnoses] and C44 diagnoses [non-malignant melanoma])
 - no further restrictions on age, registry, site, histology or data quality

It was created using the files:  

 - `73.01.cr_prefilter.fc.lung.zfkd.R` (last modified `r file.info("73.01.cr_prefilter.fc.lung.zfkd.R")$mtime`)
 - `73.02.cr_dm.save.fc.lung.zfkd.R` (last modified `r file.info("73.02.cr_dm.save.fc.lung.zfkd.R")$mtime`)

The used analysis files are:

 - `r analysis_file_long` (last modified `r file.info(analysis_file_long)$mtime`)
 - `r analysis_file_wide` (last modified `r file.info(analysis_file_wide)$mtime`)


```{r}

#----- Load analysis data
load(file=analysis_file_long)
load(file=analysis_file_wide)
load(file=rates_file)
load(file=rates_dco_file)
load(file=population_file)
load(file=standard_file)
map_ger_sf1 <- readRDS(file=map_ger_file1)
map_ger_sf2 <- readRDS(file=map_ger_file2)

nrow_wide_zdata_fc_lung <- nrow(wide_zdata_fc_lung)
nrow_zdata_fclung <- nrow(zdata_fc_lung)

```

The unfiltered data set contains `r nrow_wide_zdata_fc_lung` patients with any lung cancer (C33-C34) and a total of `r nrow_zdata_fclung` registered tumors.

The used file for data analysis (this document) is:

 - `x3.08.an_lung.publication1.Rmd` (last modified `r file.info("x3.08.an_lung.publication1.Rmd")$mtime`)


## Impute missing rates for DE2 and DE9 in rates

The analysis uses all cases diagnosed in the period 2002 to 2013 in 11 German regions (BY, BB, HB, HH, MV, NI, MÜN, SL, SN , SH, TH). 
However, reference rates are not available for all of these time periods. Therefore the following imputations are made:

 * reference rates without DCO:
   * DE2 Bavaria, 2000 - 2004 \rightarrow fill up empty years with average available rates for the period 2005 - 2009 for the same region
   * DE9 Lower Saxony, 2000 - 2004 \rightarrow fill up empty years with average available rates for the period 2005 - 2009 for the same region

 * reference rates including DCO:
   * DE2 Bavaria, 2000 - 2004 \rightarrow fill up empty years with average available rates for the period 2005 - 2009 for the same region
   * DE9 Lower Saxony, 2000 - 2004 \rightarrow fill up empty years with average available rates for the period 2005 - 2009 for the same region

```{r impute_missing_rates}
source(impute_script_file, local = knitr::knit_global(), encoding = "UTF-8")

```


## Prepare main dataset

### Remove columns not needed

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  #remove columns that will be recalculated
  dplyr::select(!(starts_with("p_spc") | starts_with("t_srvtime") | starts_with("p_status"))) %>%
  #remove columns for tumor ID > 2
  dplyr::select(!(ends_with(".3") | ends_with(".4") | ends_with(".5") | ends_with(".6")))

```


### p_spc - Determine if second cancer did occur

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  dplyr::mutate(p_spc = case_when(is.na(t_icdcat.2)   ~ "No SPC",
                         !is.na(t_icdcat.2)           ~ "SPC developed",
                         TRUE ~ NA_character_),
                p_spc_bin = case_when(is.na(t_icdcat.2)   ~ 0,
                                      !is.na(t_icdcat.2)  ~ 1,
                         TRUE ~ NA_real_))
  

```

### p_status - Determine patient status at end of FU end of 2014

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  msSPChelpR::pat_status_tt(., fu_end = "2014-12-15", dattype = "zfkd",
                         status_var = "p_status", 
                         use_lifedatmin = FALSE, check = TRUE, 
                         as_labelled_factor = FALSE)

```

### t_icdgroup_s.2 - group SPCs into categories where smoking-related cancers are separated

```{r}
  icdgroup_c15_code    <- if(en_gb){"Oesophagus (C15)"}else{"Esophagus (C15)"}
  icdgroup_c9195_code  <- if(en_gb){"Leukaemias (C91-C95)"}else{"Leukemias (C91-C95)"}
  icdgroup_c9195s_code <- if(en_gb){"Non-Myeloid Leukaemias (C91, C93-C95)"}else{"Non-Myeloid Leukemias (C91, C93-C95)"}
  icdgroup_c92_code    <- if(en_gb){"Myeloid leukaemia (C92)"}else{"Myeloid leukemia (C92)"}
  icdgroup_c96_code    <- if(en_gb){"Other lymphoid, haematopoietic tissue (C96)"}else{"Other lymphoid, hematopoietic tissue (C96)"}
 
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
    dplyr::mutate(t_icdgroup_s.2 = recode_factor(t_icdcat.2,
                                               `C00`="Lip, oral cavity and pharynx (C00-C14)", 
                                               `C01`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C02`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C03`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C04`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C05`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C06`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C07`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C08`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C09`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C10`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C11`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C12`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C13`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C14`="Lip, oral cavity and pharynx (C00-C14)",
                                               `C15`=icdgroup_c15_code,                     
                                               `C16`="Stomach (C16)",
                                               `C17`="Small intestine (C17)",
                                               `C18`="Colorectum (C18-C20)",
                                               `C19`="Colorectum (C18-C20)",
                                               `C20`="Colorectum (C18-C20)",
                                               `C21`="Anus (C21)",
                                               `C22`="Liver (C22)",
                                               `C23`="Gallbladder (C23-C24)",
                                               `C24`="Gallbladder (C23-C24)",
                                               `C25`="Pancreas (C25)",
                                               `C26`="Other digestive organs (C26)",
                                               `C30`="Nasal cavity, middle ear (C30)",
                                               `C31`="Accessory sinuses (C31)",
                                               `C32`="Larynx (C32)",
                                               `C33`="Lung (C33-C34)",
                                               `C34`="Lung (C33-C34)",
                                               `C37`="Thymus (C37)",
                                               `C38`="Heart, mediastinum, pleura (C38)",
                                               `C39`="Other respiratory system, inthrathoracic organs (C39)",
                                               `C40`="Bone, articular cartilage (C40-C41)",
                                               `C41`="Bone, articular cartilage (C40-C41)",
                                               `C43`="Skin (C43)",
                                               `C44`="Non-melanoma skin (C44)",
                                               `C45`="Mesothelial, soft tissue (C45-C49)",
                                               `C46`="Mesothelial, soft tissue (C45-C49)",
                                               `C47`="Mesothelial, soft tissue (C45-C49)",
                                               `C48`="Mesothelial, soft tissue (C45-C49)",
                                               `C49`="Mesothelial, soft tissue (C45-C49)",
                                               `C50`="Breast (C50)",
                                               `C51`="Vulva (C51)",
                                               `C52`="Vagina (C52)",
                                               `C53`="Cervix (C53)",
                                               `C54`="Uterus (C54-C55)",
                                               `C55`="Uterus (C54-C55)",
                                               `C56`="Ovary (C56)",
                                               `C57`="Other female genital organs (C57)",
                                               `C58`="Placenta (C58)",
                                               `C60`="Penis (C60)",
                                               `C61`="Prostate (C61)",
                                               `C62`="Testis (C62)",
                                               `C63`="Other male genital organs (C63)",
                                               `C64`="Kidney (C64)",
                                               `C65`="Renal pelvis (C65)",
                                               `C66`="Ureter (C66)",
                                               `C67`="Urinary bladder (C67)",
                                               `C68`="Other and unspecified urinary organs (C68)",
                                               `C69`="Eye (C69)",
                                               `C70`="Brain, central nervous system (C70-C72)",
                                               `C71`="Brain, central nervous system (C70-C72)",
                                               `C72`="Brain, central nervous system (C70-C72)",
                                               `C73`="Thyroid, endocrine glands (C73-C75)",
                                               `C74`="Thyroid, endocrine glands (C73-C75)",
                                               `C75`="Thyroid, endocrine glands (C73-C75)",
                                               `C76`="Ill-defined sites (C76-C80)",
                                               `C77`="Ill-defined sites (C76-C80)",
                                               `C78`="Ill-defined sites (C76-C80)",
                                               `C79`="Ill-defined sites (C76-C80)",
                                               `C80`="Ill-defined sites (C76-C80)",
                                               `C81`="Hodgkin lymphoma (C81)",
                                               `C82`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C83`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C84`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C85`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C86`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C87`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C88`="Non-Hodgkin lymphoma (C82-C88)",
                                               `C90`="Multiple myeloma (C90)",
                                               `C91`=icdgroup_c9195s_code,
                                                 `C92`=icdgroup_c92_code,
                                                 `C93`=icdgroup_c9195s_code,
                                                 `C94`=icdgroup_c9195s_code,
                                                 `C95`=icdgroup_c9195s_code,
                                               `C96`=icdgroup_c96_code
    ))%>%
  sjlabelled::var_labels(t_icdgroup_s.2="Tumor group (ICD-10GM based grouping)") 

```

### t_icdgroup_pub.2 - group SPCs into categories used in publication

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
    dplyr::mutate(t_icdgroup_pub.2 = recode_factor(t_icdcat.2,
 `C00`="Lip (C00)",  
                                                    `C01`="Oral cavity (C01-C06)",
                                                    `C02`="Oral cavity (C01-C06)",
                                                    `C03`="Oral cavity (C01-C06)",
                                                    `C04`="Oral cavity (C01-C06)",
                                                    `C05`="Oral cavity (C01-C06)",
                                                    `C06`="Oral cavity (C01-C06)",
                                                    `C07`="Salivary glands (C07-C08)",
                                                    `C08`="Salivary glands (C07-C08)",
                                                    `C09`="Tonsil (C09)",
                                                    `C10`="Pharynx (C10-C14)",
                                                    `C11`="Pharynx (C10-C14)",
                                                    `C12`="Pharynx (C10-C14)",
                                                    `C13`="Pharynx (C10-C14)",
                                                    `C14`="Pharynx (C10-C14)",
                                                    `C15`=icdgroup_c15_code,                     
                                                    `C16`="Stomach (C16)",
                                                    `C17`="Small intestine (C17)",
                                                    `C18`="Colorectum (C18-C20)",
                                                    `C19`="Colorectum (C18-C20)",
                                                    `C20`="Colorectum (C18-C20)",
                                                    `C21`="Anus (C21)",
                                                    `C22`="Liver (C22)",
                                                    `C23`="Gallbladder (C23-C24)",
                                                    `C24`="Gallbladder (C23-C24)",
                                                    `C25`="Pancreas (C25)",
                                                    `C26`="Other digestive organs (C26)",
                                                    `C30`="Nasal cavity, middle ear, accessory sinuses (C30-C31)",
                                                    `C31`="Nasal cavity, middle ear, accessory sinuses (C30-C31)",
                                                    `C32`="Larynx (C32)",
                                                    `C33`="Lung (C33-C34)",
                                                    `C34`="Lung (C33-C34)",
                                                    `C37`="Thymus (C37)",
                                                    `C38`="Heart, mediastinum, pleura (C38)",
                                                    `C39`="Other respiratory system, inthrathoracic organs (C39)",
                                                    `C40`="Bone, articular cartilage (C40-C41)",
                                                    `C41`="Bone, articular cartilage (C40-C41)",
                                                    `C43`="Skin melanoma (C43)",
                                                    `C44`="Non-melanoma skin (C44)",
                                                    `C45`="Mesothelial, soft tissue (C45-C49)",
                                                    `C46`="Mesothelial, soft tissue (C45-C49)",
                                                    `C47`="Mesothelial, soft tissue (C45-C49)",
                                                    `C48`="Mesothelial, soft tissue (C45-C49)",
                                                    `C49`="Mesothelial, soft tissue (C45-C49)",
                                                    `C50`="Breast (C50)",
                                                    `C51`="Vulva (C51)",
                                                    `C52`="Vagina (C52)",
                                                    `C53`="Cervix (C53)",
                                                    `C54`="Uterus (C54-C55)",
                                                    `C55`="Uterus (C54-C55)",
                                                    `C56`="Ovary (C56)",
                                                    `C57`="Other female genital organs (C57)",
                                                    `C58`="Placenta (C58)",
                                                    `C60`="Penis (C60)",
                                                    `C61`="Prostate (C61)",
                                                    `C62`="Testis (C62)",
                                                    `C63`="Other male genital organs (C63)",
                                                    `C64`="Kidney (C64)",
                                                    `C65`="Urinary tract (C65-C68)",
                                                    `C66`="Urinary tract (C65-C68)",
                                                    `C67`="Urinary tract (C65-C68)",
                                                    `C68`="Urinary tract (C65-C68)",
                                                    `C69`="Eye (C69)",
                                                    `C70`="Brain, central nervous system (C70-C72)",
                                                    `C71`="Brain, central nervous system (C70-C72)",
                                                    `C72`="Brain, central nervous system (C70-C72)",
                                                    `C73`="Thyroid, endocrine glands (C73-C75)",
                                                    `C74`="Thyroid, endocrine glands (C73-C75)",
                                                    `C75`="Thyroid, endocrine glands (C73-C75)",
                                                    `C76`="Ill-defined sites (C76-C80)",
                                                    `C77`="Ill-defined sites (C76-C80)",
                                                    `C78`="Ill-defined sites (C76-C80)",
                                                    `C79`="Ill-defined sites (C76-C80)",
                                                    `C80`="Ill-defined sites (C76-C80)",
                                                    `C81`="Hodgkin lymphoma (C81)",
                                                    `C82`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C83`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C84`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C85`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C86`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C87`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C88`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C90`="Multiple myeloma (C90)",
                                                    `C91`=icdgroup_c9195s_code,
                                                    `C92`=icdgroup_c92_code,
                                                    `C93`=icdgroup_c9195s_code,
                                                    `C94`=icdgroup_c9195s_code,
                                                    `C95`=icdgroup_c9195s_code,
                                                    `C96`=icdgroup_c96_code
    ))%>%
    sjlabelled::var_labels(t_icdgroup_pub.2="Tumor group (ICD-10GM based grouping)")

```

### t_icdgroup_pubdet.2 - group SPCs into categories used in publication; more detail on C00-C14

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
    dplyr::mutate(t_icdgroup_pubdet.2 = 
                    recode_factor(t_icdcat.2,
                                                   `C00`="Lip (C00)",  
                                                    `C01`="Oral cavity (C01-C06)",
                                                    `C02`="Oral cavity (C01-C06)",
                                                    `C03`="Oral cavity (C01-C06)",
                                                    `C04`="Oral cavity (C01-C06)",
                                                    `C05`="Oral cavity (C01-C06)",
                                                    `C06`="Oral cavity (C01-C06)",
                                                    `C07`="Salivary glands (C07-C08)",
                                                    `C08`="Salivary glands (C07-C08)",
                                                    `C09`="Tonsil (C09)",
                                                    `C10`="Pharynx (C10-C14)",
                                                    `C11`="Pharynx (C10-C14)",
                                                    `C12`="Pharynx (C10-C14)",
                                                    `C13`="Pharynx (C10-C14)",
                                                    `C14`="Pharynx (C10-C14)",
                                                    `C15`=icdgroup_c15_code,                     
                                                    `C16`="Stomach (C16)",
                                                    `C17`="Small intestine (C17)",
                                                    `C18`="Colorectum (C18-C20)",
                                                    `C19`="Colorectum (C18-C20)",
                                                    `C20`="Colorectum (C18-C20)",
                                                    `C21`="Anus (C21)",
                                                    `C22`="Liver (C22)",
                                                    `C23`="Gallbladder (C23-C24)",
                                                    `C24`="Gallbladder (C23-C24)",
                                                    `C25`="Pancreas (C25)",
                                                    `C26`="Other digestive organs (C26)",
                                                    `C30`="Nasal cavity, middle ear, accessory sinuses (C30-C31)",
                                                    `C31`="Nasal cavity, middle ear, accessory sinuses (C30-C31)",
                                                    `C32`="Larynx (C32)",
                                                    `C33`="Lung (C33-C34)",
                                                    `C34`="Lung (C33-C34)",
                                                    `C37`="Thymus (C37)",
                                                    `C38`="Heart, mediastinum, pleura (C38)",
                                                    `C39`="Other respiratory system, inthrathoracic organs (C39)",
                                                    `C40`="Bone, articular cartilage (C40-C41)",
                                                    `C41`="Bone, articular cartilage (C40-C41)",
                                                    `C43`="Skin melanoma (C43)",
                                                    `C44`="Non-melanoma skin (C44)",
                                                    `C45`="Mesothelial, soft tissue (C45-C49)",
                                                    `C46`="Mesothelial, soft tissue (C45-C49)",
                                                    `C47`="Mesothelial, soft tissue (C45-C49)",
                                                    `C48`="Mesothelial, soft tissue (C45-C49)",
                                                    `C49`="Mesothelial, soft tissue (C45-C49)",
                                                    `C50`="Breast (C50)",
                                                    `C51`="Vulva (C51)",
                                                    `C52`="Vagina (C52)",
                                                    `C53`="Cervix (C53)",
                                                    `C54`="Uterus (C54-C55)",
                                                    `C55`="Uterus (C54-C55)",
                                                    `C56`="Ovary (C56)",
                                                    `C57`="Other female genital organs (C57)",
                                                    `C58`="Placenta (C58)",
                                                    `C60`="Penis (C60)",
                                                    `C61`="Prostate (C61)",
                                                    `C62`="Testis (C62)",
                                                    `C63`="Other male genital organs (C63)",
                                                    `C64`="Kidney (C64)",
                                                    `C65`="Urinary tract (C65-C68)",
                                                    `C66`="Urinary tract (C65-C68)",
                                                    `C67`="Urinary tract (C65-C68)",
                                                    `C68`="Urinary tract (C65-C68)",
                                                    `C69`="Eye (C69)",
                                                    `C70`="Brain, central nervous system (C70-C72)",
                                                    `C71`="Brain, central nervous system (C70-C72)",
                                                    `C72`="Brain, central nervous system (C70-C72)",
                                                    `C73`="Thyroid, endocrine glands (C73-C75)",
                                                    `C74`="Thyroid, endocrine glands (C73-C75)",
                                                    `C75`="Thyroid, endocrine glands (C73-C75)",
                                                    `C76`="Ill-defined sites (C76-C80)",
                                                    `C77`="Ill-defined sites (C76-C80)",
                                                    `C78`="Ill-defined sites (C76-C80)",
                                                    `C79`="Ill-defined sites (C76-C80)",
                                                    `C80`="Ill-defined sites (C76-C80)",
                                                    `C81`="Hodgkin lymphoma (C81)",
                                                    `C82`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C83`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C84`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C85`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C86`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C87`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C88`="Non-Hodgkin lymphoma (C82-C88)",
                                                    `C90`="Multiple myeloma (C90)",
                                                    `C91`=icdgroup_c9195s_code,
                                                    `C92`=icdgroup_c92_code,
                                                    `C93`=icdgroup_c9195s_code,
                                                    `C94`=icdgroup_c9195s_code,
                                                    `C95`=icdgroup_c9195s_code,
                                                    `C96`=icdgroup_c96_code
    ))%>%
    sjlabelled::var_labels(t_icdgroup_pubdet.2="Tumor group (ICD-10GM based grouping)")

```

### p_futimeyrs - Calculate FU time

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  #calc_futime
   msSPChelpR::calc_futime_tt(., futime_var_new = "p_futimeyrs", fu_end = "2014-12-15",
                           dattype = "zfkd", check = FALSE, time_unit = "years", 
                           lifedat_var = "SDIMP.1", status_var = "p_status",
                           fcdat_var = "DDIMP.1", spcdat_var = "DDIMP.2"
                           )
```

### p_futimegroup - FU time categorical

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
      mutate(p_futimegroup = case_when(
         p_futimeyrs == 0 ~ 0,
         DSICH.1 == "DCO (death certificate only)" ~ 0,
         p_futimeyrs > 0 & p_futimeyrs < 0.5      ~ 1,
         p_futimeyrs >= 0.5 & p_futimeyrs < 1     ~ 2,
         p_futimeyrs >= 1 & p_futimeyrs < 5       ~ 3,
         p_futimeyrs >= 5 & p_futimeyrs < 10      ~ 4,
         p_futimeyrs >= 10 & !is.na(p_futimeyrs)  ~ 5,
         is.na(p_futimeyrs)                       ~ NA_real_, 
        TRUE                                      ~ 999 #should not occur
        )) %>%
  sjlabelled::var_labels(p_futimegroup = "Follow-up time [grouped]") %>%
  sjlabelled::set_labels(p_futimegroup, labels = c("DCO or less than 1 month" = 0,
                                                   "1-6 months"  = 1,
                                                   "6-12 months" = 2,
                                                   "1-5 years"   = 3,
                                                   "5-10 years"  = 4,
                                                   "10+ years"   = 5,
                                                   "Error - check this" = 999)) %>%
  mutate(dplyr::across(.cols = p_futimegroup, .fns = ~ sjlabelled::as_label(.x , keep.labels=TRUE))) 
  
  

```  

### p_agefcgroup - Age at first cancer diagnosis categorical

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
    dplyr::mutate(p_agefcgroup = case_when(
                                    t_agediag.1 >= 30 & t_agediag.1 < 55  ~ 11,
                                    t_agediag.1 >= 55 & t_agediag.1 < 60  ~ 12,
                                    t_agediag.1 >= 60 & t_agediag.1 < 65  ~ 13,
                                    t_agediag.1 >= 65 & t_agediag.1 < 70  ~ 14,
                                    t_agediag.1 >= 70 & t_agediag.1 < 75  ~ 15,
                                    t_agediag.1 >= 75 & t_agediag.1 < 80  ~ 16,
                                    t_agediag.1 >= 80 & t_agediag.1 < 85  ~ 17,
                                    t_agediag.1 >= 85                   ~ 18,
                                    TRUE ~ NA_real_)) %>%
  sjlabelled::var_labels(p_agefcgroup="Age at diagnosis of first cancer [grouped]") %>%
  sjlabelled::set_labels(p_agefcgroup, labels = c("30 - 54" = 11,
                                        "55 - 59" = 12,
                                        "60 - 64" = 13,
                                        "65 - 69" = 14,
                                        "70 - 74" = 15,
                                        "75 - 79" = 16,
                                        "80 - 84" = 17,
                                        "85+" =18)) %>%
  mutate(dplyr::across(.cols = p_agefcgroup, .fns = ~ sjlabelled::as_label(.x , keep.labels=TRUE))) 

``` 

### t_smokeiarc.2 - Smoking-related cancer according to IARC definition

```{r}
#second cancer smoking related according to @secretanReviewHumanCarcinogens2009
#* asterisk highlights sites where differentiation on an ICD-3 level is not possible and all diagnoses under this code have been defined as smoking-related.
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  dplyr::mutate(t_smokeiarc.2 = case_when(
      t_icdcat.2 == "C00" ~ 0, #Lip
      t_icdcat.2 == "C01" ~ 1, #Oral cavity
      t_icdcat.2 == "C02" ~ 1, #Oral cavity
      t_icdcat.2 == "C03" ~ 1, #Oral cavity
      t_icdcat.2 == "C04" ~ 1, #Oral cavity
      t_icdcat.2 == "C05" ~ 1, #Oral cavity
      t_icdcat.2 == "C06" ~ 1, #Oral cavity
      t_icdcat.2 == "C07" ~ 0, #Salivary glands
      t_icdcat.2 == "C08" ~ 0, #Salivary glands
      t_icdcat.2 == "C09" ~ 0, #Tonsil
      t_icdcat.2 == "C10" ~ 1, #oropharynx, nasopharynx, and hypopharynx
      t_icdcat.2 == "C11" ~ 1, #oropharynx, nasopharynx, and hypopharynx
      t_icdcat.2 == "C12" ~ 1, #oropharynx, nasopharynx, and hypopharynx
      t_icdcat.2 == "C13" ~ 1, #oropharynx, nasopharynx, and hypopharynx
      t_icdcat.2 == "C14" ~ 1, #oropharynx, nasopharynx, and hypopharynx
      t_icdcat.2 == "C15" ~ 1, #oesophagus
      t_icdcat.2 == "C16" ~ 1, #stomach
      t_icdcat.2 == "C18" ~ 1, #colorectum
      t_icdcat.2 == "C19" ~ 1, #colorectum
      t_icdcat.2 == "C20" ~ 1, #colorectum
      t_icdcat.2 == "C22" ~ 1, #liver * (including intraphepatic bile ducts although not defined by IARC)
      t_icdcat.2 == "C25" ~ 1, #pancreas
      t_icdcat.2 == "C30" ~ 1, #nasal cavity and paranasal sinuses * (middle ear included although not defined by IARC)
      t_icdcat.2 == "C31" ~ 1, #paranasal sinuses
      t_icdcat.2 == "C32" ~ 1, #larynx
      t_icdcat.2 == "C33" ~ 1, #lung
      t_icdcat.2 == "C34" ~ 1, #lung
      t_icdcat.2 == "C53" ~ 1, #uterine cervix
      t_icdcat.2 == "C56" ~ 1, #ovary (mucinous)
      t_icdcat.2 == "C64" ~ 1, #kidney (body and pelvis)
      t_icdcat.2 == "C65" ~ 1, #kidney (body and pelvis)
      t_icdcat.2 == "C66" ~ 1, #urinary bladder, ureter
      t_icdcat.2 == "C67" ~ 1, #urinary bladder, ureter
      t_icdcat.2 == "C68" ~ 1, #other urinary
      t_icdcat.2 == "C92" ~ 1, #bone marrow (myeloid leukaemia)
      !is.na(t_icdcat.2)    ~ 0, #all other cancers
      TRUE ~ NA_real_)) %>%
    sjlabelled::var_labels(t_smokeiarc.2 = "Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc.2, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc.2, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE)))
```

### p_region_recode - Region variable 

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
    #use general information of GKZbl.1, but make DEA3 Muenster a separate region (for later filtering)
    tidylog::mutate(p_region_recode = recode_factor(GKZbl.1,
                                  `Baden-Wuerttemberg`           ="DE1 Baden-Wuerttemberg",
                                  `Bavaria`                      ="DE2 Bavaria",
                                  `Berlin`                       ="DE3 Berlin",
                                  `Brandenburg`                  ="DE4 Brandenburg",
                                  `Bremen`                       ="DE5 Bremen",
                                  `Hamburg`                      ="DE6 Hamburg",
                                  `Hesse`                        ="DE7 Hesse",
                                  `Mecklenburg-Western Pomerania`="DE8 Mecklenburg-Western Pomerania",
                                  `Lower Saxony`                 ="DE9 Lower Saxony",
                                  `North Rhine-Westphalia`       ="DEA North Rhine-Westphalia",
                                  `Rhineland-Palatinate`         ="DEB Rhineland-Palatinate",
                                  `Saarland`                     ="DEC Saarland",
                                  `Saxony`                       ="DED Saxony",
                                  `Saxony-Anhalt`                ="DEE Saxony-Anhalt",
                                  `Schleswig-Holstein`           ="DEF Schleswig-Holstein",
                                  `Thuringia`                    ="DEG Thuringia"
  ))%>%
  tidylog::mutate(p_region_recode = dplyr::case_when(NUTS_2_Code.1 == "DEA3" ~ "DEA3 Muenster",
                                                     TRUE                    ~ as.character(p_region_recode))) %>%
  sjlabelled::var_labels(p_region_recode="Region of residence at diagnosis of primary cancer")
```
### t_singleyeardiag.1 - Year of diagnosis

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
   mutate(t_singleyeardiag.1 = lubridate::year(DDIMP.1))
```

### p_yearfcgroup - Year of diagnosis FC diagnosis (4-year groups)

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  mutate(p_yearfcgroup = case_when(
                                lubridate::year(DDIMP.1) >= 2002 &  lubridate::year(DDIMP.1) < 2006  ~ 7,
                                lubridate::year(DDIMP.1) >= 2006 &  lubridate::year(DDIMP.1) < 2010  ~ 8,
                                lubridate::year(DDIMP.1) >= 2010 &  lubridate::year(DDIMP.1) < 2014  ~ 9,
                                TRUE ~ NA_real_)) %>%
  sjlabelled::var_labels(p_yearfcgroup = "Time period of diagnosis of first cancer") %>%
  sjlabelled::set_labels(p_yearfcgroup, labels = c("2002 - 2005" = 7,
                                    "2006 - 2009" = 8,
                                    "2010 - 2013" = 9)) %>%
  mutate(dplyr::across(.cols = p_yearfcgroup, .fns = ~ sjlabelled::as_label(.x , keep.labels=TRUE))) 

```


### p_statusevent - Patient status (events: SPC developed, dead after LC, no event at end of FU time)

```{r}
wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  mutate(p_statusevent = case_when(
    p_status == 2 ~ 100, #alive with SPC developed - > SPC developed
    p_status == 4 ~ 100, #alive with SPC developed - > SPC developed
    p_status == 3 ~ 200, #patient dead after FC -> dead after LC
    p_status == 1 ~ 300, #patient alive after FC --> no event until end of FU
    p_status == 97 ~ 999,
    p_status == 98 ~ 999,
    TRUE ~ NA_real_)) %>%
  sjlabelled::var_labels(p_statusevent = "Patient status (events: SPC developed, dead after LC, no event until end of FU)") %>%
  sjlabelled::set_labels(p_statusevent, labels = c("SPC developed" = 100,
                                                   "dead after LC" = 200,
                                                   "no event until end of follow-up" = 300,
                                                   "Error - check this" = 999)) %>%
  mutate(dplyr::across(.cols = p_statusevent, .fns = ~ sjlabelled::as_label(.x , keep.labels=TRUE))) 

```

### reset all SPC relevant data if spc developed after end of FU

```{r}
#show which cases have not developed SPC before end of FU
wide_zdata_fc_lung %>%
  dplyr::count(p_spc, p_status)

#make detailed breakdown by DDIMP.2
wide_zdata_fc_lung %>%
  dplyr::filter(p_status == 1 & p_spc == "SPC developed") %>%
  dplyr::count(p_spc, p_status, DDIMP.2)

#prepare a check 
n_patstatus_reset <- wide_zdata_fc_lung %>%
  dplyr::filter((p_status == 1 & p_spc == "SPC developed") |
                  (p_status == 3 & p_spc == "SPC developed")) %>%
  nrow()

n_na_before <- wide_zdata_fc_lung %>%
  dplyr::filter(is.na(DDIMP.2)) %>%
  nrow()

#reset all diagnosis for second cancer

wide_zdata_fc_lung <- wide_zdata_fc_lung %>%
  #make tibble to avoid errors
  tibble::as_tibble() %>%
  #set all numeric cols to missing for pat_status 1(alive, no SPC yet); 3(dead, no SPC)
  dplyr::mutate(across(.cols = where(is.numeric) & ends_with(".2"), 
                       .fns = ~case_when(p_status == 1 ~ NA_real_,
                                         p_status == 3 ~ NA_real_,
                                         TRUE ~ .x))) %>%
  dplyr::mutate(across(.cols = where(lubridate::is.Date) & ends_with(".2"), 
                       .fns = ~case_when(p_status == 1 ~ lubridate::NA_Date_,
                                         p_status == 3 ~ lubridate::NA_Date_,
                                         TRUE ~ .x))) %>%
  dplyr::mutate(across(.cols = where(is.character) & ends_with(".2"), 
                       .fns = ~case_when(p_status == 1 ~ NA_character_,
                                         p_status == 3 ~ NA_character_,
                                         TRUE ~ .x))) %>%
  dplyr::mutate(across(.cols = where(is.factor) & ends_with(".2"), 
                       .fns = ~case_when(p_status == 1 ~ NA_character_,
                                         p_status == 3 ~ NA_character_,
                                         TRUE ~ as.character(.x)))) %>%
  dplyr::mutate(p_spc = case_when(p_status == 1  ~ "No SPC",
                                  p_status == 3  ~ "No SPC",
                                  TRUE ~ as.character(p_spc)))

n_na_after <- wide_zdata_fc_lung %>%
  dplyr::filter(is.na(DDIMP.2)) %>%
  nrow()

#test that no more variables are set to NA than expected
testthat::expect_equal(n_patstatus_reset, (n_na_after - n_na_before))

rm(n_patstatus_reset, n_na_after, n_na_before)

```

## Create different filtered dataset versions


### Dataset 0: all registries, all times

```{r}
d0_zlung_wide <- wide_zdata_fc_lung

nrow_d0 <- d0_zlung_wide %>% nrow()

```


### ASIR by region (to investigate registry completeness)

```{r}

d0_zlung_wide_asir <- d0_zlung_wide %>%
  mutate(count_var = 1)

#use asir function to calculate age-standardized rates by year and sex
asir_d0_region <- msSPChelpR::asir(d0_zlung_wide_asir, dattype = "zfkd", std_pop = "ESP1976", 
                                   summarize_groups = c("none"), 
                                   futime_src = "refpop", refpop_df = population, 
                                   count_var = "count_var", region_var = "p_region_recode", 
                                   year_var = "t_singleyeardiag.1", site_var = "t_icdcat.1")


# Plot of all regions together
asir_d0_region %>%
  filter(t_site == "C34") %>% 
  ggplot(aes(x = year, y = asir,  fill = sex)) + 
  geom_bar(stat="identity", position = "dodge") +
  geom_errorbar(aes(ymin=asir_lci_gam, ymax=asir_uci_gam), width=0.2, size=1, color="black") +
  facet_wrap( ~ region, ncol=4) +
  ggtitle("Age-standardized incidence rate (ref: 1976) for C34 by year, by sex, by region")


#use asir function to calculate age-standardized rates by year and sex
asir_d0_ger <- msSPChelpR::asir(d0_zlung_wide_asir, dattype = "zfkd", std_pop = "ESP1976", 
                                summarize_groups = c("region"), 
                                count_var = "count_var", region_var = "p_region_recode", 
                                year_var = "t_singleyeardiag.1", site_var = "t_icdcat.1")

# Plot of all regions together
asir_d0_ger %>%
  filter(t_site == "C34") %>% 
  ggplot(aes(x = year, y = asir,  fill = sex)) + 
  geom_bar(stat="identity", position = "dodge") +
  geom_errorbar(aes(ymin=asir_lci_gam, ymax=asir_uci_gam), width=0.2, size=1, color="black") +
  ggtitle("Age-standardized incidence rate (ref: ESP1976) for C34 by year, by sex - sum for all registries")


```

### Dataset 1: GEKID recommended registries, 2002-2013 (FC incidence); age 30-99 at LC diagnosis, 6 months latency LC and SPC , only 1st and 2nd cancer,end of follow-up 2014 (UK replication - Barclay et al 2019)


```{r}

# inclusion criteria according to GEKID @gekidInteraktiveKrebsAtlasGEKID2017; in order to increase case numbers, 
#           excluded cases with first cancer after 31-12-2013 because registration of 2014 apparently incomplete for many registries

d1_zlung_wide <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  # S5: delete DCO
  tidylog::filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1)) %>%
  # S6: minimum follow-up without SPC, death or end of FU >= 6 months  (0.5 years)after first lung cancer diagnosis
  tidylog::filter(p_futimeyrs >= 0.5)

 


# create case-counts by filtering step

nrow_d1_s1_date <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  nrow()

nrow_d1_s2_reg <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
 nrow()


nrow_d1_s3_age <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
 # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100))  %>% 
  nrow()

nrow_d1_s4_morph <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  nrow()

nrow_d1_s5_dco <- wide_zdata_fc_lung %>% 
    # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  # S5: delete DCO
  tidylog::filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1))  %>%
  nrow()

nrow_d1_s6_srv <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  # S5: delete DCO
  tidylog::filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1))  %>%
  # S6: minimum follow-up without SPC, death or end of FU >= 6 months  (0.5 years)after first lung cancer diagnosis
  tidylog::filter(p_futimeyrs >= 0.5) %>%
  nrow()


```

### Dataset 1raw : For ASIR calculations GEKID recommended registries, 2002-2013 (FC incidence) end of follow-up 2014

This is the Data-set 1 equivalent, but skips filter steps S3, S4, S5 and S6. It is intended for ASIR calculations, 


```{r}
# inclusion criteria according to GEKID @gekidInteraktiveKrebsAtlasGEKID2017; in order to increase case numbers, 
#           excluded cases with first cancer after 31-12-2013 because registration of 2014 apparently incomplete for many registries

d1raw_zlung_wide <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) 

```

### Dataset 2: No latency, incl. DCO.1, GEKID recommended registries, 2002-2013 (FC incidence); age 30-99 at LC diagnosis, no minimum latency between LC and SPC, end of follow-up 2014 (UK replication - Barclay et al 2019)

This is the Data-set 1 equivalent, but skips filter steps S4 and S5, so no minimal follow-up after lung cancer is required.

```{r}

# inclusion criteria according to GEKID @gekidInteraktiveKrebsAtlasGEKID2017; in order to increase case numbers, 
#           excluded cases with first cancer after 31-12-2013 because registration of 2014 apparently incomplete for many registries

d2_zlung_wide <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign")))
 

# create case-counts by filtering step

nrow_d2_s1_date <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  nrow()

nrow_d2_s2_reg <- wide_zdata_fc_lung %>% 
    # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
nrow()


nrow_d2_s3_age <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100))  %>% 
  nrow()


nrow_d2_s4_morph <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign")))%>%
  nrow()
```


### Dataset 3: No latency, excl. DCO.1, GEKID recommended registries, 2002-2013 (FC incidence); age 30-99 at LC diagnosis, no minimum latency between LC and SPC, end of follow-up 2014 (UK replication - Barclay et al 2019)

This is the Data-set 1 equivalent, but skips filter step S5, so no minimal follow-up after lung cancer is required, but DCO at LC are excluded.

```{r}

# inclusion criteria according to GEKID @gekidInteraktiveKrebsAtlasGEKID2017; in order to increase case numbers, 
#           excluded cases with first cancer after 31-12-2013 because registration of 2014 apparently incomplete for many registries

d3_zlung_wide <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  # S5: delete DCO
  tidylog::filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1)) 
 

# create case-counts by filtering step

nrow_d3_s1_date <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  nrow()

nrow_d3_s2_reg <- wide_zdata_fc_lung %>% 
    # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
nrow()


nrow_d3_s3_age <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100))  %>% 
  nrow()


nrow_d3_s4_morph <- wide_zdata_fc_lung %>% 
  # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  tidylog::filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign")))%>%
  nrow()

nrow_d3_s5_dco <- wide_zdata_fc_lung %>% 
    # S1: only select diagnosis 2002-2013 (as done by Barclay 2019; but had to exclude 2001, 2002, and 2014, because registration was incomplete)
  tidylog::filter((DDIMP.1 > "2002-01-01" & DDIMP.1 < "2013-12-31")) %>%   
  # S2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # + Bavaria                       2002-01-15 DE21, DE22, DE23, DE24, DE25, DE26, DE27    
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Brandenburg                   1990-01-15 DE40
    # + Bremen                        1998-01-15 DE50
    # + Hamburg                       1990-01-15 DE60
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # + Mecklenburg-Western Pomerania 1990-01-15 DE80
    # + Lower Saxony                  1997-01-15 DE91, DE92, DE93, DE94, DE9X
    # o North Rhine-Westphalia        1986-01-15 DEA3 --> only Münster (other Regions only started in 2008 too short FU)
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # + Saarland                      1970-01-15 DEC0
    # + Saxony                        1990-01-15 DED2, DED4, DED5
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # + Schleswig-Holstein            1998-01-15 DEF0    
    # + Thuringia                     1990-01-15 DEG0
  tidylog::filter(p_region_recode %in% c("DE2 Bavaria",
                                         "DE4 Brandenburg",
                                         "DE5 Bremen",
                                         "DE6 Hamburg",
                                         "DE8 Mecklenburg-Western Pomerania",
                                         "DE9 Lower Saxony",
                                         "DEA3 Muenster",
                                         "DEC Saarland",
                                         "DED Saxony",
                                         "DEF Schleswig-Holstein",
                                         "DEG Thuringia")) %>%
  # S3: filter for patients with LC diagnosis at age 30 to 99 years.
  tidylog::filter((t_agediag.1 >= 30 & t_agediag.1 < 100)) %>% 
  # S4: exclusion of unusual morphology
  filter(!(t_sublung.1 %in% c("Excluded - sarcoma", "Excluded - unusual", "Excluded - benign"))) %>%
  # S5: delete DCO
  tidylog::filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1))  %>%
  nrow()

```

### Datasets without DCO

```{r}
nrow_d2_all <- nrow(d2_zlung_wide)

nrow_d2_nodco1 <- d2_zlung_wide  %>%
  #S2 delete DCO cases
  filter(DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1)) %>%
  nrow()

nrow_d2_nodco2 <- d2_zlung_wide  %>%
  #S2 delete DCO cases
  filter((DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1))& 
           (DSICH.2 != "DCO (death certificate only)" | is.na(DSICH.2))) %>%
  nrow()

d2nodco_zlung_wide <- d2_zlung_wide %>%
  #S2 delete DCO cases
  filter((DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1)) & 
           (DSICH.2 != "DCO (death certificate only)" | is.na(DSICH.2))) 

d1nodco_zlung_wide <- d1_zlung_wide %>%
  #S2 delete DCO cases
  filter((DSICH.1 != "DCO (death certificate only)" | is.na(DSICH.1)) & 
           (DSICH.2 != "DCO (death certificate only)" | is.na(DSICH.2)))

```

# Statistical Analyses

## Descriptives


### Case number (flow-chart) when replicating Barclay and excluding < 6 months FU

- Complete database (ZfKD all regions, all tumors)
  - n = 4,736,067 patients
- S0: all patients with primary lung cancer (C33-C34)
  - n = `r nrow_d0`
- S1: LC diagnosis between 2000 and 2013
  - n = `r nrow_d1_s1_date`
- S2: in regions that have registries with acceptable data quality (GEKID recommended)
  - n = `r nrow_d1_s2_reg`
- S3: LC diagnosis at age 30 to 99
  - n = `r nrow_d1_s3_age`  
- S4: not death certificate only cases (DCO)
  - n = `r nrow_d1_s4_morph`
- S5: survived at least for 6 months
  - n = `r nrow_d1_s5_dco`
- S6: morphology of LC not unusual, benign, sarcoma 
  - n = `r nrow_d1_s6_srv`

### DCO rates
- percentage of DCO in primary LC `r round((1 - nrow_d2_nodco1 / nrow_d2_all)*100, 2)`%

```{r}
#DCO rates for FC by registry and year
dco_rates_byyear_fc <- wide_zdata_fc_lung %>%
  tibble::as_tibble() %>%
  dplyr::mutate(year = t_singleyeardiag.1) %>%
  dplyr::group_by(p_region.1, year) %>%
  dplyr::summarize(n = n(),
                   n_dco = sum(DSICH.1=="DCO (death certificate only)", na.rm = TRUE)) %>%
  dplyr::ungroup() %>% 
  dplyr::filter(year > 1990) %>%
  dplyr::mutate(dco_rate = n_dco / n * 100,
                cancer = "first cancer")

#DCO rates for SPC by registry and year

dco_rates_byyear_spc <- wide_zdata_fc_lung %>%
  tibble::as_tibble() %>%
  dplyr::mutate(year = lubridate::year(DDIMP.2)) %>%
  dplyr::group_by(p_region.1, year, p_spc) %>%
  dplyr::summarize(n = n(),
                   n_dco = sum(DSICH.2=="DCO (death certificate only)", na.rm = TRUE)) %>%
  dplyr::ungroup() %>% 
  dplyr::filter(p_spc == "SPC developed" & year > 1990) %>%
  dplyr::mutate(dco_rate = n_dco / n * 100,
                cancer = "second cancer")

dco_rate_d1 <- d1_zlung_wide %>%
  tibble::as_tibble() %>%
  dplyr::group_by(p_spc) %>%
  dplyr::summarize(n = n(),
                   n_dco = sum(DSICH.2=="DCO (death certificate only)", na.rm = TRUE)) %>%
  dplyr::ungroup() %>% 
  dplyr::filter(p_spc == "SPC developed") %>%
  dplyr::mutate(dco_rate = n_dco / n * 100)


dco_rates_byyear <- bind_rows(dco_rates_byyear_fc, dco_rates_byyear_spc)

rm(dco_rates_byyear_fc, dco_rates_byyear_spc)

```

DCO rates for LC in all regions but Saarland: `r round((dco_rates_byyear %>% filter(cancer == "first cancer" & p_region.1 == "DEC Saarland") %>% summarize(dco_rate = sum(n_dco) / sum(n)) %>% pull(dco_rate))*100, 2)`%.

DCO rates for SPC in Saarland: `r round((dco_rates_byyear %>% filter(cancer == "second cancer" & p_region.1 == "DEC Saarland") %>% summarize(dco_rate = sum(n_dco) / sum(n)) %>% pull(dco_rate))*100, 2)`%.

DCO rates for SPC in all regions but Saarland: `r round((dco_rates_byyear %>% filter(cancer == "second cancer" & p_region.1 != "DEC Saarland") %>% summarize(dco_rate = sum(n_dco) / sum(n)) %>% pull(dco_rate))*100, 2)`%.

DCO rates in main analysis data set for SPC: `r round((dco_rate_d1 %>% pull(dco_rate))*100, 2)`%.

### Numbers in Method section

```{r}
regs <- d1_zlung_wide %>% select(p_region_recode) %>% unique() %>% unlist()

pop_incl <- population %>% filter(region %in% regs & sex == "Total - All sexes" & age == "Total - All age groups" & year == "2013") %>% distinct() %>% summarize(pop = sum(population_n_per_year)) %>% distinct() %>% unlist()

pop_all <- population %>% filter(sex == "Total - All sexes" & age == "Total - All age groups" & year == "2013" & region == "Total - Germany") %>% distinct() %>% pull(population_n_per_year)
```

The included registries are `regs` and cover `r round(pop_incl/pop_all * 100, 1)`% of the German population. 

### Table 1: Descriptives

#### Prepare Table 1

-	Descriptive statistics (ASIR, sex, age, mean follow-up, Incidence of SPC)
o	Table 1: Descriptive statistics (incl. summary of missing data)
o	Most frequent sites for SPC after lung cancer (does SPC occur in smoking-related cancer sites as defined by IARC?)

```{r tab1_prepare}

#prepare custom table 1

##calculate single parts (N FC, ASIR FC 2002-2013, FU time, Cases > 6months, Age, Period of Diagnosis, Mean FU time, PYAR SPC developed [N, %, Abs Inc Rate])

#e1 Number of First Cancers

tab1_e1 <- d2_zlung_wide %>%
  count(SEX.1) %>%
  mutate(freq = n / sum(n)) %>%
  tibble::add_row(SEX.1 = "Total",
                  n = nrow(d2_zlung_wide),
                  freq = 1)  %>%
  rename(sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (all independent of survival)",
         variable = "Patients with primary LC",
         category = "n (% of Total)") %>%
  select(group, variable, category, sex, n, freq)


#e2 ASIR (using d2 data set - exclusion by age, region and uncertain morphology)
tab1_e2_asirtot <- d2_zlung_wide %>%
  mutate(count_var = 1) %>%
  msSPChelpR::asir(dattype = "zfkd", std_pop = "ESP1976", summarize_groups = c("region", "sex"), count_var = "count_var", 
                          region_var = "p_region_recode", year_var = "t_singleyeardiag.1", site_var = "t_icdgroup.1") %>%
  filter(t_site == "Lung (C33-C34)") %>%
  select(sex, year, asir, asir_lci_gam, asir_uci_gam) %>%
  mutate(group = "Observed cases of primary lung cancer (all independent of survival)",
         variable = "Age-standardized incidence rate of lung cancer (European Standard Population 1976)",
         category = paste0("ASIR in ", year, " [per 100,000] (95% CI)"),
         value = round(asir, 1),
         lci = round(asir_lci_gam, 1),
         uci = round(asir_uci_gam, 1),
         sex = "Total") %>%
  select(group, variable, category, sex, value, lci, uci)

tab1_e2_asirsex <- d2_zlung_wide %>%
  mutate(count_var = 1) %>%
  msSPChelpR::asir(dattype = "zfkd", std_pop = "ESP1976", summarize_groups = c("region"), count_var = "count_var", 
                          region_var = "p_region_recode", year_var = "t_singleyeardiag.1", site_var = "t_icdgroup.1") %>%
  filter(t_site == "Lung (C33-C34)") %>%
  select(sex, year, asir, asir_lci_gam, asir_uci_gam) %>%
  mutate(group = "Observed cases of primary lung cancer (all independent of survival)",
         variable = "Age-standardized incidence rate of lung cancer (European Standard Population 1976)",
         category = paste0("ASIR in ", year, " [per 100,000] (95% CI)"),
         value = round(asir, 1),
         lci = round(asir_lci_gam, 1),
         uci = round(asir_uci_gam, 1)) %>%
  select(group, variable, category, sex, value, lci, uci)

tab1_e2 <- rbind(tab1_e2_asirtot, tab1_e2_asirsex)
rm(tab1_e2_asirsex, tab1_e2_asirtot)

#e3 Patients by FU time

tab1_e3_fusex <- d2_zlung_wide %>%
  group_by(SEX.1) %>%
  count(p_futimegroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_futimegroup,
         sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (all independent of survival)",
         variable = "Follow-up time",
         category = forcats::fct_explicit_na(category, "Unknown")) %>%
  select(group, variable, category, sex, n, freq)

tab1_e3_futot <- d2_zlung_wide %>%
  count(p_futimegroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_futimegroup) %>%
  mutate(group = "Observed cases of primary lung cancer (all independent of survival)",
         variable = "Follow-up time",
         category = forcats::fct_explicit_na(category, "Unknown"),
         sex = "Total") %>%
  select(group, variable, category, sex, n, freq)

tab1_e3 <- rbind(tab1_e3_futot, tab1_e3_fusex)
rm(tab1_e3_futot, tab1_e3_fusex)

#e4 Number of First Cancers after excluding DCO, at least 6 months follow-up
tab1_e4 <- d1_zlung_wide %>%
  count(SEX.1) %>%
  mutate(freq = n / sum(n)) %>%
  tibble::add_row(SEX.1 = "Total",
                  n = nrow(d1_zlung_wide),
                  freq = 1)  %>%
  rename(sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Patients with primary LC [n (% of total)]",
         category = "n (% of Total)") %>%
  select(group, variable, category, sex, n, freq)


#e5 Age

tab1_e5_agesex <- d1_zlung_wide %>%
  group_by(SEX.1) %>%
  count(p_agefcgroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_agefcgroup,
         sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Age at diagnosis of LC",
         category = forcats::fct_explicit_na(category, "Unknown")) %>%
  select(group, variable, category, sex, n, freq)

tab1_e5_agetot <- d1_zlung_wide %>%
  count(p_agefcgroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_agefcgroup) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Age at diagnosis of LC",
         category = forcats::fct_explicit_na(category, "Unknown"),
         sex = "Total") %>%
  select(group, variable, category, sex, n, freq)

tab1_e5 <- rbind(tab1_e5_agetot, tab1_e5_agesex)
rm(tab1_e5_agetot, tab1_e5_agesex)

#e6 Year of Diagnosis of FC

tab1_e6_yearsex <- d1_zlung_wide %>%
  group_by(SEX.1) %>%
  count(p_yearfcgroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_yearfcgroup,
         sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Year of diagnosis of LC",
         category = forcats::fct_explicit_na(category, "Unknown")) %>%
  select(group, variable, category, sex, n, freq)

tab1_e6_yeartot <- d1_zlung_wide %>%
  count(p_yearfcgroup) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_yearfcgroup) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Year of diagnosis of LC",
         category = forcats::fct_explicit_na(category, "Unknown"),
         sex = "Total") %>%
  select(group, variable, category, sex, n, freq)

tab1_e6 <- rbind(tab1_e6_yeartot, tab1_e6_yearsex)
rm(tab1_e6_yeartot, tab1_e6_yearsex)

#e7 Sub-site

tab1_e7_subsex <- d1_zlung_wide %>%
  group_by(SEX.1) %>%
  count(t_sublung.1) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = t_sublung.1,
         sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Subsite of LC",
         category = forcats::fct_explicit_na(category, "Unknown")) %>%
  select(group, variable, category, sex, n, freq)

tab1_e7_subtot <- d1_zlung_wide %>%
  count(t_sublung.1) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = t_sublung.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Subsite of LC",
         category = forcats::fct_explicit_na(category, "Unknown"),
         sex = "Total") %>%
  select(group, variable, category, sex, n, freq)

tab1_e7 <- rbind(tab1_e7_subtot, tab1_e7_subsex)
rm(tab1_e7_subtot, tab1_e7_subsex)


#e8 FU time (mean + PYAR sum)

tab1_e8_fusex <- d1_zlung_wide %>% 
  group_by(SEX.1) %>%
  summarize(fu_mean = mean(p_futimeyrs, na.rm = TRUE) * 12) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Person-years at risk",
         category = "Mean follow-up [months]",
         sex = SEX.1,
         value = round(fu_mean, 1)) %>%
  select(group, variable, category, sex, value)

tab1_e8_futot <- d1_zlung_wide %>% 
  summarize(fu_mean = mean(p_futimeyrs, na.rm = TRUE) * 12) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Person-years at risk",
         category = "Mean follow-up [months]",
         sex = "Total",
         value = round(fu_mean, 1)) %>%
  select(group, variable, category, sex, value)

tab1_e8_pyarsex <- d1_zlung_wide %>% 
  group_by(SEX.1) %>%
  summarize(fu_mean = sum(p_futimeyrs, na.rm = TRUE)) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Person-years at risk",
         category = "Sum of PYAR",
         sex = SEX.1,
         value = round(fu_mean, 0)) %>%
  select(group, variable, category, sex, value)
 

tab1_e8_pyartot <- d1_zlung_wide %>% 
  summarize(fu_mean = sum(p_futimeyrs, na.rm = TRUE)) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Person-years at risk",
         category = "Sum of PYAR",
         sex = "Total",
         value = round(fu_mean, 0)) %>%
  select(group, variable, category, sex, value)

tab1_e8 <- rbind(tab1_e8_futot, tab1_e8_fusex, tab1_e8_pyartot, tab1_e8_pyarsex)
rm(tab1_e8_futot, tab1_e8_fusex, tab1_e8_pyarsex, tab1_e8_pyartot)

#e9 Status (SPC, dead, end of FU)

tab1_e9_statsex <- d1_zlung_wide %>%
  group_by(SEX.1) %>%
  count(p_statusevent) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_statusevent,
         sex = SEX.1) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Patient status",
         category = forcats::fct_explicit_na(category, "Unknown")) %>%
  select(group, variable, category, sex, n, freq)

tab1_e9_stattot <- d1_zlung_wide %>%
  count(p_statusevent) %>%
  mutate(freq = n / sum(n)) %>%
  rename(category = p_statusevent) %>%
  mutate(group = "Observed cases of primary lung cancer (at least 6 months survival)",
         variable = "Patient status",
         category = forcats::fct_explicit_na(category, "Unknown"),
         sex = "Total") %>%
  select(group, variable, category, sex, n, freq)

tab1_e9 <- rbind(tab1_e9_stattot, tab1_e9_statsex)
rm(tab1_e9_stattot, tab1_e9_statsex)

#e10 Incidence of SPC

tab1_e10 <- d1_zlung_wide %>%
    mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  msSPChelpR::ir_crosstab(dattype = "zfkd", count_var = "count_spc", xbreak_var = "none", 
                          ybreak_vars = c("SEX.1", "t_sublung.1"),
                          add_total = "top", collapse_ci = FALSE,  futime_var = "p_futimeyrs",  alpha = 0.05) %>%
  filter(yvar_name != "t_sublung.1") %>%
    mutate(group = "SPC developed",
           variable = "Absolute incidence rate of SPC",
           category = "IR [per 100,000 person-years] (95% CI)",
           sex = yvar_label,
           value = abs_ir,
           lci = abs_ir_lci,
           uci = abs_ir_uci) %>%
  select(group, variable, category, sex, value, lci, uci)


##put  single parts together and reshape

tab1 <- bind_rows(tab1_e1, tab1_e2, tab1_e3, tab1_e4, tab1_e5, tab1_e6, tab1_e7, tab1_e8, tab1_e9, tab1_e10)
rm(tab1_e1, tab1_e2, tab1_e3, tab1_e4, tab1_e5, tab1_e6, tab1_e7, tab1_e8, tab1_e9, tab1_e10)

tab1 <- tab1 %>%
  pivot_wider(names_from = sex,
              values_from = tidyselect::all_of(c("n", "freq", "value", "lci", "uci")),
              names_sep = "_")
```
#### Plots for Table 1

```{r}
#plot male ASIR for Tab 1
tab1_plot_t <- tab1 %>%
  filter(variable == "Age-standardized incidence rate of lung cancer (European Standard Population 1976)") %>%
  mutate(year = as.numeric(str_remove_all(category, paste(c("ASIR in ", " \\[per 100,000\\] \\(95\\% CI\\)"), collapse = "|")))) %>%
  select(year, ASIR = value_Total) %>%
  ggplot(aes(x=year, y=ASIR, colour = "black")) +
  geom_col(fill = "black") +
  coord_cartesian(xlim= c(2002, 2013), ylim = c(0, 65)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_text(size=25),
        legend.position="none")


tab1_plot_t

#plot male ASIR for Tab 1
tab1_plot_m <- tab1 %>%
  filter(variable == "Age-standardized incidence rate of lung cancer (European Standard Population 1976)") %>%
  mutate(year = as.numeric(str_remove_all(category, paste(c("ASIR in ", " \\[per 100,000\\] \\(95\\% CI\\)"), collapse = "|")))) %>%
  select(year, ASIR = value_Male) %>%
  ggplot(aes(x=year, y=ASIR, colour = colors_2_sex["Male"])) +
  geom_col(fill = colors_2_sex["Male"]) +
  coord_cartesian(xlim= c(2002, 2013), ylim = c(0, 65)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_text(size=25),
        legend.position="none")

tab1_plot_m

#plot female ASIR for Tab 1
tab1_plot_f <- tab1 %>%
  filter(variable == "Age-standardized incidence rate of lung cancer (European Standard Population 1976)") %>%
  mutate(year = as.numeric(str_remove_all(category, paste(c("ASIR in ", " \\[per 100,000\\] \\(95\\% CI\\)"), collapse = "|")))) %>%
  select(year, ASIR = value_Female) %>%
  ggplot(aes(x=year, y=ASIR)) +
  geom_col(fill = colors_2_sex["Female"]) +
  coord_cartesian(xlim= c(2002, 2013), ylim = c(0, 65)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_text(size=25),
        legend.position="none")

tab1_plot_f
  

```

#### Table 1: Put parts together


```{r, warning = FALSE}

#helpers
rows_ci <- c(1,2,3,4,35) #rows 2,3,34 get confidence intervals

##create table with gt
#to merge variables https://gt.rstudio.com/reference/text_transform.html

tab1_pre <- tab1 %>%
  dplyr::select(group, variable, category,
                n_Total, freq_Total, n_Male, freq_Male, n_Female, freq_Female,
                value_Total, lci_Total, uci_Total, value_Male, lci_Male, uci_Male, value_Female, lci_Female, uci_Female) %>%
  #remove ASIR from years 2003-2012
  dplyr::filter(!(category %in% c("ASIR in 2003 [per 100,000] (95% CI)", "ASIR in 2004 [per 100,000] (95% CI)",
                                  "ASIR in 2005 [per 100,000] (95% CI)",
                                  "ASIR in 2007 [per 100,000] (95% CI)", "ASIR in 2008 [per 100,000] (95% CI)",
                                  "ASIR in 2009 [per 100,000] (95% CI)", 
                                  "ASIR in 2011 [per 100,000] (95% CI)", "ASIR in 2012 [per 100,000] (95% CI)"))) %>%
    #remove total row
  dplyr::filter(!(variable == "Patients with primary LC"))

#get % of male and female
res_n_fc_perc_m <- tab1 %>% filter(variable == "Patients with primary LC [n (% of total)]") %>% pull(freq_Male) %>% "*"(100) %>% round(., 1) %>% format(., nsmall = 1)
res_n_fc_perc_f <- tab1 %>% filter(variable == "Patients with primary LC [n (% of total)]") %>% pull(freq_Female) %>% "*"(100) %>% round(., 1) %>% format(., nsmall = 1)

#plot table
tab1_gt <- tab1_pre %>%
   #change label of one histology code
  mutate(category = case_when(category == "Unspecified lung"  ~ "Unspecified lung cancer",
                              TRUE ~ category)) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = c(group, variable, value_Total, value_Male, value_Female, lci_Total, lci_Male, lci_Female,
                   uci_Total, uci_Male, uci_Female)
  ) %>%
     #Column labeling
  gt::cols_label(
    category = md("**Observed cases of primary lung cancer**<br>(all independent of survival)"),
    n_Total = md(paste0("**Total**<br>n=", format(tab1$n_Total[1], big.mark=",") ," (100.0%)")), 
    n_Male = md(paste0("**Male**<br>n=", format(tab1$n_Male[1], big.mark=",") ," (", res_n_fc_perc_m, "%)")),
    n_Female = md(paste0("**Female**<br>n=", format(tab1$n_Female[1], big.mark=",") ," (", res_n_fc_perc_f, "%)")))%>%
 #gt: Define row groups -> careful: you need to add groups in reverse order... so bottom group first
  gt::tab_row_group(
    label = tab1_pre$variable[35],
    rows = variable == tab1_pre$variable[35] 
    ) %>%
  gt::tab_row_group(
    label = tab1_pre$variable[32],
    rows = variable == tab1_pre$variable[32]
    ) %>%
    gt::tab_row_group(
    label = tab1_pre$variable[30],
    rows = variable == tab1_pre$variable[30]
    ) %>%
  gt::tab_row_group(
    label = "Histology of LC",
    rows = variable == tab1_pre$variable[24]
    ) %>%
    gt::tab_row_group(
    label = tab1_pre$variable[21],
    rows = variable == tab1_pre$variable[21]
    ) %>%
  gt::tab_row_group(
    label = tab1_pre$variable[13],
    rows = variable == tab1_pre$variable[13]
    ) %>%
    gt::tab_row_group(
    label = md("**Observed cases of primary lung cancer** (at least 6 months survival)"),
    rows = c(12)
    ) %>%
    gt::tab_row_group(
    label = tab1_pre$variable[5],
    rows = variable == tab1_pre$variable[5]
    ) %>%
    gt::tab_row_group(
    label = ifelse(en_gb, "Age-standardised incidence rate of lung cancer", "Age-standardized incidence rate of lung cancer"),
    rows = variable == tab1_pre$variable[1]
    ) %>%
  #define general number formatting by row
  gt::fmt_number(
    columns = c(n_Total, n_Male, n_Female),
    rows = c(5:29, 32:34),
    decimals = 0
  ) %>%
  gt::fmt_percent(
    columns = c(freq_Total, freq_Male, freq_Female),
    rows = c(5:29, 32:34),
    decimals = 1
  ) %>%
  gt::cols_merge_n_pct(
    col_n = c(n_Total),
    col_pct = c(freq_Total)
  ) %>%
    gt::cols_merge_n_pct(
    col_n = c(n_Male),
    col_pct = c(freq_Male)
  ) %>%
    gt::cols_merge_n_pct(
    col_n = c(n_Female),
    col_pct = c(freq_Female)
  ) %>%
    #special format for rows 2,3,34 with CI
  gt::text_transform(
    locations = gt::cells_body(columns = c(n_Total),
                           rows = rows_ci),
    fn = function(x) {
      paste0(sprintf("%.1f", tab1_pre$value_Total[rows_ci]), " (", sprintf("%.1f", tab1_pre$lci_Total[rows_ci]), " to ", sprintf("%.1f", tab1_pre$uci_Total[rows_ci]), ")")
    }
  ) %>%
  gt::text_transform(
    locations = gt::cells_body(columns = c(n_Male),
                           rows = rows_ci),
    fn = function(x) {
      paste0(sprintf("%.1f", tab1_pre$value_Male[rows_ci]), " (", sprintf("%.1f", tab1_pre$lci_Male[rows_ci]), " to ", sprintf("%.1f", tab1_pre$uci_Male[rows_ci]), ")")
    }
  ) %>%
  gt::text_transform(
    locations = gt::cells_body(columns = c(n_Female),
                           rows = rows_ci),
    fn = function(x) {
      paste0(sprintf("%.1f",tab1_pre$value_Female[rows_ci]), " (", sprintf("%.1f", tab1_pre$lci_Female[rows_ci]), " to ", sprintf("%.1f", tab1_pre$uci_Female[rows_ci]), ")")
    }
    ) %>%
      #special format for row 30 (copy from value col and round to 1 digit)
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Total),
                                   rows = c(30)),
        fn = function(x) {
          sprintf("%.1f", tab1_pre$value_Total[c(30)])
          }
        ) %>%
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Male),
                                   rows = c(30)),
        fn = function(x) {
          sprintf("%.1f", tab1_pre$value_Male[c(30)])
          }
        ) %>%
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Female),
                                   rows = c(30)),
        fn = function(x) {
          sprintf("%.1f", tab1_pre$value_Female[c(30)])
          }
        ) %>%
      #special format for row 31 (copy from value col and round to 0 digits)
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Total),
                                   rows = c(31)),
        fn = function(x) {
          paste(round(tab1_pre$value_Total[c(31)], 0))
          }
        ) %>%
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Male),
                                   rows = c(31)),
        fn = function(x) {
          paste(round(tab1_pre$value_Male[c(31)], 0))
          }
        ) %>%
      gt::text_transform(
        locations = gt::cells_body(columns = c(n_Female),
                                   rows = c(31)),
        fn = function(x) {
          paste(round(tab1_pre$value_Female[c(31)], 0))
          }
        ) %>%
   #make header
  gt::tab_header(
    title = paste0("Table 1 Characteristics of ", if(en_gb){"analysed"}else{"analyzed"}," study population with primary lung cancer"),
    subtitle = paste0("Number of patients with primary index lung cancer, ",if(en_gb){"age-standardised"}else{"age-standardized"}," incidence rates of primary lung cancer (ASIR), follow-up time, characteristics of patients included in main analysis with at least 6 months of survival and absolute incidence of second primary cancer (SPC) by sex")) %>%
  #footnotes
   gt::tab_footnote(
     footnote = "after exclusion by age and morphology unusual, benign, sarcoma",
     locations = gt::cells_column_labels(columns = category)
  ) %>%
  gt::tab_footnote(
    footnote = "DCO cases and cases with unknown or less than 6 months follow-up time are excluded from further analyses.",
    locations = gt::cells_body(
      columns = c(category),
      rows = c(5, 6, 11))
  ) %>%
  tab_source_note(
    source_note = paste0(if(en_gb){"ASIR age-standardised incidence rate based on the European Standard Population 1976 for the population aged 30+; "}else{"ASIR age-standardized incidence rate based on the European Standard Population 1976 for the population aged 30+; "}, "DCO death-certificate only; ", "FU follow-up; ", "LC primary lung cancer; ", "NSCLC non-small-cell lung carcinoma; ", "PYAR person-years at risk; ", "SPC second primary cancer")
  ) %>% 
  #special formatting
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(2)) %>% # reduce row height
  ##column width
  gt::cols_width(
    category ~ px(230),
    n_Total ~ px(150),
    n_Male ~ px(150),
    n_Female ~ px(150)
    ) 

#save table
tab1_gt %>%
  ##column width
  gt::cols_width(
    category ~ px(350),
    n_Total ~ px(200),
    n_Male ~ px(200),
    n_Female ~ px(200)
    ) %>%
  gt::gtsave(
    file.path(output_dir_tables, "tab1.png"),
    vwidth = 1000, expand = 10
  )

#save as rtf
tab1_gt %>%
   gt::tab_header(title = NULL, subtitle = NULL) %>%
  #gt::tab_source_note(source_note = NULL) %>%  #not working in gt v0.3
  gt::tab_options(#table.width = 900,
                  footnotes.marks = "letters") %>%
  gt::gtsave(
    file.path(output_dir_tables, "tab1.rtf")
  )

#print table
tab1_gt

```

```{r}
#test in table
#total PYAR unchanged
testthat::expect_equal(
  tab1 %>% filter(category == "Sum of PYAR") %>% pull(all_of("value_Total")),
  347949
)

#test that number of excluded cases makes sense

tab1_diff <- 
  #total minus DCO minus 1-6 months, minus unknown FU
  (tab1 %>% filter(variable == "Patients with primary LC" & category == "n (% of Total)") %>% pull(all_of("n_Total"))) - 
  (tab1 %>% filter(variable == "Follow-up time" & category == "DCO or less than 1 month") %>% pull(all_of("n_Total"))) - 
    (tab1 %>% filter(variable == "Follow-up time" & category == "1-6 months") %>% pull(all_of("n_Total"))) - 
  (tab1 %>% filter(variable == "Follow-up time" & category == "Unknown") %>% pull(all_of("n_Total")))
  
  

testthat::expect_equal(
  tab1 %>% filter(variable == "Patients with primary LC [n (% of total)]" & category == "n (% of Total)") %>% pull(all_of("n_Total")),
  tab1_diff
)

```


### Case-number when including all cases independent of FU time and all LC DCO (flow-chart)

- Complete database (ZfKD all regions, all tumors)
  - n = 4,736,067 patients
- S0: all patients with primary lung cancer (C33-C34)
  - n = `r nrow_d0`
- S1: LC diagnosis between 2000 and 2013
  - n = `r nrow_d2_s1_date`
- S2: in regions that have registries with acceptable data quality (GEKID recommended)
  - n = `r nrow_d2_s2_reg`
- S3: LC diagnosis at age 30 to 99
  - n = `r nrow_d2_s3_age`  
- S6: morphology of LC not unusual, benign, sarcoma 
  - n = `r nrow_d2_s4_morph`



## SIR calculations

### Calculate SIRs by sex and cancer site


```{r}
#run sir calculations
sir_d1_results <- d1_zlung_wide %>%
  #count all SPC in data set
  mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  msSPChelpR::sir_byfutime(., dattype = "zfkd", 
                           ybreak_vars = c("SEX.1", "p_agefcgroup", "p_yearfcgroup", "p_region_recode",
                                           "t_sublung.1", "t_grading.1", "PTO.1"),
                           xbreak_var = "none", futime_breaks = c(0.5, 1, 5, 10, Inf),
                           count_var = "count_spc", refrates_df = rates_dco_imp,
                           calc_total_row = TRUE,  calc_total_fu = TRUE,
                           region_var = "p_region_recode", age_var = "t_agegroupdiag.1", sex_var = "SEX.1", 
                           year_var = "t_singleyeardiag.1", race_var = NULL, site_var = "t_icdcat.2", 
                           futime_var = "p_futimeyrs",
                           alpha = 0.05
                           )

#add check where fu_time breaks only start at 6 months
sir_d1_results_check <- d1_zlung_wide %>%
  #count all SPC in data set
  mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  msSPChelpR::sir_byfutime(., dattype = "zfkd", 
                           ybreak_vars = c("SEX.1", "p_agefcgroup", "p_yearfcgroup", "p_region_recode",
                                           "t_sublung.1", "t_grading.1", "PTO.1"),
                           xbreak_var = "none", futime_breaks = c(0, 0.5, 1, 5, 10, Inf),
                           count_var = "count_spc", refrates_df = rates_dco_imp,
                           calc_total_row = TRUE,  calc_total_fu = TRUE,
                           region_var = "p_region_recode", age_var = "t_agegroupdiag.1", sex_var = "SEX.1", 
                           year_var = "t_singleyeardiag.1", race_var = NULL, site_var = "t_icdcat.2", 
                           futime_var = "p_futimeyrs",
                           alpha = 0.05
                           )

```


```{r}
#add additional grouping of site_var in sir results
sir_d1_results <- sir_d1_results %>%
  cr_site_vars_smoke_tt(., site_var = "t_site", en_gb = en_gb)

```


### Determine sites for which to present detailed information in main tables and figures

All sites that have at least 100 observed or 100 expected cases are presented in the main analyses (Table 2, Figure 1). SIRs for all other sites are presented in the supplement.

```{r}
#by sex
sir_sum_d1_icdgroup_a <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) 
#totals 
sir_sum_d1_icdgroup_b <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) 

sir_sum_d1_icdgroup <- bind_rows(sir_sum_d1_icdgroup_a, sir_sum_d1_icdgroup_b) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(., sitegroup_var = "t_site", en_gb = en_gb)

rm(sir_sum_d1_icdgroup_a, sir_sum_d1_icdgroup_b)


#determine site with more than 100 observed or 100 expected cases 
names_icdgroup_sel <- sir_sum_d1_icdgroup %>% 
  filter(fu_time == "Total 0.5 to Inf years") %>%
  filter((sex == "Total" & (expected >= 100| observed >= 100))) %>%
  select(t_site, t_smokeiarc, sex, sir, observed, expected, sir_lci, sir_uci) %>%
  distinct(t_site) %>%
  pull() %>%
  as.character()



#get ICD site groups with more than 100 SPC cases in total of both sexes
tab1s_groups <- d1_zlung_wide %>%
    filter(p_spc == "SPC developed") %>%
    group_by(t_icdgroup_pubdet.2) %>%
    summarize(n = n()) %>%
  filter(n > 100) %>% 
  distinct(t_icdgroup_pubdet.2) %>% 
  unlist() %>% 
  unname()

#see whether most frequent sites and selected sites differ
sort(tab1s_groups) == sort(names_icdgroup_sel)

```
### Highest SIR for all sexes, males and females

```{r}
#highest SIR for all sexes
res_highest_sir_all <- sir_sum_d1_icdgroup %>% 
  filter(sex ==  "Total") %>%
  filter(observed >= 100 | expected >= 100) %>%
  filter(fu_time == "Total 0.5 to Inf years") %>%
  select(t_site, t_smokeiarc, sex, sir, observed, expected, sir_lci, sir_uci) %>%
  arrange(desc(sir)) %>%
  head(5)

res_highest_sir_all

#highest SIR for men
res_highest_sir_male <- sir_sum_d1_icdgroup %>% 
  filter(sex ==  "Male") %>%
  filter(observed >= 70 | expected >= 70) %>%
  filter(fu_time == "Total 0.5 to Inf years") %>%
  select(t_site, t_smokeiarc, sex, sir, observed, expected, sir_lci, sir_uci) %>%
  arrange(desc(sir)) %>%
  head(5)

res_highest_sir_male

#highest SIR for women
res_highest_sir_female <- sir_sum_d1_icdgroup %>% 
  filter(sex ==  "Female") %>%
  filter(observed >= 30 | expected >= 30) %>%
  filter(fu_time == "Total 0.5 to Inf years") %>%
  select(t_site, t_smokeiarc, sex, sir, observed, expected, sir_lci, sir_uci) %>%
  arrange(desc(sir)) %>%
  head(5)

res_highest_sir_female

res_c32_m_sir <- sir_sum_d1_icdgroup %>% filter(t_site == "Larynx (C32)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c32_m_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == "Larynx (C32)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c32_m_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == "Larynx (C32)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)
res_c10_m_sir <- sir_sum_d1_icdgroup %>% filter(t_site == "Pharynx (C10-C14)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c10_m_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == "Pharynx (C10-C14)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c10_m_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == "Pharynx (C10-C14)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)
res_c01_m_sir <- sir_sum_d1_icdgroup %>% filter(t_site == "Oral cavity (C01-C06)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c01_m_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == "Oral cavity (C01-C06)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c01_m_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == "Oral cavity (C01-C06)" & sex == "Male" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)

res_c15_f_sir <- sir_sum_d1_icdgroup %>% filter(t_site == icdgroup_c15_code & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c15_f_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == icdgroup_c15_code & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c15_f_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == icdgroup_c15_code & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)
res_c65_f_sir <- sir_sum_d1_icdgroup %>% filter(t_site == "Urinary tract (C65-C68)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c65_f_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == "Urinary tract (C65-C68)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c65_f_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == "Urinary tract (C65-C68)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)
res_c64_f_sir <- sir_sum_d1_icdgroup %>% filter(t_site == "Kidney (C64)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir) %>% format(., nsmall = 2)
res_c64_f_sir_l <- sir_sum_d1_icdgroup %>% filter(t_site == "Kidney (C64)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_lci) %>% format(., nsmall = 2)
res_c64_f_sir_u <- sir_sum_d1_icdgroup %>% filter(t_site == "Kidney (C64)" & sex == "Female" & fu_time == "Total 0.5 to Inf years") %>% pull(sir_uci) %>% format(., nsmall = 2)

```

The relative incidence compared to the general male population was particularly high for laryngeal cancers (aggregated SIR over all follow-up times = `r res_c32_m_sir`; 95% CI: `r res_c32_m_sir_l`--`r res_c32_m_sir_u`), pharyngeal cancers (SIR = `r res_c10_m_sir`; 95% CI: `r res_c10_m_sir_l`--`r res_c10_m_sir_u`) and cancers of the oral cavity (SIR = `r res_c01_m_sir`; 95% CI: `r res_c01_m_sir_l`--`r res_c01_m_sir_u`). 
For females overall SIRs were particularly high for if(en_gb){"oesophagus"}else{"esophagus"} (SIR = `r res_c15_f_sir`; 95% CI: `r res_c15_f_sir_l`--`r res_c15_f_sir_u`), urinary tract (SIR = `r res_c65_f_sir`; 95% CI: `r res_c65_f_sir_l`--`r res_c65_f_sir_u`) and kidney (SIR = `r res_c64_f_sir`; 95% CI: `r res_c64_f_sir_l`--`r res_c64_f_sir_u`).



### Figure 1

#### Prepare Figure 1: Calculate Rates

```{r}
#preparations
#first summarize results by ICD group
sir_sum_fig1_icdgroup <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(., sitegroup_var = "t_site", en_gb = en_gb)

#second summarize results by smoking-related IARC
sir_sum_fig1_smokerel <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sir_sum_fig1 <- rbind(sir_sum_fig1_icdgroup, sir_sum_fig1_smokerel)


#make smoking related appear first
sir_sum_fig1$t_smokeiarc  <- relevel(sir_sum_fig1$t_smokeiarc, "smoking-related IARC")
#make sum categories appear fist
sir_sum_fig1$t_site  <- relevel(sir_sum_fig1$t_site, "smoking-related IARC")
sir_sum_fig1$t_site  <- relevel(sir_sum_fig1$t_site, "other cancer")

rm(sir_sum_fig1_icdgroup, sir_sum_fig1_smokerel)
  
```

#### Prepare Figure 1: Plot single sites

```{r}

fig1_max_sir <- 5.5

fig1_site_row1 <- c("Oral cavity (C01-C06)",
                    "Pharynx (C10-C14)",
                    icdgroup_c15_code)

fig1_site_row2 <- c("Stomach (C16)",
                    "Colorectum (C18-C20)",
                    "Liver (C22)")

fig1_site_row3 <- c("Pancreas (C25)",
                    "Larynx (C32)",
                    "Lung*** (C33-C34)",
                    "Kidney (C64)",
                    "Urinary tract (C65-C68)")


fig1_site_row5 <- c("Prostate (C61)",
                    "Skin melanoma (C43)",
                    "Breast (C50)")

fig1_site_row6 <- c("Non-Hodgkin lymphoma (C82-C88)")

fig1_row1_splot <- sir_sum_fig1 %>%
  plot_sir_byfutime(., sites_to_plot = fig1_site_row1, y_lim = fig1_max_sir
                    , vlab_x_off = -0.38, vlab_y_pos = 0.5, vlab_y_diff = .1
                    )

fig1_row2_splot <- sir_sum_fig1 %>%
  plot_sir_byfutime(., sites_to_plot = fig1_site_row2, y_lim = fig1_max_sir
                    , vlab_x_off = -0.38)

fig1_row3_splot <- sir_sum_fig1 %>%
   #add note to Lung cancer SIR
  dplyr::mutate(t_site = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung*** (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  plot_sir_byfutime(., sites_to_plot = fig1_site_row3, y_lim = fig1_max_sir
                    , vlab_x_off = -0.38, vlab_y_pos = 0.47)



fig1_row5_splot <- sir_sum_fig1 %>%
  plot_sir_byfutime(., sites_to_plot = fig1_site_row5, y_lim = fig1_max_sir
                    , vlab_x_off = -0.38, vlab_y_pos = 0.47)

fig1_row6_splot <- sir_sum_fig1 %>%
  plot_sir_byfutime(., sites_to_plot = fig1_site_row6, y_lim = fig1_max_sir
                    , vlab_x_off = -0.38)


fig1_row1_splot
```

#### Prepare Figure 1: Plot grouped sites smoking related

```{r}

pd <- position_dodge(-0.35)
timecats_to_plot <- c("6-12 months", "1-5 years", "5-10 years", "Total")

fig1_sum_smo_splot <- 
  sir_sum_fig1 %>%
  #filter for most frequent sites
    filter(t_site %in% "smoking-related IARC") %>%
    #for small case numbers,create flag 
    mutate(fewcases = case_when(expected >= 5 ~ "many",
                                TRUE ~ "few"),
           sir = case_when(expected >= 5 ~ sir,
                           TRUE ~ 0.3),
           sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                               expected >= 5 ~ sir_lci,
                               TRUE ~ 0.3),
           sir_uci = case_when(expected >= 5 ~ sir_uci,
                               TRUE ~ 0.3)) %>%
    #rename Total fu_time to make label shorter
    mutate(fu_time = recode(fu_time, "Total 0.5 to Inf years" = "Total")) %>%
    #rename Total t_site
    mutate(t_site := recode(t_site, 
                           "smoking-related IARC" = "Smoking-related cancers (*)",
                           "other cancer" = "Other cancers (**)"
                           )) %>%
  #start ggplot
    ggplot(data =., aes(x=fu_time, y=sir, colour=sex, group=sex, shape = fewcases)) + 
    geom_errorbar(aes(ymin=sir_lci, ymax=sir_uci), colour="black", width=.2, position=pd) +
    geom_point(position=pd, size = 4) + 
    #add value labels for males
    geom_text(
      aes(x=fu_time, y=.5, colour=sex, group=sex,
          label=ifelse(
            (fu_time == "Total" & sex == "Male" & sir!=0.3), paste0("Overall SIR male = ",format(sir, nsmall = 2), " (", format(sir_lci, nsmall = 2), "-", format(sir_uci, nsmall = 2), ")"), "")),
      nudge_x = .5, size = 4, hjust = 1) +
    #add value labels for females
    geom_text(
      aes(x=fu_time, y=.4, colour=sex, group=sex,
          label=ifelse(
            (fu_time == "Total" & sex == "Female" & sir!=0.3), paste0("Overall SIR female = ",format(sir, nsmall = 2), " (", format(sir_lci, nsmall = 2), "-", format(sir_uci, nsmall = 2), ")"), "")),
      nudge_x = .5, size = 4, hjust = 1) +
    #define estimate categories (shape)
    scale_shape_manual(name="Estimate", 
                       values = c(many = 21, few = 4),                     # 21 is filled circle
                       breaks=c("many", "few"), 
                       labels=c("SIR", "no estimate (<5 expected cases)")) + 
    #define sex categories (group)
    scale_colour_hue(name="Sex",    # Legend label, use darker colors
                     breaks=c("Male", "Female"),
                     labels=c("Male", "Female"),
                     l=40) +                    # Use darker colors, lightness=40 
    geom_hline(yintercept = 1) +
    #y axis - make log scale (current scaling depends on minimum value set above for few cases = few --> sir == 0.3)
    scale_y_log10(limits = c(0.3, fig1_max_sir)) +
    #labels
    labs(title = "Smoking-related cancers") +
    ylab("Risk of SPC (SIR)") + 
    xlab("Follow-up time after LC") +
    #x axis - select wanted categories for x-axis
    xlim(timecats_to_plot) +
    guides(x = guide_axis(n.dodge = 2)) +
    #faceting
    facet_grid( ~ t_site) +
    theme_bw() + 
    theme(legend.position="none",
          title = element_text(size = rel(1)),
          plot.caption = element_blank(),
          axis.title.y = element_text(size = rel(1.2)),
          axis.text.y = element_text(size = rel(1.5)),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size = rel(1.5))
          )

fig1_sum_smo_splot
```

#### Prepare Figure 1: Plot grouped sites other

```{r}
fig1_sum_oth_splot <- 
  sir_sum_fig1 %>%
  #filter for most frequent sites
    filter(t_site %in% "other cancer") %>%
    #for small case numbers,create flag 
    mutate(fewcases = case_when(expected >= 5 ~ "many",
                                TRUE ~ "few"),
           sir = case_when(expected >= 5 ~ sir,
                           TRUE ~ 0.3),
           sir_lci = case_when(expected >= 5 ~ sir_lci,
                               TRUE ~ 0.3),
           sir_uci = case_when(expected >= 5 ~ sir_uci,
                               TRUE ~ 0.3)) %>%
    #rename Total fu_time to make label shorter
    mutate(fu_time = recode(fu_time, "Total 0.5 to Inf years" = "Total")) %>%
    #rename Total t_site
    mutate(t_site := recode(t_site, 
                           "smoking-related IARC" = "Smoking-related cancers (*)",
                           "other cancer" = "Other cancers (**)"
                           )) %>%
  #start ggplot
    ggplot(data =., aes(x=fu_time, y=sir, colour=sex, group=sex, shape = fewcases)) + 
    geom_errorbar(aes(ymin=sir_lci, ymax=sir_uci), colour="black", width=.2, position=pd) +
    geom_point(position=pd, size = 4) + 
    #add value labels for males
    geom_text(
      aes(x=fu_time, y=.5, colour=sex, group=sex,
          label=ifelse(
            (fu_time == "Total" & sex == "Male" & sir!=0.3), paste0("Overall SIR male = ",format(sir, nsmall = 2), " (", format(sir_lci, nsmall = 2), "-", format(sir_uci, nsmall = 2), ")"), "")),
      nudge_x = .5, size = 4, hjust = 1) +
    #add value labels for females
    geom_text(
      aes(x=fu_time, y=.4, colour=sex, group=sex,
          label=ifelse(
            (fu_time == "Total" & sex == "Female" & sir!=0.3), paste0("Overall SIR female = ",format(sir, nsmall = 2), " (", format(sir_lci, nsmall = 2), "-", format(sir_uci, nsmall = 2), ")"), "")),
      nudge_x = .5, size = 4, hjust = 1) +
    #define estimate categories (shape)
    scale_shape_manual(name="Estimate", 
                       values = c(many = 21, few = 4),                     # 21 is filled circle
                       breaks=c("many", "few"), 
                       labels=c("SIR", "no estimate (<5 expected cases)")) + 
    #define sex categories (group)
    scale_colour_hue(name="Sex",    # Legend label, use darker colors
                     breaks=c("Male", "Female"),
                     labels=c("Male", "Female"),
                     l=40) +                    # Use darker colors, lightness=40 
    geom_hline(yintercept = 1) +
    #y axis - make log scale (current scaling depends on minimum value set above for few cases = few --> sir == 0.3)
    scale_y_log10(limits = c(0.3, fig1_max_sir)) +
    #labels
    labs(title = "Other cancers") +
    ylab("Risk of SPC (SIR)") + 
    xlab("Follow-up time after LC") +
    #x axis - select wanted categories for x-axis
    xlim(timecats_to_plot) +
    guides(x = guide_axis(n.dodge = 2)) +
    #faceting
    facet_grid( ~ t_site) +
    theme_bw() + 
    theme(legend.position="none",
          title = element_text(size = rel(1)),
          plot.caption = element_blank(),
          axis.title.y = element_text(size = rel(1.2)),
          axis.text.y = element_text(size = rel(1.5)),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size = rel(1.5))
          )

fig1_sum_oth_splot
```

#### Figure 1: Put parts together

```{r, warning=FALSE}
#design layout for plots; # stands for empty region
fig1_layout  <- "
AAAAAAAACCCCCCCCCCCC
AAAAAAAACCCCCCCCCCCC
AAAAAAAACCCCCCCCCCCC
AAAAAAAACCCCCCCCCCCC
AAAAAAAADDDDDDDDDDDD
AAAAAAAADDDDDDDDDDDD
AAAAAAAADDDDDDDDDDDD
AAAAAAAADDDDDDDDDDDD
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
EEEEEEEEEEEEEEEEEEEE
####################
BBBBBBBBGGGGGGGGGGGG
BBBBBBBBGGGGGGGGGGGG
BBBBBBBBGGGGGGGGGGGG
BBBBBBBBGGGGGGGGGGGG
BBBBBBBBHHHH########
BBBBBBBBHHHH########
BBBBBBBBHHHH########
BBBBBBBBHHHH########
"

fig1 <- wrap_plots(A = fig1_sum_smo_splot,
                   B = fig1_sum_oth_splot,
                   C = fig1_row1_splot,
                   D = fig1_row2_splot,
                   E = fig1_row3_splot,
                   G = fig1_row5_splot,
                   H = fig1_row6_splot, 
                   design = fig1_layout) +
    #create common legend and axis labels
    theme(legend.position="bottom") +
    #Label Title and Caption
  plot_annotation(
        title = element_text(paste0("Figure 1: Incidence of SPC in smoking-related and other cancer sites (n=", format(nrow(d1_zlung_wide), big.mark = ","), ")")),
    caption = element_text(
    "Notes: SIR is only calculated for strata with at least 5 expected cases. Numeric SIR values are given for total follow-up time (6 months to 10+ years). 
            Showing all sites with at least 70 observed or expected cases for males or 30 observed or expected cases for females for total follow-up time.
            *  Total for \"Smoking-related cancers\" includes all SPC with locations C01-C06, C10-C14 C15-16, C18-20, C22, C25, C30, C31, C32, C33-34, C53, C56, C64, C65-68, C92.
            ** Total for \"Other cancers\" includes all other locations.
            *** SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section)."),
  theme = theme(plot.caption = element_text(hjust = 0), #left alignment of caption
                plot.title = element_text(size = 16))
  )  

#print figure
fig1

#save figure
fig1 %>%
  ggsave(filename = file.path(output_dir_tables, "fig1_title.png"),
         width = 10, height = 13)


```

```{r, warning=FALSE}
#save figure 1 without headings and captions for Journal

fig1_nol <- wrap_plots(A = fig1_sum_smo_splot,
                   B = fig1_sum_oth_splot,
                   C = fig1_row1_splot,
                   D = fig1_row2_splot,
                   E = fig1_row3_splot,
                   G = fig1_row5_splot,
                   H = fig1_row6_splot, 
                   design = fig1_layout) +
    #create common legend and axis labels
    theme(legend.position="bottom") 

#save figure
fig1_nol %>%
  ggsave(filename = file.path(output_dir_tables, "fig1.png"),
         width = 10, height = 12.2)


```


### Table 2


#### Prepare Table 2

```{r}
#preparations
#first summarize results by smoking group
sir_sum_tab2_smokegroups <- sir_d1_results %>%
    filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smokeiarc as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    )  %>%
    #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                     ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) %>%
  dplyr::arrange(desc(yvar_label), desc(t_smokeiarc))
  
#second summarize by grouped ICD-Site
sir_sum_tab2_sites <- sir_d1_results %>%
    filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_icdgroup_pubdet as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  cr_icdgroup_vars_smoke_tt(., "t_site", en_gb = en_gb) %>%
  select(-t_smoke_barclay, -t_smoke_boakye)

#third calculate totals
sir_sum_tab2_totals <- sir_d1_results %>%
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = TRUE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_site",
                                    alpha = 0.05
                                    ) 

tab2 <- bind_rows(sir_sum_tab2_totals, sir_sum_tab2_sites, sir_sum_tab2_smokegroups) %>%
  select(-age, -region, -sex, -year) %>%
  #for sites, copy values to yvar_label
  mutate(yvar_label = case_when(yvar_name == "total_var" & t_site != "Total" ~ t_site,
                                TRUE ~ yvar_label)) %>%
  #unknown categories
  mutate(yvar_label = recode(yvar_label, "zzz_NA_explicit" = "Unknown")) %>%
  #for cancer related grouping, make gender clear
  mutate(yvar_label = case_when(yvar_label == "other cancer" & t_site == "other cancer" ~ "Other cancers - Total",
                                yvar_label == "Female" & t_site == "other cancer" ~ "Other cancers - Female",
                                yvar_label == "Male" & t_site == "other cancer" ~ "Other cancers - Male",
                                yvar_label == "smoking-related IARC" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Total",
                                yvar_label == "Female" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Female",
                                yvar_label == "Male" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Male",
                                TRUE ~ yvar_label))  %>%
  #change labels for grading
  dplyr::mutate(yvar_label = 
                  case_when(yvar_name == "t_grading.1" & yvar_label == "1" ~ "G1 well differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "2" ~ "G2 moderately differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "3" ~ "G3 poorly differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "4" ~ "G4 undifferentiated",
                            yvar_name == "t_grading.1" & yvar_label == "Unknown" ~ "Unknown grading",
                            TRUE ~ yvar_label)) %>%
  #remove Surgery information 
  dplyr::filter(yvar_name != "PTO.1")
  

#test calculations for correctness
testthat::expect_equal(
  tab2 %>% filter(yvar_label == "Overall" & yvar_name == "total_var" & t_site == "Total") %>% pull(all_of("10+ years__n_base")),
  tab1 %>% filter(category == "10+ years") %>% pull(all_of("n_Total"))
)

rm(sir_sum_tab2_sites, sir_sum_tab2_totals, sir_sum_tab2_smokegroups)


#additional filtering to remove number of rows
tab2_pre <- tab2 %>%
  #remove seldom sites from list
  dplyr::filter(t_site %in% c("Total", "other cancer", "smoking-related IARC")) %>%
  dplyr::filter(yvar_name != "t_grading.1")


```
#### Create single plots


```{r}
#parameters
x_min <- 0.6 #minimum for x-scale before log-transformation
x_max <- 3.1 #minimum for x-scale before log-transformation
lw <- 10     #width of standard line

#get categories for black total plots
tab2_names_yvar_t <- tab2_pre %>%
  filter(!(yvar_name == "SEX.1")) %>%
  pull(yvar_label) %>%
  as.character()

#get categories for turquoise male plots
tab2_names_yvar_m <- tab2_pre %>%
  filter(yvar_name == "SEX.1" & str_detect(yvar_label, "Male")) %>%
  pull(yvar_label) %>%
  as.character()

#get categories for turquoise male plots
tab2_names_yvar_f <- tab2_pre %>%
  filter(yvar_name == "SEX.1" & str_detect(yvar_label, "Female")) %>%
  pull(yvar_label) %>%
  as.character()

#first for total var
tab2_plot_t<- tab2_pre %>% 
  rename(sir = "Total 0.5 to Inf years__sir",
         sir_lci = "Total 0.5 to Inf years__sir_lci",
         sir_uci = "Total 0.5 to Inf years__sir_uci") %>%
  #change minimum and maximum values to have coherent plot across categories
  mutate(sir = case_when(sir < 0.3 ~ 0.01,
                         sir > 10 ~ 10,
                         TRUE ~ sir)) %>%
  mutate(sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                         sir_lci > 10 ~ 10,
                         TRUE ~ sir_lci)) %>%
  mutate(sir_uci = case_when(sir_uci < 0.3 ~ 0.3,
                         sir_uci > 10 ~ 10,
                         TRUE ~ sir_uci)) %>%
  #plot across all categories
  lapply(tab2_names_yvar_t, plot_sir_forest, 
         results_df = ., cat_var = yvar_label, x_var = sir, x_lci_var = sir_lci, x_uci_var = sir_uci,
         show_site = FALSE, show_scale = FALSE, color = "black", x_min = x_min, x_max = x_max, line_width = lw)

names(tab2_plot_t) <- tab2_names_yvar_t

#males
#females
tab2_plot_m<- tab2_pre %>% 
  rename(sir = "Total 0.5 to Inf years__sir",
         sir_lci = "Total 0.5 to Inf years__sir_lci",
         sir_uci = "Total 0.5 to Inf years__sir_uci") %>%
  #change minimum and maximum values to have coherent plot across categories
  mutate(sir = case_when(sir < 0.3 ~ 0.01,
                         sir > 10 ~ 10,
                         TRUE ~ sir)) %>%
  mutate(sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                         sir_lci > 10 ~ 10,
                         TRUE ~ sir_lci)) %>%
  mutate(sir_uci = case_when(sir_uci < 0.3 ~ 0.3,
                         sir_uci > 10 ~ 10,
                         TRUE ~ sir_uci)) %>%
  #plot across all categories
  lapply(tab2_names_yvar_m, plot_sir_forest, 
         results_df = ., cat_var = yvar_label, x_var = sir, x_lci_var = sir_lci, x_uci_var = sir_uci,
         show_site = FALSE, show_scale = FALSE, color = colors_2_sex["Male"], x_min = x_min, x_max = x_max, line_width = lw)

names(tab2_plot_m) <- tab2_names_yvar_m

#females
tab2_plot_f<- tab2_pre %>% 
  rename(sir = "Total 0.5 to Inf years__sir",
         sir_lci = "Total 0.5 to Inf years__sir_lci",
         sir_uci = "Total 0.5 to Inf years__sir_uci") %>%
  #change minimum and maximum values to have coherent plot across categories
  mutate(sir = case_when(sir < 0.3 ~ 0.01,
                         sir > 10 ~ 10,
                         TRUE ~ sir)) %>%
  mutate(sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                         sir_lci > 10 ~ 10,
                         TRUE ~ sir_lci)) %>%
  mutate(sir_uci = case_when(sir_uci < 0.3 ~ 0.3,
                         sir_uci > 10 ~ 10,
                         TRUE ~ sir_uci)) %>%
  #plot across all categories
  lapply(tab2_names_yvar_f, plot_sir_forest, 
         results_df = ., cat_var = yvar_label, x_var = sir, x_lci_var = sir_lci, x_uci_var = sir_uci,
         show_site = FALSE, show_scale = FALSE, color = colors_2_sex["Female"], x_min = x_min, x_max = x_max, line_width = lw)

names(tab2_plot_f) <- tab2_names_yvar_f

tab2_plots <- c(tab2_plot_t, tab2_plot_m, tab2_plot_f)

tab2_plots[["Overall"]]
tab2_plots[["Male"]]
tab2_plots[["Female"]]
```


#### Table 2: Put parts together

```{r, warning = TRUE}


##create table with gt
tab2_gt <- tab2_pre %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "t_site", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", "t_smokeiarc", "t_smoke",
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table 2 Relative incidence of SPC stratified by follow-up time",
    subtitle = paste0("Number of observed and expected SPC in main analysis (n=", format(nrow(d1_zlung_wide), big.mark = ","), ") and ", if(en_gb){"standardised incidence ratios "}else{"standardized incidence ratios "}, "overall, by sex, by index lung cancer diagnosis and for grouped smoking-related and grouped other cancers, stratified by follow-up time.")
    )%>%
      gt::tab_stubhead(
    label = "All sites combined"
       ) %>%
  #rename columns
    gt::cols_label(
      "Total 0.5 to Inf years__observed" = "O",
      "Total 0.5 to Inf years__expected" = "E",
      "Total 0.5 to Inf years__sir" = "SIR",
      "Total 0.5 to Inf years__sir_lci" = "95% CI",
      "Total 0.5 to Inf years__pyar" = "PYAR",
      "Total 0.5 to Inf years__n_base" = "N",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "All sites combined"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total",
    columns = all_of(c(
     "Total 0.5 to Inf years__observed",
      "Total 0.5 to Inf years__expected",
      "Total 0.5 to Inf years__sir",
      "Total 0.5 to Inf years__sir_lci",
      "Total 0.5 to Inf years__pyar",
     "Total 0.5 to Inf years__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
  #make row groups
  gt::tab_row_group(
    label = "Site of SPC",
    rows = (t_site == "other cancer" | t_site == "smoking-related IARC")
  ) %>%
    gt::tab_row_group(
    label = "Histology of LC",
    rows = yvar_name == "t_sublung.1"
    ) %>%
    gt::tab_row_group(
    label = "Regional cancer registry",
    rows = yvar_name == "p_region_recode"
    ) %>%
    gt::tab_row_group(
    label = "Year of LC diagnosis",
    rows = yvar_name == "p_yearfcgroup"
    ) %>%
    gt::tab_row_group(
    label = "Age at LC diagnosis",
    rows = yvar_name == "p_agefcgroup"
    ) %>%
    gt::tab_row_group(
    label = "",
    rows = c(1:3)
    ) %>%
  #column formatting
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "expected")),
    decimals = 0
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "FU follow-up; ", "LC primary lung cancer; ", "NSCLC non-small-cell lung carcinoma; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_stubhead(),
      cells_row_groups(groups = c("Site of SPC")),
      cells_column_labels(ends_with(c("sir", "yvar_label"))), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(1),        # reduce row height
                  row_group.padding = px(3),        # reduce row height
                  row.striping.include_stub = TRUE) %>% # striping
  ##column width
  gt::cols_width(
    yvar_label ~ px(190),
    ends_with("_sir") ~ px(45),
    ends_with("_sir_lci") ~ px(70),
    ends_with("_observed") ~ px(40),
    ends_with("_expected") ~ px(40),
    ends_with("_pyar") ~ px(55),
    ends_with("_n_base") ~ px(50)
    ) 

#save table
tab2_gt %>%
  ##column width - gtsave need wider columns
  gt::cols_width(
    yvar_label ~ px(280),
    ends_with("_sir") ~ px(55),
    ends_with("_sir_lci") ~ px(85),
    ends_with("_observed") ~ px(45),
    ends_with("_expected") ~ px(45),
    ends_with("_pyar") ~ px(70),
    ends_with("_n_base") ~ px(65)
    ) %>%
  gt::gtsave(
    file.path(output_dir_tables, "tab2.png"),
    vwidth = 1400, expand = 10
  )
tab2_gt %>%
  #for Journal, remove Title, Subtitle, Footnotes
  gt::tab_header(title = NULL, subtitle = NULL) %>%
  #gt::tab_source_note(source_note = NULL) %>%  #not working in gt v0.3
  gt::tab_options(#table.width = 900,
                  footnotes.marks = "letters") %>%
  gt::gtsave(
    file.path(output_dir_tables, "tab2.rtf")
  )

#print table
tab2_gt

```

#### Table 2 inkl. plots: Put parts together

```{r, warning = TRUE}
#parameters of plot column
rh <- 25   #row height in px
ar <- 3    #aspect ratio


##create table with gt
tab2_gt_p <- tab2_pre %>%
  #new col for plots
  dplyr::mutate(plot_col = yvar_label) %>%
  dplyr::relocate(plot_col, .after = "yvar_label") %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "t_site", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", "t_smokeiarc", "t_smoke",
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table 2: Relative incidence of SPC stratified by follow-up time",
    subtitle = paste0("Number of observed and expected SPC in main analysis (n=", format(nrow(d1_zlung_wide), big.mark = ","), ") and ", if(en_gb){"standardised incidence ratios; "}else{"standardized incidence ratios; "}, "overall, by sex, by index lung cancer diagnosis and for grouped smoking-related and grouped other cancers, stratified by follow-up time.")
    )%>%
      gt::tab_stubhead(
    label = "All sites combined"
       ) %>%
  #rename columns
    gt::cols_label(
      "plot_col" = "",
      "Total 0.5 to Inf years__observed" = "O",
      "Total 0.5 to Inf years__expected" = "E",
      "Total 0.5 to Inf years__sir" = "SIR",
      "Total 0.5 to Inf years__sir_lci" = "95% CI",
      "Total 0.5 to Inf years__pyar" = "PYAR",
      "Total 0.5 to Inf years__n_base" = "N",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "All sites combined"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total",
    columns = all_of(c(
            "plot_col",
            "Total 0.5 to Inf years__observed",
            "Total 0.5 to Inf years__expected",
            "Total 0.5 to Inf years__sir",
            "Total 0.5 to Inf years__sir_lci",
            "Total 0.5 to Inf years__pyar",
            "Total 0.5 to Inf years__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
  #make row groups
  gt::tab_row_group(
    label = "Site of SPC",
    rows = (t_site == "other cancer" | t_site == "smoking-related IARC")
  ) %>%
     gt::tab_row_group(
    label = "Histology of LC",
    rows = yvar_name == "t_sublung.1"
    ) %>%
    gt::tab_row_group(
    label = "Regional cancer registry",
    rows = yvar_name == "p_region_recode"
    ) %>%
    gt::tab_row_group(
    label = "Year of LC diagnosis",
    rows = yvar_name == "p_yearfcgroup"
    ) %>%
    gt::tab_row_group(
    label = "Age at LC diagnosis",
    rows = yvar_name == "p_agefcgroup"
    ) %>%
    gt::tab_row_group(
    label = "",
    rows = c(1:3)
    ) %>%
  #column formatting
  ##plots
    text_transform(locations = gt::cells_body(columns = c(plot_col), row = 1),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 2),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 3),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 4),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 5),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 6),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 7),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 8),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 9),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 10),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 11),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 12),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 13),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 14),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 15),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 16),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 17),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 18),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 19),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 20),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 21),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 22),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 23),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 24),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 25),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 26),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 27),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 28),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 29),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 30),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 31),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 32),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 33),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 34),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 35),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 36),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(plot_col), row = 37),
                   fn = function(x) {tab2_plots[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
   ##numbers
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "expected")),
    decimals = 0
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "FU follow-up; ", "LC primary lung cancer; ", "NSCLC non-small-cell lung carcinoma; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_stubhead(),
      cells_row_groups(groups = c("Site of SPC")),
      cells_column_labels(ends_with(c("sir", "yvar_label"))), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(1),        # reduce row height
                  row_group.padding = px(5),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
tab2_gt_p %>%
  gt::gtsave(
    file.path(output_dir_tables, "tab2_plots.png"),
    vwidth = 1200, expand = 10
  )

```

In our analysis cohort `r round((tab2_pre %>% filter(yvar_label == "Smoking-related cancers - Total") %>% pull("Total 0.5 to Inf years__observed"))/(tab2_pre %>% filter(yvar_label == "Overall") %>% pull("Total 0.5 to Inf years__observed"))*100,1)`% of SPC after lung cancer develop in smoking-related sites when applying the IARC definition of smoking-relatedness, whereas only `r round((tab2_pre %>% filter(yvar_label == "Smoking-related cancers - Total") %>% pull("Total 0.5 to Inf years__expected"))/(tab2_pre %>% filter(yvar_label == "Overall") %>% pull("Total 0.5 to Inf years__expected"))*100,1)`% smoking-related cancers would have been expected if the distribution was equal to the general population. 


### Figure 2: SIRs smoking related vs. other cancers depending on definition

#### Prepare Fig2: Calculate SIRs needed

```{r}
#Calculate missing summaries using smokeiarc, smoke_barclay and smoke_boakye

sir_sum_fig2_smoke_iarc <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smokeiarc as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  mutate(smo_def = "IARC")

sir_sum_fig2_smoke_barc <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smoke_barclay as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smoke_barclay",
                                    alpha = 0.05
                                    ) %>%
  mutate(smo_def = "Barclay")

sir_sum_fig2_smoke_boak <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smoke_boakye as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smoke_boakye",
                                    alpha = 0.05
                                    ) %>%
  mutate(smo_def = "Boakye")

sir_sum_fig2 <- bind_rows(sir_sum_fig2_smoke_iarc, sir_sum_fig2_smoke_barc, sir_sum_fig2_smoke_boak) %>%
  mutate(sex = yvar_label,
         t_site_short = case_when(t_site == "other cancer" ~ "other",
                                  str_detect(t_site, "smoking-related")==TRUE ~ "smo")) %>%
  select(-age, -region, -year, -yvar_name, -yvar_label, -yvar_sort, -yvar_sort_levels)

rm(sir_sum_fig2_smoke_iarc, sir_sum_fig2_smoke_barc, sir_sum_fig2_smoke_boak)
```

#### Prepare Fig2: Calculate Smo-R

```{r}
sir_sum_fig2_smor <- sir_sum_fig2 %>%
  pivot_wider(names_from = t_site_short,
              values_from = tidyselect::all_of(c("sir", "sir_lci", "sir_uci", "observed", "expected", "pyar", "n_base", "t_site")),
              names_sep = ".") %>%
  mutate(sir.smor = msSPChelpR::sir_ratio(o1 = observed.other, o2 = observed.smo, e1 = expected.other, e2 = expected.smo) %>% round(., 2),
         sir_lci.smor = msSPChelpR:::sir_ratio_lci(o1 = observed.other, o2 = observed.smo, e1 = expected.other, e2 = expected.smo, alpha = 0.05) %>% round(., 2),     #enter correct formula here
         sir_uci.smor = msSPChelpR:::sir_ratio_uci(o1 = observed.other, o2 = observed.smo, e1 = expected.other, e2 = expected.smo, alpha = 0.05) %>% round(., 2)) %>%   # enter correct formula here
  tidyr::pivot_longer(
    -c(tidyselect::all_of(c("sex", "fu_time", "fu_time_sort", "smo_def"))),
    names_to = c(".value", "t_site_short"),
    names_pattern = "(.*)\\.(.*)",
    values_drop_na = TRUE
  ) %>%
  mutate(estimate_name = case_when(t_site_short == "smo" ~ "SIR for 🚬 cancer",
                              t_site_short == "other" ~ "SIR for other cancer",
                              t_site_short == "smor" ~ "Smo-R: Ratio SIR 🚬 vs. SIR other"),
         estimate_sort = case_when(t_site_short == "smo" ~ 1,
                              t_site_short == "other" ~ 2,
                              t_site_short == "smor" ~ 3),
         gr = case_when(t_site_short == "smo" & smo_def == "IARC"    ~ "smo_iarc",
                        t_site_short == "smo" & smo_def == "Boakye"  ~ "smo_boak",
                        t_site_short == "smo" & smo_def == "Barclay" ~ "smo_barc",
                        t_site_short == "other" & smo_def == "IARC"    ~ "oth_iarc",
                        t_site_short == "other" & smo_def == "Boakye"  ~ "oth_boak",
                        t_site_short == "other" & smo_def == "Barclay" ~ "oth_barc",
                        t_site_short == "smor" & smo_def == "IARC"    & sex == "Overall" ~ "smor_iarc_t",
                        t_site_short == "smor" & smo_def == "Boakye"  & sex == "Overall" ~ "smor_boak_t",
                        t_site_short == "smor" & smo_def == "Barclay" & sex == "Overall" ~ "smor_barc_t",
                        t_site_short == "smor" & smo_def == "IARC"    & sex == "Male"    ~ "smor_iarc_m",
                        t_site_short == "smor" & smo_def == "Boakye"  & sex == "Male"    ~ "smor_boak_m",
                        t_site_short == "smor" & smo_def == "Barclay" & sex == "Male"    ~ "smor_barc_m",                      
                        t_site_short == "smor" & smo_def == "IARC"    & sex == "Female"  ~ "smor_iarc_f",
                        t_site_short == "smor" & smo_def == "Boakye"  & sex == "Female"  ~ "smor_boak_f",
                        t_site_short == "smor" & smo_def == "Barclay" & sex == "Female"  ~ "smor_barc_f")) %>%
  mutate(gr = fct_relevel(gr, c("smo_iarc", "smo_boak", "smo_barc", "oth_iarc", "oth_boak", "oth_barc", "smor_iarc_t",
                                "smor_boak_t", "smor_barc_t", "smor_iarc_m", "smor_boak_m", "smor_barc_m", "smor_iarc_f",
                                "smor_boak_f","smor_barc_f")),
         gr_legend = case_when(gr == "smo_iarc"      ~ "SIR 🚬 (IARC def.)",
                               gr == "smo_boak"      ~ "SIR 🚬 (Boakye def.)",
                               gr == "smo_barc"      ~ "SIR 🚬 (Barclay def.)",
                               gr == "oth_iarc"      ~ "SIR other (IARC def.)",
                               gr == "oth_boak"      ~ "SIR other (Boakye def.)",
                               gr == "oth_barc"      ~ "SIR other (Barclay def.)",
                               gr == "smor_iarc_t"   ~ "Smo-R (IARC def.)",
                               gr == "smor_boak_t"   ~ "Smo-R (Boakye def.)",
                               gr == "smor_barc_t"   ~ "Smo-R (Barclay def.)",
                               gr == "smor_iarc_m"   ~ "Smo-R (IARC def.)",
                               gr == "smor_boak_m"   ~ "Smo-R (Boakye def.)",
                               gr == "smor_barc_m"   ~ "Smo-R (Barclay def.)",        
                               gr == "smor_iarc_f"   ~ "Smo-R (IARC def.)",
                               gr == "smor_boak_f"   ~ "Smo-R (Boakye def.)",
                               gr == "smor_barc_f"   ~ "Smo-R (Barclay def.)",
                               TRUE                  ~ "Error")) %>%
  mutate(gr = fct_relevel(gr, c("smo_iarc", "smo_boak", "smo_barc", "oth_iarc", "oth_boak", "oth_barc", "smor_iarc_t",
                                "smor_boak_t", "smor_barc_t", "smor_iarc_m", "smor_boak_m", "smor_barc_m", "smor_iarc_f",
                                "smor_boak_f","smor_barc_f")))

```


#### Prepare Fig2: Modify results

```{r}

sir_sum_fig2_tab <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years") %>%
  select(sex, smo_def, gr_legend, estimate_name, estimate_sort, t_site_short, sir, sir_lci, sir_uci) %>%
  pivot_wider(names_from = sex,
              values_from = tidyselect::all_of(c("sir", "sir_lci", "sir_uci")),
              names_sep = ".") %>%
  arrange(estimate_sort, desc(smo_def)) %>%
  select(estimate_name, smo_def, gr_legend, ends_with(".Overall"), ends_with(".Male"), ends_with(".Female"))
  
```

#### Prepare Fig2: Single plots

```{r}
sir_sum_fig2_plots <- list()

#smoking related

sir_sum_fig2_plots[["sir_smo_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Overall" & t_site_short == "smo") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[1:3], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_smo_m"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Male" & t_site_short == "smo") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[1:3], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_smo_f"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Female" & t_site_short == "smo") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[1:3], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

#other
sir_sum_fig2_plots[["sir_oth_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Overall" & t_site_short == "other") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[4:6], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_oth_m"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Male" & t_site_short == "other") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[4:6], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_oth_f"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Female" & t_site_short == "other") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[4:6], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)


#smo-r
sir_sum_fig2_plots[["sir_smor_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Overall" & t_site_short == "smor") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[7:9], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_smor_m"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Male" & t_site_short == "smor") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[10:12], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_smor_f"]] <-  sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & sex == "Female" & t_site_short == "smor") %>%
  plot_sir_col(., cat_var = gr, y_var = sir, y_lci_var = sir_lci, y_uci_var = sir_uci,
                            show_site = TRUE, show_scale = TRUE, show_nulleffect = TRUE, color = colors_15_sitedef[13:15], filter_cat = FALSE,
                            y_min = 0, y_max = 3, line_width = 1)

sir_sum_fig2_plots[["sir_smo_m"]]
sir_sum_fig2_plots[["sir_oth_f"]]
sir_sum_fig2_plots[["sir_smor_f"]]
```

#### Prepare Fig2: Single plots barcharts

```{r}
x_min <- 0
x_max <- 3
lw <- 4

fig2_names_sex <- c("Overall", "Male", "Female")

sir_sum_fig2_plots_b <- list()

#smoking related
sir_sum_fig2_plots_b[["smo_iarc"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smo_iarc") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smo_iarc"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)

sir_sum_fig2_plots_b[["smo_boak"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smo_boak") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smo_boak"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)

sir_sum_fig2_plots_b[["smo_barc"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smo_barc") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smo_barc"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)

#other
sir_sum_fig2_plots_b[["oth_iarc"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "oth_iarc") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["oth_iarc"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)

sir_sum_fig2_plots_b[["oth_boak"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "oth_boak") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["oth_boak"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)

sir_sum_fig2_plots_b[["oth_barc"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "oth_barc") %>%
  lapply(fig2_names_sex, plot_sir_bar,
         results_df=., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["oth_barc"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = TRUE)


#smo-r
sir_sum_fig2_plots_b[["smor_iarc_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_iarc_t") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_iarc_t"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_iarc_m"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_iarc_m") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_iarc_m"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_iarc_f"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_iarc_f") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_iarc_f"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)

sir_sum_fig2_plots_b[["smor_boak_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_boak_t") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_boak_t"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_boak_m"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_boak_m") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_boak_m"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_boak_f"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_boak_f") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_boak_f"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)

sir_sum_fig2_plots_b[["smor_barc_t"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_barc_t") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_barc_t"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_barc_m"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_barc_m") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_barc_m"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)
sir_sum_fig2_plots_b[["smor_barc_f"]] <- sir_sum_fig2_smor %>%
  filter(fu_time == "Total 0.5 to Inf years" & gr == "smor_barc_f") %>%
  plot_sir_bar(., cat_var = sex, show_site = FALSE, show_scale = FALSE, 
         color = colors_15_sitedef[["smor_barc_f"]], x_min = x_min, x_max = x_max, 
         line_width = lw, filter_cat = FALSE)

sir_sum_fig2_plots_b[[1]][[3]]
sir_sum_fig2_plots_b[[3]][[3]]
sir_sum_fig2_plots_b[["smor_iarc_t"]] 
```

#### Prepare Fig2: Tabulate

```{r}
#parameters of plot column
rh <- 25   #row height in px
ar <- 6    #aspect ratio

tab_fig2_gt <- sir_sum_fig2_tab %>%
  mutate(plots.Overall = NA,
         plots.Male = NA,
         plots.Female = NA ) %>%
  #add references to rows
  mutate(gr_legend =case_when(
    gr_legend == "SIR 🚬 (IARC def.)"    ~ paste0("SIR 🚬 (IARC def. - ", ref_iarc, ")"),
    gr_legend == "SIR 🚬 (Boakye def.)"  ~ paste0("SIR 🚬 (Boakye def. - ", ref_boakye, ")"),
    gr_legend == "SIR 🚬 (Barclay def.)" ~ paste0("SIR 🚬 (Barclay def. - ", ref_barclay, ")"),
    gr_legend == "SIR other (IARC def.)" ~ paste0("SIR other (IARC def. - ", ref_iarc, ")"),
    gr_legend == "SIR other (Boakye def.)" ~ paste0("SIR other (Boakye def. - ", ref_boakye, ")"),
    gr_legend == "SIR other (Barclay def.)" ~ paste0("SIR other (Barclay def. - ", ref_barclay, ")"),
    gr_legend == "Smo-R (IARC def.)"    ~ paste0("Smo-R (IARC def. - ", ref_iarc, ")"),
    gr_legend == "Smo-R (Boakye def.)"  ~ paste0("Smo-R (Boakye def. - ", ref_boakye, ")"),
    gr_legend == "Smo-R (Barclay def.)" ~ paste0("Smo-R (Barclay def. - ", ref_barclay, ")"),
    TRUE ~ gr_legend)) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = tidyselect::all_of(c("sir_uci.Overall",  "sir_uci.Male", "sir_uci.Female",
                                   "estimate_name", "smo_def"))
  ) %>%
    #make header
  gt::tab_header(
title = "Table 3: Impact of smoking-relatedness definition on SIR estimates and risk for smoking-related vs. other second primary cancers",
    subtitle = "")  %>%
  #rename columns
    gt::cols_label(      
      "gr_legend" = "",
      "plots.Overall" = "",
      "sir.Overall" = "Estimate",
      "sir_lci.Overall" = "95% CI",
      "plots.Male" = "",
      "sir.Male"    = "Estimate",
      "sir_lci.Male"   = "95% CI", 
      "plots.Female" = "",
      "sir.Female"   = "Estimate",
      "sir_lci.Female"    = "95% CI" 
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total",
    columns = all_of(c(
     "sir.Overall",
     "sir_lci.Overall",
     "plots.Overall"))
  ) %>%
  tab_spanner(
    label = "Male",
    columns = all_of(c(
     "sir.Male",
     "sir_lci.Male",
     "plots.Male"))
  ) %>%  
  tab_spanner(
    label = "Female",
    columns = all_of(c(
     "sir.Female",
     "sir_lci.Female",
     "plots.Female"))
  ) %>%  
 #gt: Define row groups -> careful: you need to add groups in reverse order... so bottom group first
    gt::tab_row_group(
    label = "Smo-R: Ratio SIR 🚬 vs. SIR other",
    rows = estimate_name == sir_sum_fig2_tab$estimate_name[7]
    ) %>%
    gt::tab_row_group(
    label = "SIR other cancer",
    rows = estimate_name == sir_sum_fig2_tab$estimate_name[4]
    ) %>%
  gt::tab_row_group(
    label = "SIR smoking-related cancer",
    rows = estimate_name == sir_sum_fig2_tab$estimate_name[1]
    ) %>%
    #column formatting
  # ##plots
  text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 1),
                 fn = function(x) {sir_sum_fig2_plots_b[[1]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 1),
                 fn = function(x) {sir_sum_fig2_plots_b[[1]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 1),
                 fn = function(x) {sir_sum_fig2_plots_b[[1]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
    text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 2),
                 fn = function(x) {sir_sum_fig2_plots_b[[2]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 2),
                 fn = function(x) {sir_sum_fig2_plots_b[[2]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 2),
                 fn = function(x) {sir_sum_fig2_plots_b[[2]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
      text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 3),
                 fn = function(x) {sir_sum_fig2_plots_b[[3]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 3),
                 fn = function(x) {sir_sum_fig2_plots_b[[3]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 3),
                 fn = function(x) {sir_sum_fig2_plots_b[[3]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
      text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 4),
                 fn = function(x) {sir_sum_fig2_plots_b[[4]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 4),
                 fn = function(x) {sir_sum_fig2_plots_b[[4]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 4),
                 fn = function(x) {sir_sum_fig2_plots_b[[4]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
      text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 5),
                 fn = function(x) {sir_sum_fig2_plots_b[[5]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 5),
                 fn = function(x) {sir_sum_fig2_plots_b[[5]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 5),
                 fn = function(x) {sir_sum_fig2_plots_b[[5]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
        text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 6),
                 fn = function(x) {sir_sum_fig2_plots_b[[6]][[1]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 6),
                 fn = function(x) {sir_sum_fig2_plots_b[[6]][[2]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 6),
                 fn = function(x) {sir_sum_fig2_plots_b[[6]][[3]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
        text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 7),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_iarc_t"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 7),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_iarc_m"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 7),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_iarc_f"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
          text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 8),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_boak_t"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 8),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_boak_m"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 8),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_boak_f"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
          text_transform(locations = gt::cells_body(columns = c(plots.Overall), row = 9),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_barc_t"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  text_transform(locations = gt::cells_body(columns = c(plots.Male), row = 9),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_barc_m"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%    
    text_transform(locations = gt::cells_body(columns = c(plots.Female), row = 9),
                 fn = function(x) {sir_sum_fig2_plots_b[["smor_barc_f"]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                 ) %>%
  #     ##numbers
   cols_merge_range(
    col_begin = all_of("sir_lci.Overall"),
    col_end = all_of("sir_uci.Overall")
  ) %>%
  cols_merge_range(
    col_begin = all_of("sir_lci.Male"),
    col_end = all_of("sir_uci.Male")
  ) %>%
  cols_merge_range(
    col_begin = all_of("sir_lci.Female"),
    col_end = all_of("sir_uci.Female")
  ) %>%
  tab_source_note(md("Notes: Smoking-relatedness definition by *IARC* includes C00, C01-C06, C09-14, C15-16, C18-20, C22, C25, C30-34, C53, C56, C64-68, C92. *Boakye* definition is based on Boakye et al. 2019 and includes C00-14, C15-16, C18-20, C22, C25, C30-31, C33-34, C53, C64, C67. *Barclay* definition is based on Barclay et al. 2019 and includes C00-14, C15, C31, C33-34, C67. SIRs and Smo-R for Germany are calculated by the authors using the three different definitions of smoking-relatedness.")) %>%
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(c("Total", "Male", "Female")),
      cells_row_groups(c("SIR smoking-related cancer", "SIR other cancer", "Smo-R: Ratio SIR 🚬 vs. SIR other")),
      cells_column_labels(all_of(c("sir.Overall", "sir.Male", "sir.Female"))), 
      cells_body(columns = all_of(c("sir.Overall", "sir.Male", "sir.Female"))))
    ) %>%
    #global table options
  gt::tab_options(data_row.padding = px(8),        # increase row height
                  row_group.padding = px(15))        # increase row height
                   

#save table
tab_fig2_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "fig2_title.png"),
    vwidth = 1200, expand = 10
  )


```

#### Save Fig2 as file

```{r}
fig2_nol <- 
  tab_fig2_gt %>% 
    #for Journal, remove Title, Subtitle, Footnotes
  gt::tab_header(title = NULL, subtitle = NULL) %>%
  #gt::tab_source_note(source_note = NULL) %>%  #not working in gt v0.3
  gt::tab_options(footnotes.marks = "letters")

#remove footnotes
fig2_nol$"_source_notes" <- NULL

fig2_nol

fig2_nol %>%
  #save ggplot
  gt::gtsave(
    file.path(output_dir_tables, "fig2.png"),
    vwidth = 1200, expand = 10
  )

```


## Sensitivity Analyses

###	Sens1: Calculate SIR for d1 without counting DCO cases


```{r}
#run sir calculations
sens1_nodco_sir_d1_results <- d1nodco_zlung_wide %>%
  #count all SPC in data set
  mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  msSPChelpR::sir_byfutime(., dattype = "zfkd", 
                           ybreak_vars = c("SEX.1", "p_agefcgroup", "p_yearfcgroup", "p_region_recode",
                                           "t_sublung.1", "t_grading.1", "PTO.1"),
                           xbreak_var = "none", futime_breaks = c(0.5, 1, 5, 10, Inf),
                           count_var = "count_spc", refrates_df = rates_imp,
                           calc_total_row = TRUE,  calc_total_fu = TRUE,
                           region_var = "p_region_recode", age_var = "t_agegroupdiag.1", sex_var = "SEX.1", 
                           year_var = "t_singleyeardiag.1", race_var = NULL, site_var = "t_icdcat.2", 
                           futime_var = "p_futimeyrs",
                           alpha = 0.05
                           )

#add additional grouping of site_var in sir results
sens1_nodco_sir_d1_results <- sens1_nodco_sir_d1_results %>%
  cr_site_vars_smoke_tt(., site_var = "t_site", en_gb = en_gb)


#preparations for table
#first summarize results by ICD group
sens1_nodco_sir_sum_tab2_smokegroups <- sens1_nodco_sir_d1_results %>%
    filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smokeiarc as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    )  %>%
    #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                     ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barklay = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 
  

sens1_nodco_sir_sum_tab2_sites <- sens1_nodco_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_icdgroup_pubdet as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  cr_icdgroup_vars_smoke_tt(., "t_site", en_gb = en_gb) %>%
  select(-t_smoke_barclay, -t_smoke_boakye)

sens1_nodco_sir_sum_tab2_totals <- sens1_nodco_sir_d1_results %>%
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = TRUE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_site",
                                    alpha = 0.05
                                    ) 

sens1_nodco_tab2 <- bind_rows(sens1_nodco_sir_sum_tab2_totals, sens1_nodco_sir_sum_tab2_sites, sens1_nodco_sir_sum_tab2_smokegroups) %>%
  select(-age, -region, -sex, -year) %>%
  #for sites, copy values to yvar_label
  mutate(yvar_label = case_when(yvar_name == "total_var" & t_site != "Total" ~ t_site,
                                TRUE ~ yvar_label)) %>%
  #unknown categories
  mutate(yvar_label = recode(yvar_label, "zzz_NA_explicit" = "Unknown")) %>%
  #for cancer related grouping, make gender clear
  mutate(yvar_label = case_when(yvar_label == "other cancer" & t_site == "other cancer" ~ "Other cancers - Total",
                                yvar_label == "Female" & t_site == "other cancer" ~ "Other cancers - Female",
                                yvar_label == "Male" & t_site == "other cancer" ~ "Other cancers - Male",
                                yvar_label == "smoking-related IARC" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Total",
                                yvar_label == "Female" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Female",
                                yvar_label == "Male" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Male",
                                TRUE ~ yvar_label)) 
  
rm(sens1_nodco_sir_sum_tab2_sites, sens1_nodco_sir_sum_tab2_totals, sens1_nodco_sir_sum_tab2_smokegroups)

sens1_diff <- sens1_nodco_tab2 %>%
  full_join(tab2, by = c("yvar_name", "yvar_label", "t_site"), suffix = c(".sens", ".main")) %>%
  mutate(sir_diff = `Total 0.5 to Inf years__sir.main` - `Total 0.5 to Inf years__sir.sens`) %>%
  relocate(sir_diff, .after = t_site)

sens1_diff

nrow_d1nodco <- nrow(d1nodco_zlung_wide)
```

Removing all DCO cases from the count as second cancer resulted in `r nrow_d1_s6_srv - nrow_d1nodco` less observed cancer. When re-calculating SIR using national reference rates also omitting DCO, we received results similar to the main analysis. In general SIRs excluding DCO cases in SPC were about 0.1 lower than SIR including these in observed counts. The reduction was more pronounced for other cancers (\delta `r sens1_diff %>% filter(yvar_label == "Other cancers - Female") %>% pull(sir_diff)` female, `r sens1_diff %>% filter(yvar_label == "Other cancers - Male") %>% pull(sir_diff)` male), than for smoking related cancers (\delta `r sens1_diff %>% filter(yvar_label == "Smoking-related cancers - Female") %>% pull(sir_diff)` female, `r sens1_diff %>% filter(yvar_label == "Smoking-related cancers - Male") %>% pull(sir_diff)` male).


### Sens2: Restriction to regions with low DCO rates (<10%)

```{r}
dco_rates_byyear %>%
  ggplot(aes(x = year, y = dco_rate,  fill = p_region.1, colour = p_region.1)) + 
  geom_line(stat="identity", position = "identity")  +
  facet_wrap( ~ cancer) + 
  theme_bw()  +
  theme(legend.position="bottom")
```
```{r}
dco_rates_byyear %>%
  filter(year > 2002) %>%
  filter(dco_rate < 10) %>%
  count(p_region.1, cancer)

dco_rates_byyear %>%
  filter(year > 2002) %>%
  filter(dco_rate < 10) %>%
  arrange(p_region.1, year)

dco_rates_byyear %>%
  ggplot(aes(x = year, y = dco_rate,  fill = cancer, colour = cancer)) + 
  geom_line(stat="identity", position = "identity")  +
  coord_cartesian(xlim= c(2002, 2013), ylim = c(0, 20)) +
  facet_wrap( ~ p_region.1) + 
  theme_bw()  +
  theme(legend.position="bottom")

```
```{r}

# restrict d1 to regions with DCO < 10%

sens2_lowdcorate_d1_zlung_wide <- d1_zlung_wide %>% 
  # sens2: filter for the following registries of the first tumor (reasonable FU of at least 5 years, GEKID recommended, < 10% DCO rate): 
    # - Baden-Württemberg             2009-01-15 --> exclusion reason: too short FU
    # - Bavaria                       2002-01-15 --> exclusion reason: DCO rate > 10%  
    # - Berlin                        1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # o Brandenburg                   1990-01-15 --> inclusion from 2007 when DCO < 10%
    # o Bremen                        1998-01-15 --> inclusion from 2004 when DCO < 10%
    # o Hamburg                       1990-01-15 --> inclusion from 2008 when DCO < 10%
    # - Hesse                         1992-07-15 --> exclusion reason: low completeness <80% in 2012
    # o Mecklenburg-Western Pomerania 1990-01-15 --> inclusion 2003-2011 when DCO < 10%
    # - Lower Saxony                  1997-01-15 --> exclusion reason: DCO rate > 10% 
    # - North Rhine-Westphalia        1986-01-15 --> exclusion reason: DCO rate > 10% 
    # - Rhineland-Palatinate          1998-01-15 --> exclusion reason: low completeness <90% in 2012
    # o Saarland                      1970-01-15 --> inclusion 2002-2011 when DCO < 10%
    # o Saxony                        1990-01-15 --> inclusion from 2005 when DCO < 10%
    # - Saxony-Anhalt                 1990-01-15 --> exclusion reason: low completeness <80% in 2012
    # - Schleswig-Holstein            1998-01-15 --> exclusion reason: DCO rate > 10%    
    # - Thuringia                     1990-01-15 --> exclusion reason: DCO rate > 10% 
  tidylog::filter(
      (p_region_recode == "DE4 Brandenburg" & t_singleyeardiag.1 >= 2007) |
      (p_region_recode == "DE5 Bremen" & t_singleyeardiag.1 >= 2004) |
      (p_region_recode == "DE6 Hamburg" & t_singleyeardiag.1 >= 2008) |
      (p_region_recode == "DE8 Mecklenburg-Western Pomerania" & t_singleyeardiag.1 >= 2003 & t_singleyeardiag.1 <= 2011) |
      (p_region_recode == "DEC Saarland" & t_singleyeardiag.1 >= 2002 & t_singleyeardiag.1 <= 2011) |
       (p_region_recode == "DED Saxony" & t_singleyeardiag.1 >= 2005))

```



#### Calculate SIR for sens2_d1,low DCO rate regions


```{r}
#run sir calculations
sens2_lowdcorate_sir_d1_results <- sens2_lowdcorate_d1_zlung_wide %>%
  #count all SPC in data set
  mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  msSPChelpR::sir_byfutime(., dattype = "zfkd", 
                           ybreak_vars = c("SEX.1", "p_agefcgroup", "p_yearfcgroup", "p_region_recode",
                                           "t_sublung.1", "t_grading.1", "PTO.1"),
                           xbreak_var = "none", futime_breaks = c(0.5, 1, 5, 10, Inf),
                           count_var = "count_spc", refrates_df = rates_dco_imp,
                           calc_total_row = TRUE,  calc_total_fu = TRUE,
                           region_var = "p_region_recode", age_var = "t_agegroupdiag.1", sex_var = "SEX.1", 
                           year_var = "t_singleyeardiag.1", race_var = NULL, site_var = "t_icdcat.2", 
                           futime_var = "p_futimeyrs",
                           alpha = 0.05
                           )

#add additional grouping of site_var in sir results
sens2_lowdcorate_sir_d1_results <- sens2_lowdcorate_sir_d1_results %>%
  cr_site_vars_smoke_tt(., site_var = "t_site", en_gb = en_gb)

```



### Check if p_futimeyrs and type of lung cancer make sense

```{r}
d2_zlung_wide %>% 
  filter(DSICH.1 != "DCO (death certificate only)") %>% 
  group_by(t_sublung.1) %>% 
  summarize(
    n = n(),
    time = mean(p_futimeyrs, na.rm = TRUE))
```
It makes sense that the lowest survival is seen within the group of Small-cell carcinoma.



### Sens allfu: Calculate SIR for d2, including 0-6 months follow-up


```{r}
#run sir calculations
sir_d2_results <- d2_zlung_wide %>%
  #count all SPC in data set
  mutate(count_spc = case_when(p_spc == "SPC developed" ~ 1,
                               TRUE ~ 0)) %>%
  sir_byfutime(., dattype = "zfkd", 
                           ybreak_vars = c("SEX.1", "p_agefcgroup", "p_yearfcgroup", "p_region_recode",
                                           "t_sublung.1"),
                           xbreak_var = "none", futime_breaks = c(0, 0.5, 1, 5, 10, Inf),
                           count_var = "count_spc", refrates_df = rates_dco_imp,
                           calc_total_row = TRUE,  calc_total_fu = TRUE,
                           region_var = "p_region_recode", age_var = "t_agegroupdiag.1", sex_var = "SEX.1", 
                           year_var = "t_singleyeardiag.1", race_var = NULL, site_var = "t_icdcat.2", 
                           futime_var = "p_futimeyrs",
                           alpha = 0.05
                           )

#add additional grouping of site_var in sir results
sir_d2_results <- sir_d2_results %>%
  cr_site_vars_smoke_tt(., site_var = "t_site", en_gb = en_gb)

```


## Supplement

### S1. Figure: Details on included regions

#### Prepare map

```{r}
supp_map_reg_included <- c("Bayern", "Brandenburg", "Bremen", "Hamburg",
                           "Mecklenburg-Vorpommern", "Niedersachsen", "Saarland",
                           "Sachsen", "Schleswig-Holstein", "Thüringen", "Münster")

population %>% filter(region %in% regs & sex == "Total - All sexes" & age == "Total - All age groups" & year == "2013") %>% distinct() %>% select(-sex, -age, -population_pyar, -comment)

supp_map_ger_sf1 <- map_ger_sf1 %>%
  #flag included regions
  mutate(included = case_when(NAME_1 %in% supp_map_reg_included ~ "included",
                              TRUE                     ~ "excluded"),
         #add English names
         VARNAME_1 = case_when(is.na(VARNAME_1) ~ NAME_1,
                               TRUE             ~ VARNAME_1),
         #add population
         pop = case_when(NAME_1 == "Bayern"       ~ "12.6 M",
                         NAME_1 == "Brandenburg"  ~ "2.4 M",
                         NAME_1 == "Bremen"       ~ "0.7 M",
                         NAME_1 == "Hamburg"      ~ "1.7 M",
                         NAME_1 == "Mecklenburg-Vorpommern" ~ "1.6 M",
                         NAME_1 == "Niedersachsen" ~ "7.8 M",
                         NAME_1 == "Saarland"     ~ "1.0 M",
                         NAME_1 == "Sachsen"      ~ "4.0 M",
                         NAME_1 == "Schleswig-Holstein" ~ "2.8 M",
                         NAME_1 == "Thüringen"    ~ "2.2 M"
                         ),
         map_label = paste0(VARNAME_1, " (", pop, ")"))

#extract Münster from level 2 map
supp_map_ger_sf2 <- map_ger_sf2 %>%
  filter(NAME_2 %in% c("Borken", "Coesfeld", "Recklinghausen", "Steinfurt", "Warendorf", "Bottrop", "Gelsenkirchen", "Münster"))  %>%
  mutate(included = "included",
         pop = "2.6 M",
         map_label = paste0("Münster district (", pop, ")"))

supp_map_ger_sf2_lab <- supp_map_ger_sf2 %>%
  filter(NAME_2 == "Münster")
```

#### Create figure

```{r}

supp_map <- supp_map_ger_sf1 %>%
  ggplot() +
  geom_sf(aes(color = included, fill = included),
          lwd = .5) +
  #plot Münster
  geom_sf(data = supp_map_ger_sf2, aes(color = included, fill = included),
          lwd = .5) +
  #add labels of states
  geom_sf_label(aes(label = map_label), position=position_nudge(x=ifelse(supp_map_ger_sf1$NAME_1=='Brandenburg',.1,0),
      y=ifelse(supp_map_ger_sf1$NAME_1=='Brandenburg',-.4,0))) +
  geom_sf_label(data = supp_map_ger_sf2_lab, aes(label = map_label), position=position_nudge(x=-0.8)) +
  theme_minimal() + 
  scale_color_manual(values = c("lightgrey","lightblue4")) + 
  scale_fill_manual(values = c("white","lightblue2")) + 
    theme(legend.position="none",
          title = element_text(size = rel(1)),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          plot.caption = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_blank()
          ) +
   plot_annotation(
        title = element_text("Figure: Map of Germany highlighting the regional coverage of PBCR included in the analysis"),
    caption = element_text(
    "Notes: The included population-based cancer registries (10 state PBCR and 1 regional PBCR of the Münster district) are colored. 
            For included regions, the total population of the year 2013 (in million inhabitants) is provided in parentheses.
            Source of population data: DESTATIS Federal Statistical Office of Germany."),
  theme = theme(plot.caption = element_text(hjust = 0), #left alignment of caption
                plot.title = element_text(size = 14))
  )  

#print figure
supp_map

#save figure

supp_map %>%
  ggsave(filename = file.path(output_dir_tables, "supp_map.png"),
         width = 9, height = 11
         )

```



### S2. Table: Definition of histological subtypes of lung cancer

```{r}
#The data for this table is manually entered here
#tribble function creates row-wise data tibble

supp_tab_subtypes_def <- 
  tibble::tribble(
  ~hist1,                     ~subtype1, ~hist2,                 ~subtype2, ~hist3,                 ~subtype3, ~hist4,                 ~subtype4,
   8000L, "Unspecified lung cancer = 6",  8144L,      "Adenocarcinoma = 2",  8471L, "excluded - unusual = 92",  8910L, "excluded - sarcoma = 91",
   8001L, "Unspecified lung cancer = 6",  8145L,         "Other NSCLC = 5",  8480L,      "Adenocarcinoma = 2",  8912L, "excluded - sarcoma = 91",
   8002L,    "Small-cell carcinoma = 1",  8146L, "excluded - unusual = 92",  8481L,      "Adenocarcinoma = 2",  8920L, "excluded - sarcoma = 91",
   8003L, "Unspecified lung cancer = 6",  8147L,      "Adenocarcinoma = 2",  8490L,      "Adenocarcinoma = 2",  8933L, "excluded - sarcoma = 91",
   8004L, "Unspecified lung cancer = 6",  8154L, "excluded - unusual = 92",  8500L,         "Other NSCLC = 5",  8940L,         "Other NSCLC = 5",
   8005L, "Unspecified lung cancer = 6",  8155L, "excluded - unusual = 92",  8510L,      "Adenocarcinoma = 2",  8941L, "excluded - unusual = 92",
   8010L, "Unspecified lung cancer = 6",  8160L, "excluded - unusual = 92",  8520L, "excluded - unusual = 92",  8951L, "excluded - unusual = 92",
   8011L,     "excluded - unusual = 92",  8162L, "excluded - unusual = 92",  8530L, "excluded - unusual = 92",  8963L, "excluded - sarcoma = 91",
   8012L,             "Other NSCLC = 5",  8170L, "excluded - unusual = 92",  8550L,      "Adenocarcinoma = 2",  8970L, "excluded - unusual = 92",
   8013L,             "Other NSCLC = 5",  8190L,      "Adenocarcinoma = 2",  8551L,      "Adenocarcinoma = 2",  8971L, "excluded - unusual = 92",
   8014L,             "Other NSCLC = 5",  8200L,         "Other NSCLC = 5",  8560L,         "Other NSCLC = 5",  8972L,         "Other NSCLC = 5",
   8020L, "Unspecified lung cancer = 6",  8201L,      "Adenocarcinoma = 2",  8562L,         "Other NSCLC = 5",  8973L,         "Other NSCLC = 5",
   8021L, "Unspecified lung cancer = 6",  8210L, "excluded - unusual = 92",  8570L,      "Adenocarcinoma = 2",  8980L,         "Other NSCLC = 5",
   8022L,             "Other NSCLC = 5",  8211L,      "Adenocarcinoma = 2",  8571L,      "Adenocarcinoma = 2",  8981L,         "Other NSCLC = 5",
   8030L,             "Other NSCLC = 5",  8230L,         "Other NSCLC = 5",  8572L,      "Adenocarcinoma = 2",  8982L, "excluded - unusual = 92",
   8031L,             "Other NSCLC = 5",  8231L, "excluded - unusual = 92",  8573L,      "Adenocarcinoma = 2",  8990L, "excluded - sarcoma = 91",
   8032L,             "Other NSCLC = 5",  8240L,           "Carcinoid = 4",  8574L,      "Adenocarcinoma = 2",  9040L, "excluded - sarcoma = 91",
   8033L,             "Other NSCLC = 5",  8241L,           "Carcinoid = 4",  8575L,      "Adenocarcinoma = 2",  9041L, "excluded - sarcoma = 91",
   8034L,             "Other NSCLC = 5",  8242L,           "Carcinoid = 4",  8576L,      "Adenocarcinoma = 2",  9043L, "excluded - sarcoma = 91",
   8040L,     "excluded - unusual = 92",  8243L,           "Carcinoid = 4",  8584L, "excluded - unusual = 92",  9050L, "excluded - unusual = 92",
   8041L,    "Small-cell carcinoma = 1",  8244L,           "Carcinoid = 4",  8680L, "excluded - unusual = 92",  9064L, "excluded - unusual = 92",
   8042L,    "Small-cell carcinoma = 1",  8245L,           "Carcinoid = 4",  8720L, "excluded - unusual = 92",  9070L, "excluded - unusual = 92",
   8043L,    "Small-cell carcinoma = 1",  8246L,         "Other NSCLC = 5",  8721L, "excluded - unusual = 92",  9071L, "excluded - unusual = 92",
   8044L,    "Small-cell carcinoma = 1",  8249L,           "Carcinoid = 4",  8770L, "excluded - unusual = 92",  9072L, "excluded - unusual = 92",
   8045L,    "Small-cell carcinoma = 1",  8250L,      "Adenocarcinoma = 2",  8771L, "excluded - unusual = 92",  9080L, "excluded - unusual = 92",
   8046L,             "Other NSCLC = 5",  8251L,      "Adenocarcinoma = 2",  8800L, "excluded - sarcoma = 91",  9085L, "excluded - unusual = 92",
   8050L,             "Other NSCLC = 5",  8252L,      "Adenocarcinoma = 2",  8801L, "excluded - sarcoma = 91",  9100L, "excluded - unusual = 92",
   8051L,             "Other NSCLC = 5",  8253L,      "Adenocarcinoma = 2",  8802L, "excluded - sarcoma = 91",  9120L, "excluded - sarcoma = 91",
   8052L, "Squamous cell carcinoma = 3",  8254L,      "Adenocarcinoma = 2",  8803L, "excluded - sarcoma = 91",  9125L, "excluded - unusual = 92",
   8070L, "Squamous cell carcinoma = 3",  8255L,         "Other NSCLC = 5",  8804L, "excluded - sarcoma = 91",  9130L, "excluded - unusual = 92",
   8071L, "Squamous cell carcinoma = 3",  8260L,      "Adenocarcinoma = 2",  8805L, "excluded - sarcoma = 91",  9133L, "excluded - unusual = 92",
   8072L, "Squamous cell carcinoma = 3",  8262L, "excluded - unusual = 92",  8806L, "excluded - sarcoma = 91",  9150L, "excluded - unusual = 92",
   8073L, "Squamous cell carcinoma = 3",  8263L, "excluded - unusual = 92",  8810L, "excluded - sarcoma = 91",  9170L, "excluded - sarcoma = 91",
   8074L, "Squamous cell carcinoma = 3",  8270L, "excluded - unusual = 92",  8811L, "excluded - sarcoma = 91",  9180L, "excluded - sarcoma = 91",
   8075L,             "Other NSCLC = 5",  8290L, "excluded - unusual = 92",  8815L, "excluded - unusual = 92",  9220L, "excluded - sarcoma = 91",
   8076L, "Squamous cell carcinoma = 3",  8310L,      "Adenocarcinoma = 2",  8830L, "excluded - sarcoma = 91",  9231L, "excluded - unusual = 92",
   8078L, "Squamous cell carcinoma = 3",  8312L, "excluded - unusual = 92",  8840L, "excluded - unusual = 92",  9240L, "excluded - unusual = 92",
   8082L,             "Other NSCLC = 5",  8320L,      "Adenocarcinoma = 2",  8850L, "excluded - sarcoma = 91",  9260L, "excluded - sarcoma = 91",
   8083L, "Squamous cell carcinoma = 3",  8323L,      "Adenocarcinoma = 2",  8851L, "excluded - sarcoma = 91",  9364L, "excluded - unusual = 92",
   8084L, "Squamous cell carcinoma = 3",  8332L, "excluded - unusual = 92",  8852L, "excluded - sarcoma = 91",  9365L, "excluded - unusual = 92",
   8090L,     "excluded - unusual = 92",  8333L,  "excluded - benign = 93",  8853L, "excluded - unusual = 92",  9473L, "excluded - unusual = 92",
   8094L,     "excluded - unusual = 92",  8340L, "excluded - unusual = 92",  8854L, "excluded - sarcoma = 91",  9540L, "excluded - unusual = 92",
   8095L,     "excluded - unusual = 92",  8345L, "excluded - unusual = 92",  8857L, "excluded - unusual = 92",  9560L, "excluded - unusual = 92",
   8097L,     "excluded - unusual = 92",  8401L,      "Adenocarcinoma = 2",  8858L, "excluded - unusual = 92",  9561L, "excluded - unusual = 92",
   8120L,     "excluded - unusual = 92",  8430L,         "Other NSCLC = 5",  8890L, "excluded - sarcoma = 91",  9580L, "excluded - unusual = 92",
   8123L,             "Other NSCLC = 5",  8440L,      "Adenocarcinoma = 2",  8891L, "excluded - sarcoma = 91",  9581L, "excluded - unusual = 92",
   8130L,     "excluded - unusual = 92",  8441L, "excluded - unusual = 92",  8894L, "excluded - sarcoma = 91",     NA,                        NA,
   8140L,          "Adenocarcinoma = 2",  8450L, "excluded - unusual = 92",  8895L, "excluded - sarcoma = 91",     NA,                        NA,
   8141L,          "Adenocarcinoma = 2",  8460L, "excluded - unusual = 92",  8900L, "excluded - sarcoma = 91",     NA,                        NA,
   8143L,          "Adenocarcinoma = 2",  8470L,      "Adenocarcinoma = 2",  8901L, "excluded - sarcoma = 91",     NA,                        NA
  )



```

```{r}

supp_tab_subtypes_def_gt <- supp_tab_subtypes_def %>%
  #remove number codes from sub-types
  mutate(across(.cols = starts_with("subtype"), .fns = ~ str_remove(., "[:space:]=[:space:][:alnum:]+")))%>%
  #Start making gt table
  gt::gt()  %>%
  #make header
  gt::tab_header(
    title = "Table: Definition of histological subtypes of lung cancer",
    subtitle = "") %>%
  #rename columns
    gt::cols_label(
      "hist1" = "Histology Code",
      "subtype1" = "Histologic subtype of lung cancer",
      "hist2" = "Histology Code",
      "subtype2" = "Histologic subtype of lung cancer",
      "hist3" = "Histology Code",
      "subtype3" = "Histologic subtype of lung cancer",
      "hist4" = "Histology Code",
      "subtype4" = "Histologic subtype of lung cancer") %>% 
  #special formatting
  gt::fmt_missing(
    columns = everything(), 
    missing_text = "") %>%
  ##left align
  gt::cols_align(
    align = "left",
    columns = starts_with("subtype")
  ) %>%
  ##make column labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = 
      cells_column_labels(everything())
    ) %>%
  ##column width
  gt::cols_width(
    starts_with("hist") ~ px(80),
    starts_with("subtype") ~ px(190)
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(1))
  
#save table
supp_tab_subtypes_def_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_subtypes_def.png"),
    vwidth = 1100
  )

#print table
supp_tab_subtypes_def_gt

```


### S3. Table: Details on dataset filtering

```{r}
#The data for this table is manually entered here
#tribble function creates row-wise data tibble

supp_tab_filter <- tibble::tribble(
 ~stage, ~excluded, ~remain, ~code, ~comments,
 "0 – all patients with a first cancer diagnosis of lung cancer in raw data", NA, 706943, "filter(str_detect(ICDGM10, \"^C33|^C34\") & t_tumid == 1)", "Data has been pre-filtered according to the following criteria: patients with a first cancer diagnosis of lung cancer defined as `ICD10GM` starts with `C33` or `C34` AND `t_tumid == 1` (Tumour ID created with `msSPChelpR::renumber_time_id_tt()` function and defined as chronologically sorting of all registered cases per patient ID by date of diagnosis, ignoring D diagnoses [in situ, benign and unknown behaviour diagnoses] and C44 diagnoses [non-malignant melanoma]) no further restrictions on age, registry, site, histology or data quality",
 "1 – only select LC diagnoses 2002-2013", 218387, 488556, "filter((DDIMP.1 > \"2002-01-01\" & DDIMP.1 < \"2013-12-31\"))", "Date of diagnosis is only recorded with month and year of diagnosis; in order to calculate with dates the day of diagnosis was always set to the 15th of the month",
 "2 – only select registers with acceptable data quality", 223796, 264760, "filter(p_region_recode %in% c(\"DE2 Bavaria\", \"DE4 Brandenburg\", \"DE5 Bremen\", \"DE6 Hamburg\",\"DE8 Mecklenburg-Western Pomerania\", \"DE9 Lower Saxony\", \"DEA3 Muenster\", \"DEC Saarland\", \"DED Saxony\", \"DEF Schleswig-Holstein\", \"DEG Thuringia\"))", "Selection of all German PBCR that had at least 5 years of follow-up with >90% estimated case completeness.",
 "3 – only select LC cases diagnosed at age 30-99", 285, 264475, "filter((t_agediag.1 >= 30 & t_agediag.1 < 100))", NA,
 "4 – delete cases with unusual LC morphology", 554, 263921, "filter(!(t_sublung.1 %in% c(\"Excluded - sarcoma\", \"Excluded - unusual\", \"Excluded - benign\")))", "Variable `t_sublung.1` was created from histology codes according to Supplement Table \"Definition of histological subtypes of lung cancer\".",
 "5 – delete cases where LC is DCO", 38926, 224995, "filter(DSICH.1 != \"DCO (death certificate only)\" | is.na(DSICH.1))", "Cases with missing source of diagnosis were not removed",
 "6 – delete cases with less than 6 months follow-up", 89406, 135589, "filter(p_futimeyrs >= 0.5)", "Cases with missing follow-up time were also excluded (163 cases excluded for that reason)"
 )

```


```{r}

supp_tab_filter_gt <- supp_tab_filter %>%
  #Start making gt table
  gt::gt()  %>%
  #make header
  gt::tab_header(
    title = "Table: Details of dataset filtering",
    subtitle = "") %>%
  #rename columns
    gt::cols_label(
      "stage" = "Filtering Stage",
      "excluded" = "N excluded",
      "remain" = "N remaining",
      "code" = "Code",
      "comments" = "Comments") %>% 
  #special formatting
  gt::fmt_markdown(
    columns = c(comments)
  ) %>%
  ##format missing
  gt::fmt_missing(
    columns = c(comments), 
    missing_text = "") %>%
  ##left align
  gt::cols_align(
    align = "left",
    columns = everything()
  ) %>%
  ##top align all cells
  gt::tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body(
        columns = everything())
    )%>%
  ##make column labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = 
      cells_column_labels(everything())
    ) %>%
  ##change font of Code column
  tab_style(
    style = cell_text(font = c("Consolas", default_fonts())),
    locations = cells_body(
      columns = c(code))
    ) %>%
  ##column width
  gt::cols_width(
    c(stage) ~ px(200),
    c(code)  ~ px(300),
    c(comments) ~ px(450)
  )

  
#save table
supp_tab_filter_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_filter.png")
  )

```



### S4. Table: Details on data modifications

```{r}
#The data for this table is manually entered here
#tribble function creates row-wise data tibble

supp_tab_dm <- tibble::tribble(
 ~variable, ~details, ~code,
 "Patient Status at end of follow-up [p_status]", 
 " - using `pat_status_tt` function from `msSPChelpR` package 
  - set end of follow-up time to end of December 2014 (follow-up data for new cancer cases is not available after that data) 
 - impute information for missing date of death by taking the last available date for all patients that are dead according to available life status (→ for 901 cases DOD was imputed by using last available date of diagnosis, thus assuming 0 survival time)", "msSPChelpR::pat_status_tt(., fu_end = \"2014-12-31\", dattype = \"zfkd\", status_var = \"p_status\", lifedatmin_var = \"p_dodmin.1\", use_lifedatmin = TRUE, check = TRUE, as_labelled_factor = FALSE)",
 "Follow-up time of patient in years [p_futimeyrs]", 
 " - using `calc_futime_tt` function from `msSPChelpR` package
  - follow-up time of patient from diagnosis of first cancer until SPC or date of death death or end of FU [years]
  - set end of follow-up time to end of December 2014 (follow-up data for new cancer cases is not available after that data)
  - for all cases where patient status at end of follow-up period cannot be determined (`p_status` equals 97, 98 or 99) the follow-up time is set to missing", "msSPChelpR::calc_futime_tt(., futime_var_new = \"p_futimeyrs\", fu_end = \"2014-12-15\", dattype = \"zfkd\", time_unit = \"years\", lifedat_var = \"SDIMP.1\", fcdat_var = \"DDIMP.1\", spcdat_var = \"DDIMP.2\")"
 )

```

```{r}

supp_tab_dm_gt <- supp_tab_dm %>%
  #Start making gt table
  gt::gt()  %>%
  #make header
  gt::tab_header(
    title = "Table: Details of data modifications",
    subtitle = "") %>%
  #rename columns
      gt::cols_label(
      "variable" = "Variable",
      "details" = "Detailed description",
      "code" = "Code") %>% 
  #special formatting
  gt::fmt_markdown(
    columns = c(details)
  ) %>%
  ##left align
  gt::cols_align(
    align = "left",
    columns = everything()
  ) %>%
    ##top align all cells
  gt::tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body(
        columns = everything())
    )%>%
  ##make column labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = 
      cells_column_labels(everything())
    ) %>%
  ##change font of Code column
  tab_style(
    style = cell_text(font = c("Consolas", default_fonts())),
    locations = cells_body(
      columns = c(code))
    ) %>%
   ##column width
  gt:: cols_width(
    c(variable) ~ px(150),
    c(details)  ~ px(500),
    c(code)     ~ px(350)
  )

  
#save table
supp_tab_dm_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_data_mod.png"),
    vwidth = 1050
  )

```


### S5. Table: Details on smoking-related cancer sites

```{r}
#The data for this table is manually entered here
#tribble function creates row-wise data tibble

supp_tab_sites <- 
  tibble::tribble(
                                  ~site,   ~icd_10,              ~icd_o3,  ~iarc, ~barclay,  ~boakye, ~rr_men, ~rr_women,    ~paf_men,  ~paf_women,
    "Lung (incl. bronchus and trachea)", "C33–C34", "C33.9, C34.0–C34.9",   "🚬",     "🚬",     "🚬",  "25.3",    "22.9",     "88.5%",     "83.3%",
         "Lip, oral cavity and pharynx", "C00–C14",        "C00.0–C14.8",  "🚬*",     "🚬",     "🚬",   "5.7",     "5.6",     "31.3%",     "22.8%",
                           if(en_gb){"Oesophagus"}else{"Esophagus"},     "C15",        "C15.0–C15.9", "🚬**",  "🚬***",     "🚬",   "3.9",     "5.1",     "30.6%",     "21.6%",
                              "Stomach",     "C16",        "C16.0–C16.9",   "🚬",     "no",     "🚬",   "1.9",     "1.7",     "29.0%",     "18.2%",
                           "Colorectum", "C18–C20",        "C18.0–C20.9",   "🚬",     "no",     "🚬",   "1.4",     "1.6",     "29.3%",     "18.6%",
                                "Liver",     "C22",        "C22.0–C22.1",   "🚬",     "no",     "🚬",   "2.3",     "1.8",     "30.3%",     "19.0%",
                             "Pancreas",     "C25",        "C25.0–C25.9",   "🚬",     "no",   "🚬**",   "1.6",     "1.9",     "29.7%",     "18.5%",
          "Nasal cavity and middle ear",     "C30",        "C30.1–C30.2",   "🚬",     "🚬",     "🚬",     "x",       "x",         "x",         "x",
                    "Accessory sinuses",     "C31",        "C31.0–C31.9",   "🚬",     "🚬",     "🚬",     "x",       "x",         "x",         "x",
                               "Larynx",     "C32",        "C32.0–C32.9",   "🚬",     "🚬",     "no",  "13.9",   "103.8",     "31.5%",     "24.4%",
                               "Cervix",     "C53",        "C53.0–C53.9",   "🚬",     "no",     "🚬",     "x",     "3.5",         "x",     "19.0%",
                                "Ovary",     "C56",              "C56.9",   "🚬",     "no",     "no",     "x",       "x",         "x",         "x",
                               "Kidney",     "C64",              "C64.9",   "🚬",     "no",     "🚬",   "1.8",     "1.2",     "29.8%",     "19.7%",
                        "Urinary tract", "C65–C68",        "C65.9–C68.9",   "🚬", "🚬****", "🚬****",   "3.9",     "3.9", "28.6%****", "18.2%****",
                    if(en_gb){"Myeloid leukaemia"}else{"Myeloid leukemia"},     "C92",              "C42.1",   "🚬",     "no",     "no",     "x",       "x",     "28.2%",     "18.6%"
    )

```

```{r}
supp_tab_sites_gt <- supp_tab_sites %>%
  gt() %>%
  gt::tab_header(
    title = "Table: Details on smoking-related cancer sites",
    subtitle = "") %>%
   #rename columns
    gt::cols_label(
      "site" = "Site",
      "icd_10" = "ICD-10 Codes",
      "icd_o3" = "ICD-O-3 Codes",
      "iarc" = paste0("IARC (", ref_iarc,")"),
      "barclay" = paste0("Barclay (", ref_barclay, ")"),
      "boakye" = paste0("Boakye (", ref_boakye, ")"),
      "rr_men" = "RR Men",
      "rr_women" = "RR Women",
      "paf_men" = "PAF Men",
      "paf_women" = "PAF Women"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Smoking-related according to the following definitions",
    columns = all_of(c(
     "iarc",
     "barclay",
     "boakye"))
  ) %>%
  tab_spanner(
    label = paste0("Relative risk (RR) for current vs never smoking (", ref_thakur,")"),
    columns = all_of(c(
     "rr_men",
     "rr_women"))
  ) %>%
    tab_spanner(
    label = "Attributable risk to smoking (PAF) in Germany (2)",
    columns = all_of(c(
     "paf_men",
     "paf_women"))
  ) %>%
  # gt::tab_footnote("does not include lip (C00), salivary glands (C07-C08) or Tonsil (C09)",
  #                  locations = cells_body(columns = c(iarc), rows = site == "Lip, oral cavity and pharynx")) %>%
  #formatting
    gt::cols_align(
    align = "center",
    columns = all_of(c("iarc", "barclay", "boakye"))
  ) %>%
      gt::cols_align(
    align = "right",
    columns = c(rr_men, rr_women, paf_men, paf_women)
  ) %>%
  gt:: cols_width(
    c(site) ~ px(180),
    c(icd_10) ~ px(70),
    c(icd_o3) ~ px(100),
    c(iarc, barclay, boakye) ~ px(100),
    c(rr_men, rr_women, paf_men, paf_women) ~ px(110)
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: ICD-10 codes are 2-digit codes of the ICD-10 German Modification used by the German cancer registries; ICD-O-3 codes are corresponding 3-digit codes, translation between ICD-10-GM and ICD-O-3 was done by authors as documented in this table; IARC uses an ICD-O-3 based definition of smoking-related cancer sites; Barclay et al. use an ICD-10 based definition of smoking-related sites; PAF Population Attributable Fraction in percent; 🚬  site classified as smoking-related; * does not include lip (C00), salivary glands (C07-C08) or Tonsil (C09); ** sites where exact translation from ICD-10-GM to detailed ICD-O-3 codes is not possible and all diagnoses under this ICD-10 code have been defined as smoking-related even though IARC definition is more detailed; *** only ", if(en_gb){"oesophageal"}else{"esophageal"}," squamous cell carcinoma (OSCC); **** only urinary bladder (C67.0–C67.9); x no estimate")
  ) %>% 
  #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_body(columns = c(site)),
      cells_column_labels(everything())
    )
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(5)) # reduce row height

supp_tab_sites_gt
  
#save table
supp_tab_sites_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sites_def.png"),
    vwidth = 1200, expand = 10
  )
 
  
```


### S6. Table: Most frequent sites of SPC after lung cancer by sex

```{r, message = FALSE}

tab1s <- d1_zlung_wide %>%
  filter(p_spc == "SPC developed") %>%
  group_by(t_icdgroup_pubdet.2, SEX.1, t_smokeiarc.2) %>%
  summarize(n = n()) %>%
  pivot_wider(names_from = "SEX.1", values_from = "n") %>%
  ungroup() %>%
  mutate(across(c(Male, Female), ~replace_na(., 0))) %>%
  #calculate percentages
    mutate(Male_perc = Male / sum(Male),
           Female_perc = Female / sum(Female),
           Total = Male + Female,
           Total_perc = Total / sum(Total))   %>%
  dplyr::mutate(t_smokeiarc.2 = 
                    case_when(t_smokeiarc.2 == "smoking-related IARC" ~ "🚬",
                                              TRUE ~ "no"))

res_sites_frequent_male <- tab1s %>%
  arrange(desc(Male_perc)) %>%
  mutate(verbal = paste0(t_icdgroup_pubdet.2, " with ", Male, " (", round(Male_perc*100, 0), "%)", " cases")) %>%
  select(verbal) %>%
  slice_head(n = 5) %>%
  unlist %>%
  unname

res_sites_frequent_female <- tab1s %>%
  arrange(desc(Female_perc)) %>%
  mutate(verbal = paste0(t_icdgroup_pubdet.2, " with ", Female, " (", round(Female_perc*100, 0), "%)", " cases")) %>%
  select(verbal) %>%
  slice_head(n = 5) %>%
  unlist %>%
  unname


  
tab1s_gt <- tab1s  %>%
  #only keep site groups with n > 100 in any gender
  filter(.data$t_icdgroup_pubdet.2 %in% tab1s_groups) %>%
  arrange(desc(Total_perc)) %>%
  #change female prostate to NA
  mutate(Female = case_when(t_icdgroup_pubdet.2 == "Prostate (C61)" ~ NA_real_,
                            TRUE ~ Female),
         Female_perc = case_when(t_icdgroup_pubdet.2 == "Prostate (C61)" ~ NA_real_,
                            TRUE ~ Female_perc)) %>%
  select("Site of Second Primary Cancer" = t_icdgroup_pubdet.2, t_smokeiarc.2, 
         Total, "Total perc" = Total_perc,
         Male, "Male perc" = Male_perc, Female, 
         "Female perc" = Female_perc) %>%
  gt::gt()  %>%
   gt::fmt_percent(
    columns = c("Male perc", "Female perc", "Total perc"),
    decimals = 1
  ) %>%
  gt::tab_header(
    title = "Table: Most frequent sites of SPC after lung cancer by sex",
    subtitle = "Absolute and relative frequency of SPC by site and classification as smoking-related site by IARC") %>%
   #rename columns
    gt::cols_label(
      "t_smokeiarc.2" = "🚬 IARC",
      "Male" = "N",
      "Female" = "N",
      "Total" = "N",
      "Male perc" = "%",
      "Female perc" = "%",
      "Total perc" = "%"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Male",
    columns = all_of(c(
     "Male",
     "Male perc"))
  ) %>%
  tab_spanner(
    label = "Female",
    columns = all_of(c(
     "Female",
     "Female perc"))
  ) %>%
    tab_spanner(
    label = "Total",
    columns = all_of(c(
     "Total",
     "Total perc"))
  ) %>%
  gt::tab_footnote("only showing sites with at least 100 SPC cases.", 
                   locations = gt::cells_column_labels(columns = c("Site of Second Primary Cancer"))) %>%
  gt::tab_footnote(paste0("Smoking-related sites are defined as all cancer locations for which the International Agency for Research on Cancer (IARC) has established that tobacco smoking has as a carcinogenic agent with sufficient evidence in humans (", ref_iarc,")."),
                   locations = gt::cells_column_labels(columns = c(t_smokeiarc.2))) %>%
  #formatting
    gt::cols_align(
    align = "center",
    columns = c(t_smokeiarc.2)
  ) %>%
  gt:: cols_width(
    ends_with("perc") ~ px(50),
    c(Male, Female, Total) ~ px(80)
  )

tab1s_gt
  
#save table
tab1s_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sites_freq.png"),
    vwidth = 800, expand = 10
  )
 



```

Of the `r sum(tab1s$Male)` cases of SPC in males the most frequent sites affected by the second primary were `r res_sites_frequent_male`. In females `r res_sites_frequent_female` were most affected. Besides Prostate and Breast cancer, the most frequent SPC only occur in smoking-related sites as defined by IARC (Table S7).


### S7/8. Table: Site-specific SIRs by follow-up time

#### prepare Table

```{r}

#second summarize by grouped ICD-Site
supp_sir_sum_tab_sites <- sir_d1_results %>%
    filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_icdgroup_pubdet as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  cr_icdgroup_vars_smoke_tt(., "t_site", en_gb = en_gb) %>%
    dplyr::mutate(t_smokeiarc = 
                    case_when(t_smokeiarc == "smoking-related IARC" ~ "🚬",
                                              TRUE ~ "no")) %>%
  #change row for "other" category
  dplyr::mutate(site_sort = str_sub(t_site, -3)) %>%
  dplyr::arrange(sex, site_sort) %>%
  dplyr::relocate(t_smokeiarc, .after = yvar_label) %>%
  select(-t_smoke_barclay, -t_smoke_boakye, -site_sort) 
  
```


#### Create single plots


```{r}

#males
names_icdgroup_males <- supp_sir_sum_tab_sites %>%
  #Males 
  dplyr::filter(sex == "Male" & `Total 0.5 to Inf years__expected` > 0) %>%
  pull(t_site) %>%
  as.character()

supp_sir_sum_tab_plots_m <- sir_sum_d1_icdgroup %>%
  filter(sex == "Male" & fu_time == "Total 0.5 to Inf years") %>%
  mutate(sir = case_when(sir < 0.3 ~ 0.01,
                         sir > 10 ~ 10,
                         TRUE ~ sir)) %>%
  mutate(sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                         sir_lci > 10 ~ 10,
                         TRUE ~ sir_lci)) %>%
  mutate(sir_uci = case_when(sir_uci < 0.3 ~ 0.3,
                         sir_uci > 10 ~ 10,
                         TRUE ~ sir_uci)) %>%
  lapply(names_icdgroup_males, plot_sir_forest, 
         results_df = ., cat_var = t_site, show_site = FALSE, show_scale = FALSE, color = colors_2_sex["Male"])

names(supp_sir_sum_tab_plots_m) <- names_icdgroup_males


#females
names_icdgroup_females <- supp_sir_sum_tab_sites %>%
  dplyr::filter(sex == "Female" & `Total 0.5 to Inf years__expected` > 0) %>%
  pull(t_site) %>%
  as.character()

supp_sir_sum_tab_plots_f <- sir_sum_d1_icdgroup %>%
  filter(sex == "Female" & fu_time == "Total 0.5 to Inf years") %>%
  mutate(sir = case_when(sir < 0.3 ~ 0.01,
                         sir > 10 ~ 10,
                         TRUE ~ sir)) %>%
  mutate(sir_lci = case_when(sir_lci < 0.3 ~ 0.3,
                         sir_lci > 10 ~ 10,
                         TRUE ~ sir_lci)) %>%
  mutate(sir_uci = case_when(sir_uci < 0.3 ~ 0.3,
                         sir_uci > 10 ~ 10,
                         TRUE ~ sir_uci)) %>%
  lapply(names_icdgroup_females, plot_sir_forest, 
         results_df = ., cat_var = t_site, show_site = FALSE, show_scale = FALSE, color = colors_2_sex["Female"])

names(supp_sir_sum_tab_plots_f) <- names_icdgroup_females

supp_sir_sum_tab_plots_m[[1]]
supp_sir_sum_tab_plots_m[[21]]
supp_sir_sum_tab_plots_f[[1]]
```


#### Create Table - Males

```{r}
#row height in px
rh <- 35
#aspect ratio
ar <- 4

#create table for males
supp_tab_sites_m_gt <- supp_sir_sum_tab_sites %>%
  #Males 
  dplyr::mutate(yvar_label = t_site) %>%
  dplyr::filter(sex == "Male" & `Total 0.5 to Inf years__expected` > 0.05) %>%
    select(-age, -region, -sex, -year) %>%
  #censor expected and observed < 5
  dplyr::mutate(`Total 0.5 to Inf years__expected` = case_when(`Total 0.5 to Inf years__expected` < 5 | `Total 0.5 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected`),
                `Total 0.5 to Inf years__observed` = case_when(is.na(`Total 0.5 to Inf years__expected`) | `Total 0.5 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed`)) %>%
    #add note to Lung cancer SIR
  dplyr::mutate(yvar_label = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung* (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", 
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: Site-specific SIRs for males stratified by follow-up time",
    subtitle = "Only showing SPC sites with more than 0.05 expected cases.") %>%
      gt::tab_stubhead(
    label = "Site"
       ) %>%
  #rename columns
    gt::cols_label(
      "t_smokeiarc" = "🚬 \nIARC",
      "t_site" = "",
      "Total 0.5 to Inf years__observed" = "O",
      "Total 0.5 to Inf years__expected" = "E",
      "Total 0.5 to Inf years__sir" = "SIR",
      "Total 0.5 to Inf years__sir_lci" = "95% CI",
      "Total 0.5 to Inf years__pyar" = "PYAR",
      "Total 0.5 to Inf years__n_base" = "N",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "Site"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total 6 months to 10+ years",
    columns = all_of(c(
      "t_site",
     "Total 0.5 to Inf years__observed",
      "Total 0.5 to Inf years__expected",
      "Total 0.5 to Inf years__sir",
      "Total 0.5 to Inf years__sir_lci",
      "Total 0.5 to Inf years__pyar",
     "Total 0.5 to Inf years__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
   #column formatting
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(1)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(2)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(3)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(4)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(5)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(6)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(7)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(8)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(9)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(10)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(11)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(12)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(13)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(14)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(15)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(16)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(17)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(18)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(19)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(20)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(21)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(22)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(23)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(24)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(25)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(26)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(27)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(28)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(29)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(30)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(31)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(32)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(33)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(34)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(35)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(36)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(37)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(38)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(39)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
      text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(40)),
                   fn = function(x) {supp_sir_sum_tab_plots_m[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
       gt::fmt_number(
    columns = contains(c("pyar", "observed")),
    decimals = 0
  ) %>%
       gt::fmt_number(
    columns = contains(c("expected")),
    decimals = 1
  ) %>%
  gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "🚬 smoking-related cancer site; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons; ", "* SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section).")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_stubhead(),
      cells_column_labels(ends_with(c("sir", "yvar_label"))), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  gt::cols_align(
    align = "left",
    columns = c(yvar_label)
  ) %>%
    gt::cols_align(
    align = "center",
    columns = c(t_smokeiarc)
  ) %>%
  gt:: cols_width(
    c(yvar_label) ~ px(225),
    c(t_smokeiarc) ~ px(30),
    ends_with(c("sir")) ~ px(50)
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(1),        # reduce row height
                  row_group.padding = px(5),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
supp_tab_sites_m_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sites_male.png"),
    vwidth = 1400, expand = 10
  )


```


#### Create Table - Females
```{r}
#row height in px
rh <- 35
#aspect ratio
ar <- 4

#create table for females
supp_tab_sites_f_gt <- supp_sir_sum_tab_sites %>%
  #Males 
  dplyr::mutate(yvar_label = t_site) %>%
  dplyr::filter(sex == "Female" & `Total 0.5 to Inf years__expected` > 0.05) %>%
    select(-age, -region, -sex, -year) %>%
   #censor expected and observed < 5
  dplyr::mutate(`Total 0.5 to Inf years__expected` = case_when(`Total 0.5 to Inf years__expected` < 5 | `Total 0.5 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected`),
                `Total 0.5 to Inf years__observed` = case_when(is.na(`Total 0.5 to Inf years__expected`) | `Total 0.5 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed`)) %>%
   #add note to Lung cancer SIR
  dplyr::mutate(yvar_label = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung* (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", 
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: Site-specific SIRs for females stratified by follow-up time",
    subtitle = "Only showing SPC sites with more than 0.05 expected cases.") %>%
      gt::tab_stubhead(
    label = "Site"
       ) %>%
  #rename columns
    gt::cols_label(
      "t_smokeiarc" = "🚬 \nIARC",
      "t_site" = "",
      "Total 0.5 to Inf years__observed" = "O",
      "Total 0.5 to Inf years__expected" = "E",
      "Total 0.5 to Inf years__sir" = "SIR",
      "Total 0.5 to Inf years__sir_lci" = "95% CI",
      "Total 0.5 to Inf years__pyar" = "PYAR",
      "Total 0.5 to Inf years__n_base" = "N",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "Site"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total 6 months to 10+ years",
    columns = all_of(c(
      "t_site",
     "Total 0.5 to Inf years__observed",
      "Total 0.5 to Inf years__expected",
      "Total 0.5 to Inf years__sir",
      "Total 0.5 to Inf years__sir_lci",
      "Total 0.5 to Inf years__pyar",
     "Total 0.5 to Inf years__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
   #column formatting
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(1)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(2)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(3)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(4)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(5)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(6)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(7)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(8)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(9)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(10)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(11)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(12)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(13)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(14)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(15)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(16)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(17)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(18)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(19)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(20)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(21)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(22)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(23)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(24)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(25)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(26)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(27)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(28)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(29)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(30)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(31)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(32)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(33)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(34)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(35)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(36)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(37)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(38)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(39)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(40)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
    text_transform(locations = gt::cells_body(columns = c(t_site),
                                              row = c(41)),
                   fn = function(x) {supp_sir_sum_tab_plots_f[[as.character(x)]] %>% ggplot_image(height = px(rh), aspect_ratio = ar)}
                   ) %>%
     gt::fmt_number(
    columns = contains(c("pyar", "observed")),
    decimals = 0
  ) %>%
       gt::fmt_number(
    columns = contains(c("expected")),
    decimals = 1
  ) %>%
    gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "🚬 smoking-related cancer site; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons; ", "* SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section).")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_stubhead(),
      cells_column_labels(ends_with(c("sir", "yvar_label"))), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  gt::cols_align(
    align = "left",
    columns = c(yvar_label)
  ) %>%
    gt::cols_align(
    align = "center",
    columns = c(t_smokeiarc)
  ) %>%
  gt:: cols_width(
    c(yvar_label) ~ px(225),
    c(t_smokeiarc) ~ px(30)
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(1),        # reduce row height
                  row_group.padding = px(5),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
supp_tab_sites_f_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sites_female.png"),
    vwidth = 1400, expand = 10
  )


```

### S9. Table: Sensitivity analysis – Incidence of SPC in most frequent cancer sites when excluding DCO in observed and expected SPC

#### Prepare Table S9

```{r}
#first summarize results by ICD group
sens1_nodco_tab_results_icdgroup <- sens1_nodco_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(t_site, en_gb = en_gb) 

#second summarize results by smoking-related IARC
sens1_nodco_tab_results_smokerel <- sens1_nodco_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sens1_nodco_tab_results <- rbind(sens1_nodco_tab_results_icdgroup, sens1_nodco_tab_results_smokerel)
rm(sens1_nodco_tab_results_icdgroup, sens1_nodco_tab_results_smokerel)

#get the same information for the main analysis to allow comparison
#first summarize results by ICD group
sens1_nodco_tab_results_icdgroup_main <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(t_site, en_gb = en_gb) 

#second summarize results by smoking-related IARC
sens1_nodco_tab_results_smokerel_main <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sens1_nodco_tab_results_main <- rbind(sens1_nodco_tab_results_icdgroup_main, sens1_nodco_tab_results_smokerel_main) %>%
  select(sex, t_site, tidyselect::starts_with("Total"))

rm(sens1_nodco_tab_results_icdgroup_main, sens1_nodco_tab_results_smokerel_main)

#merge two data sets together
sens1_nodco_tab <- sens1_nodco_tab_results %>%
  full_join(., sens1_nodco_tab_results_main, by = c("sex", "t_site")) %>%
  select(-t_smoke_barclay, -t_smoke_boakye) %>%
  mutate(t_smokeiarc = case_when(t_smokeiarc == "smoking-related IARC" ~ "🚬",
                                 TRUE                                  ~ "no")) %>%
  dplyr::filter(t_site %in% c("Total", "smoking-related IARC", "other cancer", names_icdgroup_sel)) %>%
  dplyr::filter(!(t_site == "Breast (C50)" & sex == "Male")) %>%
  dplyr::filter(!(t_site == "Prostate (C61)" & sex == "Female"))

rm(sens1_nodco_tab_results, sens1_nodco_tab_results_main)

#calculate differences
sens1_nodco_tab <- sens1_nodco_tab %>%
  mutate(diff_sir = `Total 0.5 to Inf years__sir.x` - `Total 0.5 to Inf years__sir.y`,
         diff_observed = `Total 0.5 to Inf years__observed.x` - `Total 0.5 to Inf years__observed.y`,
         diff_expected = `Total 0.5 to Inf years__expected.x` - `Total 0.5 to Inf years__expected.y`,
         diff_pyar = `Total 0.5 to Inf years__pyar.x` - `Total 0.5 to Inf years__pyar.y`,
         diff_sir_lci = `Total 0.5 to Inf years__sir_lci.x` - `Total 0.5 to Inf years__sir_lci.y`,
         diff_sir_uci = `Total 0.5 to Inf years__sir_uci.x` - `Total 0.5 to Inf years__sir_uci.y`,
         diff_n_base = `Total 0.5 to Inf years__n_base.x` - `Total 0.5 to Inf years__n_base.y`)

```

#### Create Tab Sens1:

```{r}

#create table for males
sens1_nodco_tab_gt <- sens1_nodco_tab %>%
    dplyr::relocate(all_of(c("t_site", "t_smokeiarc")), .after = "yvar_label") %>%
      dplyr::relocate(all_of(c("diff_observed", "diff_expected", "diff_sir", "diff_pyar", "diff_n_base")), .after = "Total 0.5 to Inf years__n_base.x") %>%
    #censor expected and observed < 5
  dplyr::mutate(`Total 0.5 to Inf years__expected.y` = case_when(`Total 0.5 to Inf years__expected.y` < 5 | `Total 0.5 to Inf years__observed.y` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected.y`),
                `Total 0.5 to Inf years__observed.y` = case_when(is.na(`Total 0.5 to Inf years__expected.y`) | `Total 0.5 to Inf years__observed.y` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed.y`),
                `Total 0.5 to Inf years__expected.x` = case_when(`Total 0.5 to Inf years__expected.x` < 5 | `Total 0.5 to Inf years__observed.x` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected.x`),
                `Total 0.5 to Inf years__observed.x` = case_when(is.na(`Total 0.5 to Inf years__expected.x`) | `Total 0.5 to Inf years__observed.x` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed.x`)) %>%
    #add note to Lung cancer SIR
  dplyr::mutate(t_site = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung* (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("age", "region", "sex", "year", "yvar_name", "yvar_label", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", 
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base",
                       "diff_pyar", "diff_n_base", "diff_sir_lci", "diff_sir_uci"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: Sensitivity analysis – Incidence of SPC in most frequent cancer sites when excluding DCO in observed and expected SPC",
    subtitle = "Comparing results of sensitivity analysis to main analysis results") %>%
  #rename columns
    gt::cols_label(
      "t_smokeiarc" = "🚬 \nIARC",
      "t_site" = "Site",
      "Total 0.5 to Inf years__observed.x" = "O",
      "Total 0.5 to Inf years__expected.x" = "E",
      "Total 0.5 to Inf years__sir.x" = "SIR",
      "Total 0.5 to Inf years__sir_lci.x" = "95% CI",
      "Total 0.5 to Inf years__pyar.x" = "PYAR",
      "Total 0.5 to Inf years__n_base.x" = "N",
      "diff_observed" = "Δ O",
      "diff_expected" = "Δ E",
      "diff_sir" = "Δ SIR",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "Site",     
      "Total 0.5 to Inf years__observed.y" = "O",
      "Total 0.5 to Inf years__expected.y" = "E",
      "Total 0.5 to Inf years__sir.y" = "SIR",
      "Total 0.5 to Inf years__sir_lci.y" = "95% CI",
      "Total 0.5 to Inf years__pyar.y" = "PYAR",
      "Total 0.5 to Inf years__n_base.y" = "N"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total sensitivity analysis no DCO",
    columns = all_of(c(
     "Total 0.5 to Inf years__observed.x",
      "Total 0.5 to Inf years__expected.x",
      "Total 0.5 to Inf years__sir.x",
      "Total 0.5 to Inf years__sir_lci.x",
      "Total 0.5 to Inf years__pyar.x",
     "Total 0.5 to Inf years__n_base.x"))
  ) %>%
    tab_spanner(
    label = "Difference to main analysis",
    columns = all_of(c(
      "diff_observed",
      "diff_expected",
      "diff_sir"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
  tab_spanner(
    label = "Total main analysis",
    columns = all_of(c(
     "Total 0.5 to Inf years__observed.y",
      "Total 0.5 to Inf years__expected.y",
      "Total 0.5 to Inf years__sir.y",
      "Total 0.5 to Inf years__sir_lci.y",
      "Total 0.5 to Inf years__pyar.y",
     "Total 0.5 to Inf years__n_base.y"))
  ) %>%
   #make row groups
      gt::tab_row_group(
    label = "Female",
    rows = sex == "Female"
    ) %>%
    gt::tab_row_group(
    label = "Male",
    rows = sex == "Male"
    ) %>%
   #column formatting
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "n_base")),
    decimals = 0
  ) %>%
       gt::fmt_number(
    columns = contains(c("expected")),
    decimals = 1
  ) %>%
    gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci.x"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci.x")
  ) %>%
    cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci.y"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci.y")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
    source_note = paste0("Notes: This sensitivity analysis excluded DCO cases from the observed counts and calculated expected cases using reference rates without DCO", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "🚬 smoking-related cancer site; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons; ", "* SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section).")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_row_groups(all_of(c("Male", "Female"))),
      cells_column_labels(ends_with(c("sir.x", "t_site", "diff_sir"))), 
      cells_body(columns = ends_with(c("sir.x", "diff_sir"))))
    ) %>%
  gt::cols_align(
    align = "left",
    columns = c(t_site)
  ) %>%
    gt::cols_align(
    align = "center",
    columns = c(t_smokeiarc)
  ) %>%
  gt:: cols_width(
    c(t_site) ~ px(200),
    c(t_smokeiarc) ~ px(30),
    ends_with(c("sir", "sir.x", "sir.y")) ~ px(60),
    c(diff_observed) ~ px(50),
    c(diff_expected) ~ px(50)
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(3),        # reduce row height
                  row_group.padding = px(8),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
sens1_nodco_tab_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_sens1_tab_nodco.png"),
    vwidth = 2000, expand = 10
  )


```


```{r}
sens1_nodco_tab_gt
```


### S10. Table: Sensitivity analysis - Incidence of SPC in smoking-related sites for DCO < 10% regions

#### Prepare Tab Sens2: 

```{r}
#first summarize results by ICD group
sens2_lowdcorate_tab_results_icdgroup <- sens2_lowdcorate_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(t_site, en_gb = en_gb) 

#second summarize results by smoking-related IARC
sens2_lowdcorate_tab_results_smokerel <- sens2_lowdcorate_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sens2_lowdcorate_tab_results <- rbind(sens2_lowdcorate_tab_results_icdgroup, sens2_lowdcorate_tab_results_smokerel)
rm(sens2_lowdcorate_tab_results_icdgroup, sens2_lowdcorate_tab_results_smokerel)

#get the same information for the main analysis to allow comparison
#first summarize results by ICD group
sens2_lowdcorate_tab_results_icdgroup_main <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(t_site, en_gb = en_gb) 

#second summarize results by smoking-related IARC
sens2_lowdcorate_tab_results_smokerel_main <- sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sens2_lowdcorate_tab_results_main <- rbind(sens2_lowdcorate_tab_results_icdgroup_main, sens2_lowdcorate_tab_results_smokerel_main) %>%
  select(sex, t_site, tidyselect::starts_with("Total"))

rm(sens2_lowdcorate_tab_results_icdgroup_main, sens2_lowdcorate_tab_results_smokerel_main)

#merge two data sets together
sens2_lowdcorate_tab <- sens2_lowdcorate_tab_results %>%
  full_join(., sens2_lowdcorate_tab_results_main, by = c("sex", "t_site")) %>%
  select(-t_smoke_barclay, -t_smoke_boakye) %>%
  mutate(t_smokeiarc = case_when(t_smokeiarc == "smoking-related IARC" ~ "🚬",
                                 TRUE                                  ~ "no")) %>%
  dplyr::filter(t_site %in% c("Total", "smoking-related IARC", "other cancer", names_icdgroup_sel)) %>%
  dplyr::filter(!(t_site == "Breast (C50)" & sex == "Male")) %>%
  dplyr::filter(!(t_site == "Prostate (C61)" & sex == "Female"))

rm(sens2_lowdcorate_tab_results, sens2_lowdcorate_tab_results_main)

#calculate differences
sens2_lowdcorate_tab <- sens2_lowdcorate_tab %>%
  mutate(diff_sir = `Total 0.5 to Inf years__sir.x` - `Total 0.5 to Inf years__sir.y`,
         diff_observed = `Total 0.5 to Inf years__observed.x` - `Total 0.5 to Inf years__observed.y`,
         diff_expected = `Total 0.5 to Inf years__expected.x` - `Total 0.5 to Inf years__expected.y`,
         diff_pyar = `Total 0.5 to Inf years__pyar.x` - `Total 0.5 to Inf years__pyar.y`,
         diff_sir_lci = `Total 0.5 to Inf years__sir_lci.x` - `Total 0.5 to Inf years__sir_lci.y`,
         diff_sir_uci = `Total 0.5 to Inf years__sir_uci.x` - `Total 0.5 to Inf years__sir_uci.y`,
         diff_n_base = `Total 0.5 to Inf years__n_base.x` - `Total 0.5 to Inf years__n_base.y`)

```

#### Create Tab Sens2:

```{r}

#create table for males
sens2_lowdcorate_tab_gt <- sens2_lowdcorate_tab %>%
    dplyr::relocate(all_of(c("t_site", "t_smokeiarc")), .after = "yvar_label") %>%
      dplyr::relocate(all_of(c("diff_observed", "diff_expected", "diff_sir", "diff_pyar", "diff_n_base")), .after = "Total 0.5 to Inf years__n_base.x") %>%
      #censor expected and observed < 5
  dplyr::mutate(`Total 0.5 to Inf years__expected.y` = case_when(`Total 0.5 to Inf years__expected.y` < 5 | `Total 0.5 to Inf years__observed.y` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected.y`),
                `Total 0.5 to Inf years__observed.y` = case_when(is.na(`Total 0.5 to Inf years__expected.y`) | `Total 0.5 to Inf years__observed.y` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed.y`),
                `Total 0.5 to Inf years__expected.x` = case_when(`Total 0.5 to Inf years__expected.x` < 5 | `Total 0.5 to Inf years__observed.x` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__expected.x`),
                `Total 0.5 to Inf years__observed.x` = case_when(is.na(`Total 0.5 to Inf years__expected.x`) | `Total 0.5 to Inf years__observed.x` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0.5 to Inf years__observed.x`)) %>%
    #add note to Lung cancer SIR
  dplyr::mutate(t_site = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung* (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("age", "region", "sex", "year", "yvar_name", "yvar_label", "yvar_sort", "yvar_sort_levels",
                       "6-12 months__observed", "6-12 months__expected", "6-12 months__pyar",
                            "1-5 years__observed", "1-5 years__expected",  "1-5 years__pyar", "5-10 years__observed",
                            "5-10 years__expected", "5-10 years__pyar", "10+ years__observed", "10+ years__expected", 
                            "10+ years__pyar", 
                       "6-12 months__n_base", "1-5 years__n_base", "5-10 years__n_base", "10+ years__n_base",
                       "diff_pyar", "diff_n_base", "diff_sir_lci", "diff_sir_uci"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: Sensitivity analysis – Incidence of SPC in most frequent cancer sites for six registries with DCO rate of less than 10%",
    subtitle = "Comparing results of sensitivity analysis to main analysis results") %>%
  #rename columns
    gt::cols_label(
      "t_smokeiarc" = "🚬 \nIARC",
      "t_site" = "Site",
      "Total 0.5 to Inf years__observed.x" = "O",
      "Total 0.5 to Inf years__expected.x" = "E",
      "Total 0.5 to Inf years__sir.x" = "SIR",
      "Total 0.5 to Inf years__sir_lci.x" = "95% CI",
      "Total 0.5 to Inf years__pyar.x" = "PYAR",
      "Total 0.5 to Inf years__n_base.x" = "N",
      "diff_observed" = "Δ O",
      "diff_expected" = "Δ E",
      "diff_sir" = "Δ SIR",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "yvar_label" = "Site",     
      "Total 0.5 to Inf years__observed.y" = "O",
      "Total 0.5 to Inf years__expected.y" = "E",
      "Total 0.5 to Inf years__sir.y" = "SIR",
      "Total 0.5 to Inf years__sir_lci.y" = "95% CI",
      "Total 0.5 to Inf years__pyar.y" = "PYAR",
      "Total 0.5 to Inf years__n_base.y" = "N"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total sensitivity analysis <10% DCO",
    columns = all_of(c(
     "Total 0.5 to Inf years__observed.x",
      "Total 0.5 to Inf years__expected.x",
      "Total 0.5 to Inf years__sir.x",
      "Total 0.5 to Inf years__sir_lci.x",
      "Total 0.5 to Inf years__pyar.x",
     "Total 0.5 to Inf years__n_base.x"))
  ) %>%
    tab_spanner(
    label = "Difference to main analysis",
    columns = all_of(c(
      "diff_observed",
      "diff_expected",
      "diff_sir"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
      "6-12 months__sir",
      "6-12 months__sir_lci"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
      "1-5 years__sir",
      "1-5 years__sir_lci"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
      "5-10 years__sir",
      "5-10 years__sir_lci"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
      "10+ years__sir",
      "10+ years__sir_lci"))
  ) %>%
  tab_spanner(
    label = "Total main analysis",
    columns = all_of(c(
     "Total 0.5 to Inf years__observed.y",
      "Total 0.5 to Inf years__expected.y",
      "Total 0.5 to Inf years__sir.y",
      "Total 0.5 to Inf years__sir_lci.y",
      "Total 0.5 to Inf years__pyar.y",
     "Total 0.5 to Inf years__n_base.y"))
  ) %>%
   #make row groups
      gt::tab_row_group(
    label = "Female",
    rows = sex == "Female"
    ) %>%
    gt::tab_row_group(
    label = "Male",
    rows = sex == "Male"
    ) %>%
   #column formatting
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "n_base")),
    decimals = 0
  ) %>%
       gt::fmt_number(
    columns = contains(c("expected")),
    decimals = 1
  ) %>%
    gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci.x"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci.x")
  ) %>%
    cols_merge_range(
    col_begin = all_of("Total 0.5 to Inf years__sir_lci.y"),
    col_end = all_of("Total 0.5 to Inf years__sir_uci.y")
  ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
    tab_source_note(
     source_note = paste0("Notes: The six included registries are Brandenburg 2007 to 2014, Bremen 2004 to 2014, Hamburg 2008 to 2014, Mecklenburg-Western Pomerania 2003 to 2011, Saarland 2002 to 2011 and Saxony 2005 to 2014.", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "🚬 smoking-related cancer site; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons; ", "* SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section).")
  ) %>%
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_row_groups(all_of(c("Male", "Female"))),
      cells_column_labels(ends_with(c("sir.x", "t_site", "diff_sir"))), 
      cells_body(columns = ends_with(c("sir.x", "diff_sir"))))
    ) %>%
  gt::cols_align(
    align = "left",
    columns = c(t_site)
  ) %>%
    gt::cols_align(
    align = "center",
    columns = c(t_smokeiarc)
  ) %>%
  gt:: cols_width(
    c(t_site) ~ px(200),
    c(t_smokeiarc) ~ px(30),
    ends_with(c("sir", "sir.x", "sir.y")) ~ px(60),
    c(diff_observed) ~ px(50),
    c(diff_expected) ~ px(50)
  ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(3),        # reduce row height
                  row_group.padding = px(8),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
sens2_lowdcorate_tab_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_sens2_tab_lowdco.png"),
    vwidth = 2000, expand = 10
  )


```

#### Prepare Fig Sens2: 

```{r}
#preparations
#first summarize results by ICD group
sens2_lowdcorate_figX2_results_icdgroup <- sens2_lowdcorate_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(t_site, en_gb = en_gb) 

#second summarize results by smoking-related IARC
sens2_lowdcorate_figX2_results_smokerel <- sens2_lowdcorate_sir_d1_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
sens2_lowdcorate_figX2_results <- rbind(sens2_lowdcorate_figX2_results_icdgroup, sens2_lowdcorate_figX2_results_smokerel)


#make smoking related appear first
sens2_lowdcorate_figX2_results$t_smokeiarc  <- relevel(sens2_lowdcorate_figX2_results$t_smokeiarc, "smoking-related IARC")
#make sum categories appear fist
sens2_lowdcorate_figX2_results$t_site  <- relevel(sens2_lowdcorate_figX2_results$t_site, "smoking-related IARC")
sens2_lowdcorate_figX2_results$t_site  <- relevel(sens2_lowdcorate_figX2_results$t_site, "other cancer")

rm(sens2_lowdcorate_figX2_results_icdgroup, sens2_lowdcorate_figX2_results_smokerel)
  
```
#### Prepare Fig S2: Plot single rows

```{r}

supp_figX2_sir_max <- 7 #set upper limit for y axis for all r



sens2_lowdcorate_figX2_site_row1 <- c("smoking-related IARC",
                    "Oral cavity (C01-C06)",
                    "Pharynx (C10-C14)",
                    icdgroup_c15_code)
                    

sens2_lowdcorate_figX2_site_row2 <- c("Stomach (C16)",
                    "Colorectum (C18-C20)",
                    "Liver (C22)",
                    "Pancreas (C25)"
                    )

sens2_lowdcorate_figX2_site_row3 <- c("Larynx (C32)",
                          "Lung*** (C33-C34)",
                          "Kidney (C64)",
                          "Urinary tract (C65-C68)")

sens2_lowdcorate_figX2_site_row4 <- c("other cancer", 
                          "Prostate (C61)",
                    "Skin melanoma (C43)",
                    "Breast (C50)")

sens2_lowdcorate_figX2_row1_splot <- sens2_lowdcorate_figX2_results %>%
  plot_sir_byfutime(., sites_to_plot = sens2_lowdcorate_figX2_site_row1, y_lim = supp_figX2_sir_max)

sens2_lowdcorate_figX2_row2_splot <- sens2_lowdcorate_figX2_results %>%
  plot_sir_byfutime(., sites_to_plot = sens2_lowdcorate_figX2_site_row2, y_lim = supp_figX2_sir_max)

sens2_lowdcorate_figX2_row3_splot <- sens2_lowdcorate_figX2_results %>%
     #add note to Lung cancer SIR
  dplyr::mutate(t_site = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung*** (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  plot_sir_byfutime(., sites_to_plot = sens2_lowdcorate_figX2_site_row3, y_lim = supp_figX2_sir_max)

sens2_lowdcorate_figX2_row4_splot <- sens2_lowdcorate_figX2_results %>%
  plot_sir_byfutime(., sites_to_plot = sens2_lowdcorate_figX2_site_row4, y_lim = supp_figX2_sir_max, vlab_y_pos = 2.8, vlab_y_diff = 0.5)


sens2_lowdcorate_figX2_row1_splot
```

#### Plot Figure S2

```{r}
#design layout for plots; # stands for empty region

supp_figX1_layout  <- "
1
2
3
4
"

sens2_lowdcorate_figX2 <- sens2_lowdcorate_figX2_row1_splot +
  sens2_lowdcorate_figX2_row2_splot + 
  sens2_lowdcorate_figX2_row3_splot + 
  sens2_lowdcorate_figX2_row4_splot +
  plot_layout(design = supp_figX1_layout) +
      #Label Title and Caption
  plot_annotation(
        title = element_text(paste0("Figure S2: Incidence of SPC in most frequent cancer sites 
                  for six registries with DCO rate of less than 10% (n=", format(nrow(sens2_lowdcorate_d1_zlung_wide), big.mark = ","), ")")),
     caption = element_text(
  "Notes: The six included registries are Brandenburg 2007 to 2014, Bremen 2004 to 2014, Hamburg 2008 to 2014, 
            Mecklenburg-Western Pomerania 2003 to 2011, Saarland 2002 to 2011 and Saxony 2005 to 2014.
            SIR is only calculated for strata with at least 5 expected cases. Numeric values are given for total follow-up time (0 months to 10+ years).
            *  Total for \"Smoking-related cancers\" includes all SPC with locations C01-C06, C10-C14 C15-16, C18-20, C22, C25, C30-34, C53, C56, C64-67, C92.
            ** Total for \"Other cancers\" includes all other locations.
            **** SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section)."),
  theme = theme(plot.caption = element_text(hjust = 0),
                #create common legend and axis labels
                legend.position="bottom"))  +
     ylab("Risk of SPC (SIR)") +
    xlab("Follow-up time after LC")


#print figure
sens2_lowdcorate_figX2

#save figure
sens2_lowdcorate_figX2 %>%
  ggsave(filename = file.path(output_dir_tables, "supp_fig_sens_lowdco.png"),
         width = 9, height = 11)


```


```{r}
sens2_observed <- sens2_lowdcorate_d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow()

sens2_perc <-  (sens2_lowdcorate_d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow()) / (d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow()) * 100

res_pyars_lowdco <- ((sens2_lowdcorate_figX2_results %>% filter(sex == "Male" & yvar_name == "total_var" & fu_time == "Total 0.5 to Inf years" & t_site == "smoking-related IARC") %>% pull(pyar)) + (sens2_lowdcorate_figX2_results %>% filter(sex == "Female" & yvar_name == "total_var" & fu_time == "Total 0.5 to Inf years" & t_site == "smoking-related IARC") %>% pull(pyar))) %>% round(.,0) %>% format(., big.mark = ",")
res_obs_lowdco <- sens2_lowdcorate_d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow() %>% format(., big.mark = ",")
res_obs_lowdco_perc <- ((sens2_lowdcorate_d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow()) / (d1_zlung_wide %>% filter(p_spc == "SPC developed") %>% nrow())) %>% "*"(100) %>% round(., 1) %>% format(., nsmall = 1)

```

Second, restricting analyses to as subset of regional registries that presumedly had higher cancer registration quality (by showing DCO rates constantly below 10%) removed a large proportion of our observations. Only 6 registries fulfilled that criterion and also only for part of the observation period, so that total person-years at risk were reduced to xxx resulting in very small observed and expected counts (O = `r sens2_observed`, only `r sens2_perc`% of the main analysis set) and thus unreliable estimation of SIRs [see Supplement S9]

### SXX. Table: Risk of smoking-related cancer in comparison to other definitions and to England and the US

#### Calculate SIR for Table 3

```{r}
#Calculate missing summaries using smokeiarc, smoke_barclay and smoke_boakye

sir_sum_tab3_smoke_iarc <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smokeiarc as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    )

sir_sum_tab3_smoke_barc <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smoke_barclay as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smoke_barclay",
                                    alpha = 0.05
                                    )
sir_sum_tab3_smoke_boak <- sir_d1_results %>%
  filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using smoke_boakye as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smoke_boakye",
                                    alpha = 0.05
                                    )

sir_sum_tab3 <- bind_rows(sir_sum_tab3_smoke_iarc, sir_sum_tab3_smoke_barc, sir_sum_tab3_smoke_boak)

rm(sir_sum_tab3_smoke_iarc, sir_sum_tab3_smoke_barc, sir_sum_tab3_smoke_boak)

```

####Prepare Table 3

```{r}

tab3 <- sir_sum_tab3 %>%
  filter(t_site %in% c("smoking-related IARC",
                           "smoking-related cancer (Barclay)",
                           "smoking-related cancer (Boakye)") &
           (yvar_name == "SEX.1" | yvar_name == "total_var")) %>%
    mutate(yvar_label = case_when(
    t_site == "smoking-related IARC" & yvar_label == "Female" ~ "Females: Smoking-related (IARC definition)",
    t_site == "smoking-related IARC" & yvar_label == "Male" ~ "Males: Smoking-related (IARC definition)",
    t_site == "smoking-related IARC" & yvar_label == "Overall" ~ "Total: Smoking-related (IARC definition)",
    t_site == "smoking-related cancer (Barclay)" & yvar_label == "Female" ~ "Females: Smoking-related (Barclay et al. definition)",
    t_site == "smoking-related cancer (Barclay)" & yvar_label == "Male" ~ "Males: Smoking-related (Barclay et al. definition)",
    t_site == "smoking-related cancer (Barclay)" & yvar_label == "Overall" ~ "Total: Smoking-related (Barclay et al. definition)",
    t_site == "smoking-related cancer (Boakye)" & yvar_label == "Female" ~ "Females: Smoking-related (Boakye et al. definition)",
    t_site == "smoking-related cancer (Boakye)" & yvar_label == "Male" ~ "Males: Smoking-related (Boakye et al. definition)",
      t_site == "smoking-related cancer (Boakye)" & yvar_label == "Overall" ~ "Total: Smoking-related (Boakye et al. definition)",
    TRUE ~ NA_character_
  )) %>%
  rename(measure = yvar_label,
         ger_sir = "Total 0.5 to Inf years__sir", 
         ger_sir_lci = "Total 0.5 to Inf years__sir_lci", 
         ger_sir_uci = "Total 0.5 to Inf years__sir_uci") %>%
  select(measure, ger_sir, ger_sir_lci, ger_sir_uci) %>%
  mutate(uk_sir = NA_real_,
         uk_sir_lci = NA_real_,
         uk_sir_uci = NA_real_,
         us_sir = NA_real_,
         us_sir_lci = NA_real_,
         us_sir_uci = NA_real_) %>%
  #manually add results from publications
  rows_update(tibble(measure = "Females: Smoking-related (Barclay et al. definition)", uk_sir = 1.98, uk_sir_lci = 1.86, uk_sir_uci = 2.12), by = "measure") %>%
   rows_update(tibble(measure = "Males: Smoking-related (Barclay et al. definition)", uk_sir = 1.36, uk_sir_lci = 1.29, uk_sir_uci = 1.43), by = "measure") %>% 
     rows_update(tibble(measure = "Total: Smoking-related (Barclay et al. definition)", uk_sir = 1.55, uk_sir_lci = 1.49, uk_sir_uci = 1.61), by = "measure") %>% 
     rows_update(tibble(measure = "Total: Smoking-related (Boakye et al. definition)", us_sir = 1.62, us_sir_lci = 1.60, us_sir_uci = 1.64), by = "measure") %>%
  arrange(desc(measure))

```

#### Table 3: Put parts together

```{r}
tab3_gt <- tab3 %>%
   #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
   #make header
  gt::tab_header(
    title = "Table: Risk of smoking-related cancer in comparison to other definitions and to England and the US",
    subtitle = "SIR for smoking-related cancer using different definitions of smoking-relatedness and comparing to data from England and the United States") %>%
  #rename columns
    gt::cols_label(
      ger_sir = "SIR",
      ger_sir_lci = "95% CI",
      uk_sir = "SIR",
      uk_sir_lci = "95% CI",
      us_sir = "SIR",
      us_sir_lci = "95% CI",
      measure = ""
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = md("**Germany**<br>2002–2013<br>49% population coverage"),
    id = "ger",
    columns = all_of(c(
      "ger_sir",
      "ger_sir_lci"))
  ) %>%
  tab_spanner(
    label = md("**England**<br>2000–2014<br>98% population coverage"),
    id = "uk",
    columns = all_of(c(
      "uk_sir",
      "uk_sir_lci"))
  ) %>%
    tab_spanner(
    label = md("**US (SEER18)**<br>2000–2014<br>30% population coverage"),
    id = "us",
    columns = all_of(c(
      "us_sir",
      "us_sir_lci"))
  ) %>%
  #make row groups
  gt::tab_row_group(
    label = "Total",
    rows = str_detect(measure, "^Total")
    ) %>%
    gt::tab_row_group(
    label = "Males",
    rows = str_detect(measure, "^Males")
    ) %>%
    gt::tab_row_group(
    label = "Females",
    rows = str_detect(measure, "^Females")
    ) %>%
    #column formatting
  #fmt numbers
  gt::fmt_number(
    columns = contains("sir"),
    decimals = 2
  ) %>%
  #fmt missing
  fmt_missing(
    columns = ends_with("sir"),
    missing_text = "---") %>%
    fmt_missing(
    columns = ends_with("lci"),
    missing_text = "") %>%
  #fmt ci
  cols_merge_range(
    col_begin = all_of("ger_sir_lci"),
    col_end = all_of("ger_sir_uci")
  ) %>%
  cols_merge_range(
    col_begin = all_of("uk_sir_lci"),
    col_end = all_of("uk_sir_uci")
  ) %>%
  cols_merge_range(
    col_begin = all_of("us_sir_lci"),
    col_end = all_of("us_sir_uci")
  ) %>%
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(ends_with("sir")), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  #Notes 
  tab_source_note(md(paste0("Notes: Smoking-relatedness definition by *IARC* (", ref_iarc, ") includes C01-C06, C10-14, C15-16, C18-20, C22, C25, C30-34, C53, C56, C64-68, C92. *Boakye* definition is based on Boakye et al. 2019 (", ref_boakye, ") and includes C00-14, C15-16, C18-20, C22, C25, C30-31, C33-34, C53, C64, C67. *Barclay* definition is based on Barclay et al. 2019 (", ref_barclay, ") and includes C00-14, C15, C31, C33-34, C67. <br> 
                  SIR for *Germany* are calculated by the authors using the three different definitions of smoking-relatedness. SIR for *England* are taken from Barclay et al. 2019. SIR for the *US* are taken from Boakye et al. 2019."))) %>%
    # gt::tab_footnote(
    # footnote = "SIR for Germany are calculated by the authors using the three different definitions of smoking-relatedness.",
    # locations = cells_column_spanners(spanners = "ger")
    # ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(row.striping.include_stub = TRUE) 

#save table
tab3_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_smo_comparison.png"),
    expand = 10
  )

#print table
tab3_gt

```


### S11. Figure: Incidence of SPC in most frequent cancer sites including lung cancer patients with less than 6 months follow-up

#### Prepare Fig S1
```{r}
#preparations
#first summarize results by ICD group
supp_figX1_results_icdgroup <- sir_d2_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
  cr_icdgroup_vars_smoke_tt(., sitegroup_var = "t_site", en_gb = en_gb) 

#second summarize results by smoking-related IARC
supp_figX1_results_smokerel <- sir_d2_results %>%
  filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year"),
                                    summarize_site = FALSE,
                                    output = "long",  output_information = "reduced",
                                    add_total_row = "no",  add_total_fu = "no",
                                    collapse_ci = FALSE,  shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    ) %>%
  #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                   ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 

#bind together
supp_figX1_results <- rbind(supp_figX1_results_icdgroup, supp_figX1_results_smokerel)


#make smoking related appear first
supp_figX1_results$t_smokeiarc  <- relevel(supp_figX1_results$t_smokeiarc, "smoking-related IARC")
#make sum categories appear fist
supp_figX1_results$t_site  <- relevel(supp_figX1_results$t_site, "smoking-related IARC")
supp_figX1_results$t_site  <- relevel(supp_figX1_results$t_site, "other cancer")

rm(supp_figX1_results_icdgroup, supp_figX1_results_smokerel)
  
```
#### Prepare Fig S1: Plot single rows

```{r}

supp_figX1_sir_max <- 18 #set upper limit for y axis for all rows

supp_figX1_site_row1 <- c("smoking-related IARC",
                    "Oral cavity (C01-C06)",
                    "Pharynx (C10-C14)",
                    icdgroup_c15_code)
                    

supp_figX1_site_row2 <- c("Stomach (C16)",
                    "Colorectum (C18-C20)",
                    "Liver (C22)",
                    "Pancreas (C25)"
                    )

supp_figX1_site_row3 <- c("Larynx (C32)",
                          "Lung*** (C33-C34)",
                          "Kidney (C64)",
                          "Urinary tract (C65-C68)")

supp_figX1_site_row4 <- c("other cancer", 
                          "Prostate (C61)",
                    "Skin melanoma (C43)",
                    "Breast (C50)")

supp_figX1_row1_splot <- supp_figX1_results %>%
  plot_sir_byfutime(., sites_to_plot = supp_figX1_site_row1, timecats_to_plot = c("to 6 months", "6-12 months", "1-5 years", "5-10 years", "Total"), y_lim = supp_figX1_sir_max, vlab_y_pos = 0.6, vlab_y_diff = 0.15)

supp_figX1_row2_splot <- supp_figX1_results %>%
  plot_sir_byfutime(., sites_to_plot = supp_figX1_site_row2, timecats_to_plot = c("to 6 months", "6-12 months", "1-5 years", "5-10 years", "Total"), y_lim = supp_figX1_sir_max, vlab_y_pos = 0.6, vlab_y_diff = 0.15)

supp_figX1_row3_splot <- supp_figX1_results %>%
  #add note to Lung cancer SIR
  dplyr::mutate(t_site = dplyr::case_when(
    t_site == "Lung (C33-C34)" ~ "Lung*** (C33-C34)",
    TRUE ~ as.character(t_site))) %>%
  plot_sir_byfutime(., sites_to_plot = supp_figX1_site_row3, timecats_to_plot = c("to 6 months", "6-12 months", "1-5 years", "5-10 years", "Total"), y_lim = supp_figX1_sir_max, vlab_x_off = -0.6, vlab_y_diff = 0.13)

supp_figX1_row4_splot <- supp_figX1_results %>%
  plot_sir_byfutime(., sites_to_plot = supp_figX1_site_row4, timecats_to_plot = c("to 6 months", "6-12 months", "1-5 years", "5-10 years", "Total"), y_lim = supp_figX1_sir_max, vlab_y_diff = 0.13)


supp_figX1_row1_splot
```


#### Plot Fig S1


```{r}
#design layout for plots; # stands for empty region

supp_figX1_layout  <- "
1
2
3
4
"

supp_figX1 <- supp_figX1_row1_splot + supp_figX1_row2_splot + supp_figX1_row3_splot + supp_figX1_row4_splot +
  plot_layout(design = supp_figX1_layout) +
    #Label Title and Caption
  plot_annotation(
    title = element_text(paste0("Figure: Incidence of SPC in most frequent cancer sites 
             including lung cancer patients with less than 6 months follow-up (n=", format(nrow(d2_zlung_wide), big.mark = ","), ")")),
    caption = element_text(
  "Notes: SIR is only calculated for strata with at least 5 expected cases. Numeric SIR values are given for total follow-up time (0 months to 10+ years).
            *  Total for \"Smoking-related cancers\" includes all SPC with locations C01-C06, C10-C14 C15-16, C18-20, C22, C25, C30-34, C53, C56, C64-67, C92.
            ** Total for \"Other cancers\" includes all other locations.
            *** SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section)."),
  theme = theme(plot.caption = element_text(hjust = 0)) #left alignment of caption
  )  


#print figure
supp_figX1

#save figure
supp_figX1 %>%
  ggsave(filename = file.path(output_dir_tables, "supp_fig_sir_allfu.png"),
         width = 9, height = 11)


```

### S12. Table: SIRs stratified by relevant factors and by follow-up time including lung cancer patients with less than 6 months follow-up

#### Prepare Tab S2

```{r}
#preparations
#first summarize results by ICD group
supp_sir_sum_tab2_smokegroups <- sir_d2_results %>%
    filter(yvar_name == "SEX.1" | yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "full",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_smokeiarc",
                                    alpha = 0.05
                                    )  %>%
    #add smoking vars for new groups
    dplyr::mutate(
      t_smokeiarc = case_when(
        t_site == "smoking-related IARC" ~ 1, 
        !is.na(t_site)                     ~ 0, #all other cancers
        TRUE ~ NA_real_),
      t_smoke_barclay = "NA",
      t_smoke_boakye = "NA") %>%
    sjlabelled::var_labels(t_smokeiarc="Smoking-related Cancer type (IARC definition)") %>%
    sjlabelled::set_labels(t_smokeiarc, labels = c("other cancer" = 0,
                                                   "smoking-related IARC" = 1)) %>%
    dplyr::mutate(dplyr::across(.cols = t_smokeiarc, .fns = ~sjlabelled::as_label(.x , keep.labels=TRUE))) 
  

supp_sir_sum_tab2_sites <- sir_d2_results %>%
   filter(yvar_name == "total_var") %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = FALSE,
                                    output = "wide",  output_information = "full",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_icdgroup_pubdet",
                                    alpha = 0.05
                                    ) %>%
   cr_icdgroup_vars_smoke_tt(., sitegroup_var = "t_site", en_gb = en_gb) %>%
  select(-t_smoke_barclay, -t_smoke_boakye)

supp_sir_sum_tab2_totals <- sir_d2_results %>%
  #summarize results across region, age, year using t_smoke as site differentiation
  msSPChelpR::summarize_sir_results(.,
                                    summarize_groups = c("region", "age", "year", "sex"),
                                    summarize_site = TRUE,
                                    output = "wide",  output_information = "full",
                                    add_total_row = "no",  add_total_fu = "start",
                                    shorten_total_cols = TRUE,
                                    fubreak_var_name = "fu_time", ybreak_var_name = "yvar_name",
                                    xbreak_var_name = "none", site_var_name = "t_site",
                                    alpha = 0.05
                                    ) 

supp_tabX2 <- bind_rows(supp_sir_sum_tab2_totals, supp_sir_sum_tab2_sites, supp_sir_sum_tab2_smokegroups) %>%
  select(-age, -region, -sex, -year) %>%
  #for sites, copy values to yvar_label
  mutate(yvar_label = case_when(yvar_name == "total_var" & t_site != "Total" ~ t_site,
                                TRUE ~ yvar_label)) %>%
  #unknown categories
  mutate(yvar_label = recode(yvar_label, "zzz_NA_explicit" = "Unknown")) %>%
  #for cancer related grouping, make gender clear
  mutate(yvar_label = case_when(yvar_label == "other cancer" & t_site == "other cancer" ~ "Other cancers - Total",
                                yvar_label == "Female" & t_site == "other cancer" ~ "Other cancers - Female",
                                yvar_label == "Male" & t_site == "other cancer" ~ "Other cancers - Male",
                                yvar_label == "smoking-related IARC" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Total",
                                yvar_label == "Female" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Female",
                                yvar_label == "Male" & t_site == "smoking-related IARC" ~ "Smoking-related cancers - Male",
                                TRUE ~ yvar_label)) %>%
  #change labels for grading
  dplyr::mutate(yvar_label = 
                  case_when(yvar_name == "t_grading.1" & yvar_label == "1" ~ "G1 well differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "2" ~ "G2 moderately differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "3" ~ "G3 poorly differentiated",
                            yvar_name == "t_grading.1" & yvar_label == "4" ~ "G4 undifferentiated",
                            yvar_name == "t_grading.1" & yvar_label == "Unknown" ~ "Unknown grading",
                            TRUE ~ yvar_label)) %>%
      #censor expected and observed < 5
  dplyr::mutate(`Total 0 to Inf years__expected` = case_when(`Total 0 to Inf years__expected` < 5 | `Total 0 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0 to Inf years__expected`),
                `Total 0 to Inf years__observed` = case_when(is.na(`Total 0 to Inf years__expected`) | `Total 0 to Inf years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `Total 0 to Inf years__observed`),
                `to 6 months__expected` = case_when(`to 6 months__expected` < 5 | `to 6 months__observed` < 5  ~ NA_real_,
                                     TRUE ~ `to 6 months__expected`),
                `to 6 months__observed` = case_when(is.na(`to 6 months__expected`) | `to 6 months__observed` < 5  ~ NA_real_,
                                     TRUE ~ `to 6 months__observed`),
                `6-12 months__expected` = case_when(`6-12 months__expected` < 5 | `6-12 months__observed` < 5  ~ NA_real_,
                                     TRUE ~ `6-12 months__expected`),
                `6-12 months__observed` = case_when(is.na(`6-12 months__expected`) | `6-12 months__observed` < 5  ~ NA_real_,
                                     TRUE ~ `6-12 months__observed`),
                `1-5 years__expected` = case_when(`1-5 years__expected` < 5 | `1-5 years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `1-5 years__expected`),
                `1-5 years__observed` = case_when(is.na(`1-5 years__expected`) | `1-5 years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `1-5 years__observed`),
                `5-10 years__expected` = case_when(`5-10 years__expected` < 5 | `5-10 years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `5-10 years__expected`),
                `5-10 years__observed` = case_when(is.na(`5-10 years__expected`) | `5-10 years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `5-10 years__observed`),
                `10+ years__expected` = case_when(`10+ years__expected` < 5 | `10+ years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `10+ years__expected`),
                `10+ years__observed` = case_when(is.na(`10+ years__expected`) | `10+ years__observed` < 5  ~ NA_real_,
                                     TRUE ~ `10+ years__observed`))
  
rm(supp_sir_sum_tab2_sites, supp_sir_sum_tab2_totals, supp_sir_sum_tab2_smokegroups)

```

#### Prepare Tab S2: filter

```{r, warning = TRUE}

#additional filtering to remove number of rows
supp_tabX2_pt1 <- supp_tabX2 %>%
  #remove seldom sites from list
  dplyr::filter(t_site %in% c("Total", "smoking-related IARC", "other cancer", names_icdgroup_sel)) %>%
  #remove Surgery information 
  dplyr::filter(yvar_name != "PTO.1") %>%
  #remove Grading information 
  dplyr::filter(yvar_name != "t_grading.1") %>%
  #keep only first part
  dplyr::slice_head(n = 25)

supp_tabX2_pt2 <- supp_tabX2 %>%
  #remove seldom sites from list
  dplyr::filter(t_site %in% c("Total", "smoking-related IARC", "other cancer", names_icdgroup_sel)) %>%
  #remove Surgery information 
  dplyr::filter(yvar_name != "PTO.1") %>%
  #remove Grading information 
  dplyr::filter(yvar_name != "t_grading.1") %>%
  #keep only first part
  dplyr::slice_tail(n = 27)

```


#### Tab S2 Part 1

```{r, warning = TRUE}
##create table with gt
supp_tabX2_pt1_gt <- supp_tabX2_pt1 %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "t_site", "yvar_sort", "yvar_sort_levels",
                     "Total 0 to Inf years__ref_inc_cases",
                     "Total 0 to Inf years__ref_inc_crude_rate",
                     "Total 0 to Inf years__ref_population_pyar",
                     "to 6 months__ref_inc_cases",
                     "to 6 months__ref_inc_crude_rate",
                     "to 6 months__ref_population_pyar",
                     "6-12 months__ref_inc_cases",
                     "6-12 months__ref_inc_crude_rate",
                     "6-12 months__ref_population_pyar",
                     "1-5 years__ref_inc_cases",
                     "1-5 years__ref_inc_crude_rate",
                     "1-5 years__ref_population_pyar",
                     "5-10 years__ref_inc_cases",
                     "5-10 years__ref_inc_crude_rate",
                     "5-10 years__ref_population_pyar",
                     "10+ years__ref_inc_cases",
                     "10+ years__ref_inc_crude_rate",
                     "10+ years__ref_population_pyar",
                     "t_smoke_barclay", "t_smoke_boakye", "t_smokeiarc"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: SIRs stratified by relevant factors and by follow-up time including lung cancer patients with less than 6 months follow-up (Page 1/2)",
    subtitle = "") %>%
  #rename columns
    gt::cols_label(
      "Total 0 to Inf years__observed" = "O",
      "Total 0 to Inf years__expected" = "E",
      "Total 0 to Inf years__sir" = "SIR",
      "Total 0 to Inf years__sir_lci" = "95% CI",
      "Total 0 to Inf years__pyar" = "PYAR",
      "Total 0 to Inf years__n_base" = "N",
      "to 6 months__observed" = "O",
      "to 6 months__expected" = "E",
      "to 6 months__sir" = "SIR",
      "to 6 months__sir_lci" = "95% CI",
      "to 6 months__pyar" = "PYAR",
      "to 6 months__n_base" = "N",
      "6-12 months__observed" = "O",
      "6-12 months__expected" = "E",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "6-12 months__pyar" = "PYAR",
      "6-12 months__n_base" = "N",
      "1-5 years__observed" = "O",
      "1-5 years__expected" = "E",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "1-5 years__pyar" = "PYAR",
      "1-5 years__n_base" = "N",
      "5-10 years__observed" = "O",
      "5-10 years__expected" = "E",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "5-10 years__pyar" = "PYAR",
      "5-10 years__n_base" = "N",
      "10+ years__observed" = "O",
      "10+ years__expected" = "E",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "10+ years__pyar" = "PYAR",
      "10+ years__n_base" = "N",
      "yvar_label" = ""
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total 0 months to 10+ years",
    columns = all_of(c(
     "Total 0 to Inf years__observed",
     "Total 0 to Inf years__expected",
     "Total 0 to Inf years__sir",
     "Total 0 to Inf years__sir_lci",
     "Total 0 to Inf years__pyar",
     "Total 0 to Inf years__n_base"))
  ) %>%
  tab_spanner(
    label = "0-6 months",
    columns = all_of(c(
     "to 6 months__observed",
     "to 6 months__expected",
     "to 6 months__sir",
     "to 6 months__sir_lci",
     "to 6 months__pyar",
     "to 6 months__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
     "6-12 months__observed",
     "6-12 months__expected",
     "6-12 months__sir",
     "6-12 months__sir_lci",
     "6-12 months__pyar",
     "6-12 months__n_base"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
     "1-5 years__observed",
     "1-5 years__expected",
     "1-5 years__sir",
     "1-5 years__sir_lci",
     "1-5 years__pyar",
     "1-5 years__n_base"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
     "5-10 years__observed",
     "5-10 years__expected",
     "5-10 years__sir",
     "5-10 years__sir_lci",
     "5-10 years__pyar",
     "5-10 years__n_base"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
     "10+ years__observed",
     "10+ years__expected",
     "10+ years__sir",
     "10+ years__sir_lci",
     "10+ years__pyar",
     "10+ years__n_base"))
  ) %>%
  #make row groups
    gt::tab_row_group(
    label = "Regional cancer registry",
    rows = yvar_name == "p_region_recode"
    ) %>%
    gt::tab_row_group(
    label = "Year of LC diagnosis",
    rows = yvar_name == "p_yearfcgroup"
    ) %>%
    gt::tab_row_group(
    label = "Age at LC diagnosis",
    rows = yvar_name == "p_agefcgroup"
    ) %>%
    gt::tab_row_group(
    label = "Sex",
    rows = c(2:3)
    ) %>%
    gt::tab_row_group(
    label = "All sites combined",
    rows = c(1)
    ) %>%
  #column formatting
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "expected")),
    decimals = 0
  ) %>%
    gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0 to Inf years__sir_lci"),
    col_end = all_of("Total 0 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("to 6 months__sir_lci"),
    col_end = all_of("to 6 months__sir_uci")
    ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
      tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "FU follow-up; ", "LC primary lung cancer; ", "NSCLC non-small-cell lung carcinoma; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons")
  ) %>%   
  #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_row_groups(groups = c("All sites combined")),
      cells_column_labels(ends_with("sir")), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(2),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
supp_tabX2_pt1_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sir_allfu_p1.png"),
    vwidth = 2350,  expand = 10
  )


```

#### Tab S2 Part 2

```{r, warning = TRUE}
##create table with gt
supp_tabX2_pt2_gt <- supp_tabX2_pt2 %>%
    #add note to Lung cancer SIR
  dplyr::mutate(yvar_label = dplyr::case_when(
    yvar_label == "Lung (C33-C34)" ~ "Lung* (C33-C34)",
    TRUE ~ as.character(yvar_label))) %>%
  #Start making gt table
  gt::gt()  %>%
  #don't show first column and value, lci, uci
  gt::cols_hide(
    columns = all_of(c("yvar_name", "t_site", "yvar_sort", "yvar_sort_levels",
                     "Total 0 to Inf years__ref_inc_cases",
                     "Total 0 to Inf years__ref_inc_crude_rate",
                     "Total 0 to Inf years__ref_population_pyar",
                     "to 6 months__ref_inc_cases",
                     "to 6 months__ref_inc_crude_rate",
                     "to 6 months__ref_population_pyar",
                     "6-12 months__ref_inc_cases",
                     "6-12 months__ref_inc_crude_rate",
                     "6-12 months__ref_population_pyar",
                     "1-5 years__ref_inc_cases",
                     "1-5 years__ref_inc_crude_rate",
                     "1-5 years__ref_population_pyar",
                     "5-10 years__ref_inc_cases",
                     "5-10 years__ref_inc_crude_rate",
                     "5-10 years__ref_population_pyar",
                     "10+ years__ref_inc_cases",
                     "10+ years__ref_inc_crude_rate",
                     "10+ years__ref_population_pyar",
                     "t_smoke_barclay", "t_smoke_boakye", "t_smokeiarc"))
  ) %>%
  #make header
  gt::tab_header(
    title = "Table: SIRs stratified by relevant factors and by follow-up time including lung cancer patients with less than 6 months follow-up (Page 2/2)",
    subtitle = "") %>%
  #rename columns
    gt::cols_label(
      "Total 0 to Inf years__observed" = "O",
      "Total 0 to Inf years__expected" = "E",
      "Total 0 to Inf years__sir" = "SIR",
      "Total 0 to Inf years__sir_lci" = "95% CI",
      "Total 0 to Inf years__pyar" = "PYAR",
      "Total 0 to Inf years__n_base" = "N",
      "to 6 months__observed" = "O",
      "to 6 months__expected" = "E",
      "to 6 months__sir" = "SIR",
      "to 6 months__sir_lci" = "95% CI",
      "to 6 months__pyar" = "PYAR",
      "to 6 months__n_base" = "N",
      "6-12 months__observed" = "O",
      "6-12 months__expected" = "E",
      "6-12 months__sir" = "SIR",
      "6-12 months__sir_lci" = "95% CI",
      "6-12 months__pyar" = "PYAR",
      "6-12 months__n_base" = "N",
      "1-5 years__observed" = "O",
      "1-5 years__expected" = "E",
      "1-5 years__sir" = "SIR",
      "1-5 years__sir_lci" = "95% CI",
      "1-5 years__pyar" = "PYAR",
      "1-5 years__n_base" = "N",
      "5-10 years__observed" = "O",
      "5-10 years__expected" = "E",
      "5-10 years__sir" = "SIR",
      "5-10 years__sir_lci" = "95% CI",
      "5-10 years__pyar" = "PYAR",
      "5-10 years__n_base" = "N",
      "10+ years__observed" = "O",
      "10+ years__expected" = "E",
      "10+ years__sir" = "SIR",
      "10+ years__sir_lci" = "95% CI",
      "10+ years__pyar" = "PYAR",
      "10+ years__n_base" = "N",
      "yvar_label" = "All sites combined"
  ) %>%
  #make col groups (spanner)
  tab_spanner(
    label = "Total 0 months to 10+ years",
    columns = all_of(c(
     "Total 0 to Inf years__observed",
     "Total 0 to Inf years__expected",
     "Total 0 to Inf years__sir",
     "Total 0 to Inf years__sir_lci",
     "Total 0 to Inf years__pyar",
     "Total 0 to Inf years__n_base"))
  ) %>%
  tab_spanner(
    label = "0-6 months",
    columns = all_of(c(
     "to 6 months__observed",
     "to 6 months__expected",
     "to 6 months__sir",
     "to 6 months__sir_lci",
     "to 6 months__pyar",
     "to 6 months__n_base"))
  ) %>%
      tab_spanner(
    label = "6-12 months",
    columns = all_of(c(
     "6-12 months__observed",
     "6-12 months__expected",
     "6-12 months__sir",
     "6-12 months__sir_lci",
     "6-12 months__pyar",
     "6-12 months__n_base"))
  ) %>%
    tab_spanner(
    label = "1-5 years",
    columns = all_of(c(
     "1-5 years__observed",
     "1-5 years__expected",
     "1-5 years__sir",
     "1-5 years__sir_lci",
     "1-5 years__pyar",
     "1-5 years__n_base"))
  ) %>%
      tab_spanner(
    label = "5-10 years",
    columns = all_of(c(
     "5-10 years__observed",
     "5-10 years__expected",
     "5-10 years__sir",
     "5-10 years__sir_lci",
     "5-10 years__pyar",
     "5-10 years__n_base"))
  ) %>%
        tab_spanner(
    label = "10+ years",
    columns = all_of(c(
     "10+ years__observed",
     "10+ years__expected",
     "10+ years__sir",
     "10+ years__sir_lci",
     "10+ years__pyar",
     "10+ years__n_base"))
  ) %>%
  #make row groups
  tab_row_group(
    label = "",
    rows = yvar_label %in% c("Smoking-related cancers - Total",
                             "Smoking-related cancers - Female",
                             "Smoking-related cancers - Male",
                             "Other cancers - Total",
                             "Other cancers - Female",
                             "Other cancers - Male")
  ) %>%
  gt::tab_row_group(
    label = "Site of SPC",
    rows = (t_site != "Total" & t_site != "other cancer" & t_site != "smoking-related IARC")
    ) %>%
    gt::tab_row_group(
    label = "Subsite of LC",
    rows = yvar_name == "t_sublung.1"
    ) %>%
  #column formatting
     gt::fmt_number(
    columns = contains(c("pyar", "observed", "expected")),
    decimals = 0
  ) %>%
    gt::fmt_missing(
    columns = contains(c("expected", "observed")),
    missing_text = "x"
  ) %>%
  cols_merge_range(
    col_begin = all_of("Total 0 to Inf years__sir_lci"),
    col_end = all_of("Total 0 to Inf years__sir_uci")
  ) %>%
      cols_merge_range(
    col_begin = all_of("to 6 months__sir_lci"),
    col_end = all_of("to 6 months__sir_uci")
    ) %>%
      cols_merge_range(
    col_begin = all_of("6-12 months__sir_lci"),
    col_end = all_of("6-12 months__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("1-5 years__sir_lci"),
    col_end = all_of("1-5 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("5-10 years__sir_lci"),
    col_end = all_of("5-10 years__sir_uci")
  ) %>%
    cols_merge_range(
    col_begin = all_of("10+ years__sir_lci"),
    col_end = all_of("10+ years__sir_uci")
  ) %>%
      tab_source_note(
    source_note = paste0("Notes: ", "E number of cases expected according to age-, sex-, region- and period-specific reference rates for the general population; ", "FU follow-up; ", "LC primary lung cancer; ", "NSCLC non-small-cell lung carcinoma; ", "O number of cases observed in the data; " ,"PYAR person-years at risk; ",   if(en_gb){"SIR standardised incidence ratio; "}else{"SIR standardized incidence ratio; "}, "SPC second primary cancer; ", "x censored counts of expected and observed smaller than 5 for data privacy reasons; ", "* SIR for lung cancer may be underestimated due to the histology-dependent registration of SPC with the same location as the first cancer (see Discussion section).")
  ) %>% 
    #special formatting
  ##make column and row group labels bold
  gt::tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_row_groups(groups = c("Site of SPC")),
      cells_column_labels(ends_with(c("yvar_label", "sir"))), 
      cells_body(columns = ends_with("sir")))
    ) %>%
  #global table options
  gt::opt_row_striping() %>% #add alternating stripes
  gt::tab_options(data_row.padding = px(2),        # reduce row height
                  stub.border.width = px(20),       # increase space between column stubs
                  row.striping.include_stub = TRUE) 

#save table
supp_tabX2_pt2_gt %>%
  gt::gtsave(
    file.path(output_dir_tables, "supp_tab_sir_allfu_p2.png"),
    vwidth = 2350, expand = 10
  )



```

## Save workspace

```{r save}
if(save_workspace){
  list_objects <- ls(all.names = TRUE)
  #define which objects not to save
  list_objects <- list_objects[!list_objects %in% c("d0_zlung_wide", "d0_zlung_wide_asir", "d1_zlung_wide", "d1nodco_zlung_wide", "d1raw_zlung_wide", "d2_zlung_wide", "d2nodco_zlung_wide", "d3_zlung_wide", "sens2_lowdcorate_d1_zlung_wide", "population", "rates_dco_imp", "rates_imp", "sir_d1_results_check", "wide_zdata_fc_lung", "zdata_fc_lung", "p", "ear_strata", "save_workspace", "supp_map_ger_sf1", "supp_map_ger_sf2", "output_dir_tables", "output_workspace", "load_packages", "required_packages", "reload_workspace", "analysis_workspace", "add_required_packages", "save_workspace", "en_gb")] 
  
 save(list = list_objects, file=output_workspace, envir = .GlobalEnv)

 }
```

